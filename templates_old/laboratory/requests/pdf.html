{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% if blank %}Blank Test Request Form - {{ vendor.name }}{% else %}Test Request {{ test_request.request_id }} - {{ vendor.name }}{% endif %}</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
            @bottom-right {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #666;
            }
        }
        
        body {
            font-family: 'Segoe UI', 'DejaVu Sans', Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #2c3e50;
            margin: 0;
            padding: 0;
        }
        
        .header {
            border-bottom: 3px solid #722F37;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .lab-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .lab-details h2 {
            color: #722F37;
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 700;
        }
        
        .form-title {
            text-align: right;
        }
        
        .form-title h3 {
            color: #722F37;
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .card {
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, #722F37, #8B0000);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .card-body {
            padding: 15px;
            background: #fff;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11px;
        }
        
        .table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 10px;
            font-weight: 600;
            color: #722F37;
        }
        
        .table td {
            border: 1px solid #dee2e6;
            padding: 8px 10px;
            vertical-align: top;
        }
        
        .table-striped tbody tr:nth-child(odd) {
            background-color: #f8f9fa;
        }
        
        .total-row {
            background-color: #e9ecef !important;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .logo {
            max-height: 70px;
            max-width: 180px;
        }
        
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid #f8f9fa;
            font-size: 10px;
            color: #6c757d;
            text-align: center;
        }
        
        .field-placeholder {
            color: #6c757d;
            font-style: italic;
            border-bottom: 1px dashed #adb5bd;
            padding: 2px 4px;
        }
        
        .signature-area {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #dee2e6;
        }
        
        .signature-line {
            display: inline-block;
            border-bottom: 1px solid #2c3e50;
            min-width: 250px;
            margin: 0 10px;
            height: 18px;
        }
        
        .text-primary { color: #722F37; }
        .text-muted { color: #6c757d; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-bold { font-weight: 600; }
        
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .mt-3 { margin-top: 15px; }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -8px;
        }
        
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 0 8px;
        }
        
        .alert {
            padding: 10px 15px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            margin-bottom: 15px;
            color: #856404;
        }
    </style>
</head>
<body>

    <!-- HEADER / LAB INFO -->
    <div class="header">
        <div class="lab-info">
            <div class="lab-details">
                {% if vendor_profile.logo %}
                <img src="{{ vendor_profile.logo.path }}" class="logo" alt="{{ vendor.name }} Logo">
                {% else %}
                <div style="height: 70px; display: flex; align-items: center; color: #722F37; font-weight: 700; font-size: 16px;">
                    {{ vendor.name|default:"LABORATORY" }}
                </div>
                {% endif %}
                <h2>{{ vendor.name|default:"LABORATORY NAME"|upper }}</h2>
                <div class="text-muted">
                    <div>{{ vendor_profile.office_address|default:"[Laboratory Address]" }}</div>
                    <div>{{ vendor_profile.office_city_state|default:"[City, State]" }}{% if vendor_profile.office_country %}, {{ vendor_profile.office_country }}{% endif %}</div>
                    <div><strong>Contact:</strong> {{ vendor_profile.contact_phone|default:"[Phone Number]" }}</div>
                    <div class="mt-2"><strong>Form Ref:</strong> LIMS-F01 | <strong>Version:</strong> 2.0</div>
                </div>
            </div>
            <div class="form-title">
                <h3>LABORATORY TEST REQUEST FORM</h3>
                <div class="text-muted">
                    <div><strong>Date:</strong> {% if not blank %}{{ test_request.created_at|date:"F d, Y" }}{% else %}<span class="field-placeholder">[Date]</span>{% endif %}</div>
                    <div><strong>Request ID:</strong> {% if not blank %}{{ test_request.request_id }}{% else %}<span class="field-placeholder">[Auto-generated]</span>{% endif %}</div>
                    {% if not blank %}
                    <div><strong>Status:</strong> <span class="badge">{{ test_request.get_status_display }}</span></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- PATIENT INFORMATION -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-person-circle" style="margin-right: 8px;"></i>PATIENT INFORMATION
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table" style="background: transparent; border: none;">
                        <tr>
                            <td width="40%" class="text-bold">Patient Name:</td>
                            <td width="60%">{% if not blank %}{{ test_request.patient.first_name }} {{ test_request.patient.last_name }}{% else %}<span class="field-placeholder">[Full Name]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Patient ID:</td>
                            <td>{% if not blank %}{{ test_request.patient.patient_id }}{% else %}<span class="field-placeholder">[Patient ID]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Date of Birth:</td>
                            <td>{% if not blank %}{{ test_request.patient.date_of_birth|date:"M d, Y"|default:"—" }}{% else %}<span class="field-placeholder">[MM/DD/YYYY]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Gender:</td>
                            <td>{% if not blank %}{{ test_request.patient.get_gender_display }}{% else %}<span class="field-placeholder">[Gender]</span>{% endif %}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table" style="background: transparent; border: none;">
                        <tr>
                            <td width="40%" class="text-bold">Contact Phone:</td>
                            <td width="60%">{% if not blank %}{{ test_request.patient.contact_phone|default:"—" }}{% else %}<span class="field-placeholder">[Phone Number]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Email:</td>
                            <td>{% if not blank %}{{ test_request.patient.contact_email|default:"—" }}{% else %}<span class="field-placeholder">[Email Address]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Requested By:</td>
                            <td>{% if not blank %}{{ test_request.requested_by.get_full_name|default:test_request.requested_by.email }}{% else %}<span class="field-placeholder">[Requester Name]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Priority:</td>
                            <td>{% if not blank %}<span class="badge">{{ test_request.get_priority_display }}</span>{% else %}<span class="field-placeholder">[Priority]</span>{% endif %}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TESTS ORDERED -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-list-check" style="margin-right: 8px;"></i>TESTS ORDERED
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th width="12%">Test Code</th>
                        <th width="38%">Test Name</th>
                        <th width="20%">Department</th>
                        <th width="15%">Type</th>
                        <th width="15%" class="text-right">Price (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    {% if not blank %}
                        {% for test in requested_tests %}
                        <tr>
                            <td>{{ test.code|default:"—" }}</td>
                            <td class="text-bold">{{ test.test.name|default:test.name }}</td>
                            <td>{{ test.assigned_department.name|default:"—" }}</td>
                            <td>{{ test.get_result_type_display|default:"—" }}</td>
                            <td class="text-right">{{ test.price|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- Sample rows for blank form -->
                        {% for i in "123" %}
                        <tr>
                            <td class="field-placeholder">CODE{{ forloop.counter }}</td>
                            <td class="field-placeholder">[Test Name {{ forloop.counter }}]</td>
                            <td class="field-placeholder">[Department]</td>
                            <td class="field-placeholder">[Type]</td>
                            <td class="text-right field-placeholder">0.00</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                    <tr class="total-row">
                        <td colspan="4" class="text-right text-bold">TOTAL AMOUNT:</td>
                        <td class="text-right text-bold">
                            {% if not blank %}₦{{ total_cost|floatformat:2 }}
                            {% else %}₦<span class="field-placeholder">[Total]</span>{% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- BILLING INFORMATION -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-credit-card" style="margin-right: 8px;"></i>BILLING INFORMATION
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table" style="background: transparent; border: none;">
                        <tr>
                            <td width="50%" class="text-bold">Payment Mode:</td>
                            <td width="50%">{% if not blank %}{{ payment_mode }}{% else %}<span class="field-placeholder">[Payment Method]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Amount Paid:</td>
                            <td>{% if not blank %}₦{{ total_cost|floatformat:2 }}{% else %}₦<span class="field-placeholder">[Amount]</span>{% endif %}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Outstanding Balance:</td>
                            <td>₦0.00</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- SAMPLE INFORMATION -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-droplet" style="margin-right: 8px;"></i>SAMPLE / SPECIMEN DETAILS
        </div>
        <div class="card-body">
            {% if not blank and samples %}
                {% for sample in samples %}
                <div style="border: 1px solid #e9ecef; padding: 12px; margin-bottom: 12px; border-radius: 6px; background: #f8f9fa;">
                    <table class="table" style="background: transparent; border: none; margin: 0;">
                        <tr>
                            <td width="20%" class="text-bold">Sample ID:</td>
                            <td width="30%">{{ sample.sample_id }}</td>
                            <td width="20%" class="text-bold">Specimen Type:</td>
                            <td width="30%"><span class="badge">{{ sample.specimen_type }}</span></td>
                        </tr>
                        <tr>
                            <td class="text-bold">Collected By:</td>
                            <td>{{ sample.collected_by|default:"—" }}</td>
                            <td class="text-bold">Collection Date:</td>
                            <td>{{ sample.collected_at|date:"M d, Y H:i" }}</td>
                        </tr>
                        <tr>
                            <td class="text-bold">Status:</td>
                            <td colspan="3"><span class="badge">{{ sample.get_status_display }}</span></td>
                        </tr>
                    </table>
                </div>
                {% endfor %}
            {% else %}
                <div style="border: 1px solid #e9ecef; padding: 12px; margin-bottom: 12px; border-radius: 6px; background: #f8f9fa;">
                    <table class="table" style="background: transparent; border: none; margin: 0;">
                        <tr>
                            <td width="20%" class="text-bold">Sample ID:</td>
                            <td width="30%"><span class="field-placeholder">[Sample ID]</span></td>
                            <td width="20%" class="text-bold">Specimen Type:</td>
                            <td width="30%"><span class="field-placeholder">[Type]</span></td>
                        </tr>
                        <tr>
                            <td class="text-bold">Collected By:</td>
                            <td><span class="field-placeholder">[Collector]</span></td>
                            <td class="text-bold">Collection Date:</td>
                            <td><span class="field-placeholder">[Date & Time]</span></td>
                        </tr>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- CLINICAL HISTORY -->
    {% if not blank and test_request.clinical_history %}
    <div class="card">
        <div class="card-header">
            <i class="bi bi-file-text" style="margin-right: 8px;"></i>CLINICAL HISTORY
        </div>
        <div class="card-body">
            <div style="border-left: 3px solid #722F37; padding-left: 15px; background: #f8f9fa; padding: 12px; border-radius: 4px;">
                {{ test_request.clinical_history|linebreaks }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- INFORMED CONSENT -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-pencil-square" style="margin-right: 8px;"></i>PATIENT / GUARDIAN CONSENT
        </div>
        <div class="card-body">
            <p style="margin-bottom: 20px;">
                I, <span class="signature-line"></span>, hereby give my informed consent for the laboratory tests listed above to be conducted. 
                I understand the purpose of these tests and authorize the release of results to my healthcare provider.
            </p>
            
            <div class="signature-area">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center">
                            <div class="text-bold mb-2">Signature</div>
                            <div class="signature-line" style="min-width: 200px;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <div class="text-bold mb-2">Date</div>
                            <div class="signature-line" style="min-width: 150px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <div class="text-muted">
            <strong>© {% now "Y" %} {{ vendor.name|default:"Laboratory" }} — Powered by FirstJP LIMS</strong>
            <div style="margin-top: 5px; font-size: 9px;">
                This document is computer-generated and valid without signature | Confidentiality Notice: This document contains privileged information
            </div>
        </div>
    </div>

</body>
</html>