{% extends 'base.html' %}
{% load static %}

{% block title %}Enter Manual Result - {{ vendor.name }}{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        border: 2px solid #0d6efd;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .reference-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .test-info-box {
        background: #f8f9fa;
        border-left: 4px solid #0dcaf0;
        padding: 1rem;
    }
    .result-input {
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        border: 2px solid #0d6efd;
    }
    .unit-input {
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-pencil-square"></i> Enter Manual Result
            </h2>
            <p class="text-muted mb-0">{{ assignment.lab_test.code }} - {{ assignment.lab_test.name }}</p>
        </div>
        <div>
            <a href="{% url 'labs:test_assignment_detail' assignment.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Cancel
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- Test Information -->
            <div class="test-info-box mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Patient:</strong> {{ assignment.request.patient.first_name }} {{ assignment.request.patient.last_name }}</p>
                        <p class="mb-1"><strong>Patient ID:</strong> {{ assignment.request.patient.patient_id }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Request ID:</strong> {{ assignment.request.request_id }}</p>
                        <p class="mb-1"><strong>Sample ID:</strong> {{ assignment.sample.sample_id }}</p>
                    </div>
                </div>
            </div>

            <!-- Reference Range Display -->
            <div class="reference-box text-center">
                <h5 class="mb-2"><i class="bi bi-rulers"></i> Reference Range</h5>
                {% if test.min_reference_value and test.max_reference_value %}
                    <h3 class="mb-1">{{ test.min_reference_value }} - {{ test.max_reference_value }}</h3>
                    <p class="mb-0">{{ test.default_units|default:"units" }}</p>
                {% elif test.default_reference_text %}
                    <h4 class="mb-0">{{ test.default_reference_text }}</h4>
                {% else %}
                    <p class="mb-0">No reference range specified</p>
                {% endif %}
                <small class="d-block mt-2 opacity-75">
                    Test Type: {{ test.get_result_type_display }}
                </small>
            </div>

            <!-- Result Entry Form -->
            <div class="card result-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-data"></i> 
                        {% if existing_result %}Update{% else %}Enter{% endif %} Result
                    </h5>
                </div>
                <div class="card-body">
                    
                    {% if existing_result %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Existing Result:</strong> {{ existing_result.result_value }} {{ existing_result.units }}
                        (Entered on {{ existing_result.entered_at|date:"M d, Y H:i" }})
                    </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Result Value -->
                        <div class="mb-4">
                            <label for="result_value" class="form-label">
                                <strong>Result Value *</strong>
                            </label>
                            <input type="text" 
                                   name="result_value" 
                                   id="result_value" 
                                   class="form-control result-input" 
                                   placeholder="Enter result..."
                                   value="{% if existing_result %}{{ existing_result.result_value }}{% endif %}"
                                   required
                                   autofocus>
                            <small class="form-text text-muted">
                                Enter the measured value for this test
                            </small>
                        </div>

                        <!-- Unit -->
                        <div class="mb-4">
                            <label for="unit" class="form-label">
                                <strong>Unit</strong>
                            </label>
                            <input type="text" 
                                   name="unit" 
                                   id="unit" 
                                   class="form-control unit-input" 
                                   placeholder="e.g., mg/dL, mmol/L, %"
                                   value="{% if existing_result %}{{ existing_result.units }}{% elif test.default_units %}{{ test.default_units }}{% endif %}">
                            <small class="form-text text-muted">
                                Measurement unit (e.g., mg/dL, mmol/L)
                                {% if test.default_units %}
                                    - Default: <strong>{{ test.default_units }}</strong>
                                {% endif %}
                            </small>
                        </div>

                        <!-- Remarks -->
                        <div class="mb-4">
                            <label for="remarks" class="form-label">
                                <strong>Remarks / Comments</strong>
                            </label>
                            <textarea name="remarks" 
                                      id="remarks" 
                                      class="form-control" 
                                      rows="4"
                                      placeholder="Any observations, notes, or comments about this result...">{% if existing_result %}{{ existing_result.remarks }}{% endif %}</textarea>
                            <small class="form-text text-muted">
                                Optional: Add any relevant observations or technical notes
                            </small>
                        </div>

                        <!-- Quality Indicators -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="mb-3"><i class="bi bi-shield-check"></i> Quality Checks</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="qc1" required>
                                    <label class="form-check-label" for="qc1">
                                        I have verified the result is accurate
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="qc2" required>
                                    <label class="form-check-label" for="qc2">
                                        Equipment was calibrated and functioning properly
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="qc3" required>
                                    <label class="form-check-label" for="qc3">
                                        Sample quality was acceptable
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-flag Information -->
                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle"></i>
                            <strong>Note:</strong> The result will be automatically flagged as Normal, High, or Low 
                            based on the reference range after submission.
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg flex-fill">
                                <i class="bi bi-check-circle"></i> 
                                {% if existing_result %}Update{% else %}Save{% endif %} Result
                            </button>
                            <a href="{% url 'labs:test_assignment_detail' assignment.id %}" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>

                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-question-circle"></i> Need Help?</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Manual Entry Guidelines:</strong></p>
                    <ul class="mb-0">
                        <li>Enter numeric values for quantitative tests</li>
                        <li>Use standard units (mg/dL, mmol/L, etc.)</li>
                        <li>Double-check values before submission</li>
                        <li>Add remarks if result is unusual or requires explanation</li>
                        <li>Result will be auto-flagged against reference ranges</li>
                        <li>Another technician must verify the result before release</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time result validation
document.getElementById('result_value').addEventListener('input', function(e) {
    const value = e.target.value.trim();
    const refMin = parseFloat('{{ test.min_reference_value|default:"0" }}');
    const refMax = parseFloat('{{ test.max_reference_value|default:"999999" }}');
    
    if (value && !isNaN(value)) {
        const numValue = parseFloat(value);
        
        // Visual feedback
        if (numValue < refMin) {
            e.target.classList.add('border-warning');
            e.target.classList.remove('border-danger', 'border-success');
        } else if (numValue > refMax) {
            e.target.classList.add('border-danger');
            e.target.classList.remove('border-warning', 'border-success');
        } else {
            e.target.classList.add('border-success');
            e.target.classList.remove('border-warning', 'border-danger');
        }
    } else {
        e.target.classList.remove('border-warning', 'border-danger', 'border-success');
    }
});

// Confirmation before submission
document.querySelector('form').addEventListener('submit', function(e) {
    const value = document.getElementById('result_value').value;
    const unit = document.getElementById('unit').value;
    
    const confirmMsg = `Please confirm:\n\nResult: ${value} ${unit}\n\nThis result will be saved and cannot be easily modified after verification.`;
    
    if (!confirm(confirmMsg)) {
        e.preventDefault();
    }
});

// Auto-fill unit if empty when typing result
document.getElementById('result_value').addEventListener('blur', function() {
    const unitField = document.getElementById('unit');
    if (!unitField.value && '{{ test.default_units }}') {
        unitField.value = '{{ test.default_units }}';
    }
});
</script>
{% endblock %}