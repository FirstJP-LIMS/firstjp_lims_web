
{% extends 'laboratory/assets/base.html' %}
{% load static %}

{% block title %}Billing Details - {{ billing.request.request_id }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Messages -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-dismissible {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} me-3"></i>
                <div>{{ message }}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="d-flex align-items-center">
            <a href="{% url 'billing:billing_list' %}" class="btn btn-outline-secondary btn-sm me-3">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="h3 mb-1">Billing Record</h1>
                <div class="text-muted">
                    Request ID: <strong>{{ test_request.request_id }}</strong>
                    • Billing ID: <code>{{ billing.id }}</code>
                </div>
            </div>
        </div>
        
        <!-- Status Badge -->
        <div class="d-flex align-items-center">
            {% if balance_due > 0 and not is_waived %}
            <div class="me-3">
                <span class="text-muted me-1">Balance:</span>
                <span class="fw-bold text-danger">₦{{ balance_due|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            <div>
                {% if is_fully_paid %}
                <span class="badge bg-success fs-6 p-2">
                    <i class="fas fa-check-circle me-2"></i>Fully Paid
                </span>
                {% elif is_authorized %}
                <span class="badge bg-primary fs-6 p-2">
                    <i class="fas fa-unlock me-2"></i>Authorized
                </span>
                {% elif is_waived %}
                <span class="badge bg-purple fs-6 p-2" style="background-color: #6f42c1;">
                    <i class="fas fa-gift me-2"></i>Payment Waived
                </span>
                {% elif billing.payment_status == 'PARTIAL' %}
                <span class="badge bg-warning fs-6 p-2 text-dark">
                    <i class="fas fa-exclamation-triangle me-2"></i>Partially Paid
                </span>
                {% else %}
                <span class="badge bg-danger fs-6 p-2">
                    <i class="fas fa-times-circle me-2"></i>Unpaid
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content (Left Column) -->
        <div class="col-lg-8 mb-4">
            
            <!-- Patient Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Patient Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small mb-1">Patient Name</label>
                            <p class="mb-0 fw-semibold">
                                {{ test_request.patient.first_name }} {{ test_request.patient.last_name }}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small mb-1">Patient ID</label>
                            <p class="mb-0 font-monospace">
                                {{ test_request.patient.patient_id }}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small mb-1">Phone Number</label>
                            <p class="mb-0">
                                {{ test_request.patient.phone_number|default:"Not provided" }}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small mb-1">Request Date</label>
                            <p class="mb-0">
                                {{ test_request.created_at|date:"M d, Y g:i A" }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Breakdown Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Requested Tests</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">Test Name</th>
                                    <th class="border-0">Department</th>
                                    <th class="border-0 text-end">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detail in test_details %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ detail.test.name }}</div>
                                        <small class="text-muted">{{ detail.test.test_code }}</small>
                                    </td>
                                    <td class="text-muted">
                                        {{ detail.test.assigned_department.name|default:"General" }}
                                    </td>
                                    <td class="text-end fw-semibold">
                                        ₦{{ detail.price|floatformat:2 }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">
                                        No tests found
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Breakdown Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Billing Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span class="text-muted">Subtotal</span>
                                    <span class="fw-semibold">₦{{ billing.subtotal|floatformat:2 }}</span>
                                </div>
                                
                                {% if billing.discount > 0 %}
                                <div class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span class="text-muted">
                                        Discount
                                        {% if billing.price_list %}
                                        <small class="text-muted">({{ billing.price_list.name }})</small>
                                        {% endif %}
                                    </span>
                                    <span class="fw-semibold text-success">-₦{{ billing.discount|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                
                                {% if billing.waiver_amount > 0 %}
                                <div class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span class="text-muted">Waiver Amount</span>
                                    <span class="fw-semibold text-purple">-₦{{ billing.waiver_amount|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                
                                {% if billing.tax > 0 %}
                                <div class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span class="text-muted">Tax</span>
                                    <span class="fw-semibold">₦{{ billing.tax|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                
                                <div class="list-group-item d-flex justify-content-between px-0 py-3 border-top">
                                    <span class="fw-bold">Total Amount</span>
                                    <span class="h5 fw-bold mb-0">₦{{ billing.total_amount|floatformat:2 }}</span>
                                </div>
                                
                                {% if total_paid > 0 %}
                                <div class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span class="text-muted">Amount Paid</span>
                                    <span class="fw-semibold text-success">₦{{ total_paid|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                
                                {% if balance_due > 0 and not is_waived %}
                                <div class="list-group-item d-flex justify-content-between px-0 py-3 border-top">
                                    <span class="fw-bold text-danger">Balance Due</span>
                                    <span class="h5 fw-bold text-danger mb-0">₦{{ balance_due|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Timeline Card -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Payment Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for event in timeline %}
                        <div class="timeline-item {% if not forloop.last %}mb-4{% endif %}">
                            <div class="timeline-indicator">
                                {% if event.type == 'billing' %}
                                <div class="indicator bg-primary bg-opacity-10 text-primary">
                                    <i class="fas fa-file-invoice"></i>
                                </div>
                                {% elif event.type == 'payment' %}
                                <div class="indicator bg-success bg-opacity-10 text-success">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                {% elif event.type == 'authorization' %}
                                <div class="indicator bg-info bg-opacity-10 text-info">
                                    <i class="fas fa-unlock"></i>
                                </div>
                                {% elif event.type == 'waiver' %}
                                <div class="indicator bg-purple bg-opacity-10 text-purple">
                                    <i class="fas fa-gift"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ event.description }}
                                            {% if event.user %}
                                            <small class="text-muted">by {{ event.user.get_full_name }}</small>
                                            {% endif %}
                                        </h6>
                                        <p class="text-muted small mb-1">
                                            {{ event.date|date:"M d, Y g:i A" }}
                                        </p>
                                        {% if event.amount %}
                                        <p class="mb-1 fw-semibold">
                                            ₦{{ event.amount|floatformat:2 }}
                                        </p>
                                        {% endif %}
                                        {% if event.reference %}
                                        <p class="text-muted small mb-0">
                                            Ref: <code>{{ event.reference }}</code>
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-4">No activity yet</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-4">
            
            <!-- Sample Collection Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Sample Collection Status</h5>
                </div>
                <div class="card-body">
                    {% if sample %}
                    <div class="alert alert-success">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle fs-4 text-success"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Sample Collected</h6>
                                <p class="mb-2 small">ID: <code>{{ sample.sample_id }}</code></p>
                                <a href="{% url 'labs:sample_detail' pk=sample.pk %}" 
                                   class="btn btn-sm btn-success">
                                    View Sample Details
                                </a>
                            </div>
                        </div>
                    </div>
                    {% elif can_collect_sample %}
                    <div class="alert alert-info">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-vial fs-4 text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Ready for Collection</h6>
                                <p class="mb-2 small">Payment cleared for sample collection</p>
                                <a href="{% url 'labs:collect_sample' billing_pk=billing.pk %}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-syringe me-2"></i>Collect Sample
                                </a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-danger">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-lock fs-4 text-danger"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Payment Required</h6>
                                <p class="mb-0 small">Clear payment to proceed with sample collection</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Actions Card -->
            {% if not is_fully_paid and not is_waived and not sample %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Payment Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        
                        <!-- Record Payment Button -->
                        {% if balance_due > 0 and user.can_receive_payment and not is_authorized %}
                        <button type="button" onclick="showPaymentModal()" 
                                class="btn btn-success btn-lg d-flex align-items-center justify-content-center">
                            <i class="fas fa-money-bill-wave me-2"></i>
                            Record Payment
                            {% if balance_due != billing.total_amount %}
                            <span class="badge bg-light text-dark ms-2">₦{{ balance_due|floatformat:2 }}</span>
                            {% endif %}
                        </button>
                        {% endif %}

                        <!-- Authorize Button -->
                        {% if not is_authorized and user.can_authorize_billing and not is_waived %}
                        <button type="button" onclick="showAuthorizeModal()" 
                                class="btn btn-primary btn-lg d-flex align-items-center justify-content-center">
                            <i class="fas fa-unlock me-2"></i>
                            Authorize to Proceed
                        </button>
                        {% endif %}

                        <!-- Waive Button -->
                        {% if not is_waived and user.can_waive_billing %}
                        <button type="button" onclick="showWaiveModal()" 
                                class="btn btn-purple btn-lg d-flex align-items-center justify-content-center" 
                                style="background-color: #6f42c1; border-color: #6f42c1; color: white;">
                            <i class="fas fa-gift me-2"></i>
                            Waive Payment
                        </button>
                        {% endif %}

                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Billing Details Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Billing Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5 text-muted">Billing Type</dt>
                        <dd class="col-sm-7 fw-semibold">{{ billing.get_billing_type_display }}</dd>
                        
                        {% if billing.insurance_provider %}
                        <dt class="col-sm-5 text-muted">Insurance Provider</dt>
                        <dd class="col-sm-7 fw-semibold">{{ billing.insurance_provider.name }}</dd>
                        {% endif %}
                        
                        {% if billing.corporate_client %}
                        <dt class="col-sm-5 text-muted">Corporate Client</dt>
                        <dd class="col-sm-7 fw-semibold">{{ billing.corporate_client.name }}</dd>
                        {% endif %}
                        
                        {% if billing.price_list %}
                        <dt class="col-sm-5 text-muted">Price List</dt>
                        <dd class="col-sm-7 fw-semibold">{{ billing.price_list.name }}</dd>
                        {% endif %}
                        
                        <dt class="col-sm-5 text-muted">Created</dt>
                        <dd class="col-sm-7">{{ billing.created_at|date:"M d, Y g:i A" }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Export/Print Card -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Export/Print</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-print text-muted me-3"></i>
                                <span>Print Receipt</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-pdf text-muted me-3"></i>
                                <span>Download PDF</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-invoice text-muted me-3"></i>
                                <span>View Invoice</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Confirm Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'billing:confirm_payment' pk=billing.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method *</label>
                        <select name="payment_method" id="paymentMethod" class="form-select" required>
                            {% for method_value, method_label in payment_methods %}
                            <option value="{{ method_value }}">{{ method_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">₦</span>
                            <input type="number" name="amount" id="paymentAmount" step="0.01" 
                                   value="{{ balance_due }}" required
                                   class="form-control">
                        </div>
                        <div class="form-text">Balance due: ₦{{ balance_due|floatformat:2 }}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transactionRef" class="form-label">Transaction Reference</label>
                        <input type="text" name="transaction_reference" id="transactionRef"
                               placeholder="Bank ref, POS receipt #, etc."
                               class="form-control">
                    </div>
                    
                    <div class="mb-0">
                        <label for="paymentNotes" class="form-label">Notes</label>
                        <textarea name="payment_notes" id="paymentNotes" rows="2"
                                  placeholder="Additional payment notes..."
                                  class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Authorize Modal -->
<div class="modal fade" id="authorizeModal" tabindex="-1" aria-labelledby="authorizeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authorizeModalLabel">Authorize to Proceed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    This will allow sample collection to proceed. The debt of 
                    <strong>₦{{ billing.total_amount|floatformat:2 }}</strong> will remain tracked for later payment.
                </div>
                
                <form method="POST" action="{% url 'billing:authorize_billing' pk=billing.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="authorizationReason" class="form-label">Authorization Reason *</label>
                        <textarea name="reason" id="authorizationReason" rows="3" required
                                  placeholder="e.g., Emergency case, VIP monthly billing, Insurance pre-authorization..."
                                  class="form-control"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Authorize</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Waive Modal -->
<div class="modal fade" id="waiveModal" tabindex="-1" aria-labelledby="waiveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="waiveModalLabel">Waive Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-purple mb-3" style="background-color: #e9d8fd; color: #6f42c1; border-color: #d6bcf9;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This will forgive the debt. No payment will be expected.
                </div>
                
                <form method="POST" action="{% url 'billing:waive_billing' pk=billing.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="waiverType" class="form-label">Waiver Type *</label>
                        <select name="waiver_type" id="waiverType" class="form-select" onchange="togglePartialAmount()">
                            <option value="full">Full Waiver (₦{{ billing.total_amount|floatformat:2 }})</option>
                            <option value="partial">Partial Waiver</option>
                        </select>
                    </div>
                    
                    <div id="partialAmountDiv" class="mb-3" style="display: none;">
                        <label for="partialWaiverAmount" class="form-label">Waiver Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">₦</span>
                            <input type="number" name="partial_waiver_amount" id="partialWaiverAmount" 
                                   step="0.01" max="{{ billing.total_amount }}"
                                   class="form-control">
                        </div>
                        <div class="form-text">Maximum: ₦{{ billing.total_amount|floatformat:2 }}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="waiverReason" class="form-label">Waiver Reason *</label>
                        <textarea name="waiver_reason" id="waiverReason" rows="3" required
                                  placeholder="e.g., Charitable case, staff benefit, promotional waiver..."
                                  class="form-control"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-purple" style="background-color: #6f42c1; border-color: #6f42c1; color: white;">Confirm Waiver</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 60px;
    }
    
    .timeline-item {
        position: relative;
    }
    
    .timeline-indicator {
        position: absolute;
        left: -60px;
        top: 0;
    }
    
    .timeline-indicator .indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .timeline-content {
        padding-bottom: 20px;
        border-left: 2px solid #dee2e6;
        padding-left: 20px;
    }
    
    .timeline-item:last-child .timeline-content {
        border-left: none;
        padding-bottom: 0;
    }
    
    .bg-purple {
        background-color: #6f42c1 !important;
    }
    
    .text-purple {
        color: #6f42c1 !important;
    }
    
    .btn-purple {
        background-color: #6f42c1;
        border-color: #6f42c1;
        color: white;
    }
    
    .btn-purple:hover {
        background-color: #5a32a3;
        border-color: #5a32a3;
        color: white;
    }
    
    .alert-purple {
        background-color: #e9d8fd;
        border-color: #d6bcf9;
        color: #6f42c1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Show modals
    function showPaymentModal() {
        var paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        paymentModal.show();
    }
    
    function showAuthorizeModal() {
        var authorizeModal = new bootstrap.Modal(document.getElementById('authorizeModal'));
        authorizeModal.show();
    }
    
    function showWaiveModal() {
        var waiveModal = new bootstrap.Modal(document.getElementById('waiveModal'));
        waiveModal.show();
    }
    
    // Toggle partial waiver amount field
    function togglePartialAmount() {
        const waiverType = document.getElementById('waiverType').value;
        const partialAmountDiv = document.getElementById('partialAmountDiv');
        const partialWaiverAmount = document.getElementById('partialWaiverAmount');
        
        if (waiverType === 'partial') {
            partialAmountDiv.style.display = 'block';
            partialWaiverAmount.required = true;
        } else {
            partialAmountDiv.style.display = 'none';
            partialWaiverAmount.required = false;
            partialWaiverAmount.value = '';
        }
    }
    
    // Set payment amount to balance due
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-select cash as default payment method
        document.getElementById('paymentMethod').value = 'cash';
        
        // Set max amount for payment
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) {
            paymentAmount.max = {{ balance_due }};
        }
    });
</script>
{% endblock %}