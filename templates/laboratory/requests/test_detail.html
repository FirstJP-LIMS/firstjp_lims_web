{% extends "laboratory/assets/base.html" %}
{% load static %}

{% block title %}Test Request {{ test_request.request_id }} - {{ vendor.name }}{% endblock %}

{% block extra_css %}
<style>
    /* PDF-friendly styles */
    @media print {
        .no-print {
            display: none !important;
        }
        
        .container {
            max-width: 100% !important;
            padding: 0 !important;
        }
        
        .card {
            border: 1px solid #dee2e6 !important;
            box-shadow: none !important;
        }
        
        .bg-light {
            background-color: #f8f9fa !important;
            -webkit-print-color-adjust: exact;
        }
        
        .table-active {
            background-color: rgba(0,0,0,.075) !important;
            -webkit-print-color-adjust: exact;
        }
        
        .border-bottom {
            border-bottom: 1px solid #dee2e6 !important;
        }
        
        .text-primary {
            color: #0d6efd !important;
        }
        
        .text-success {
            color: #198754 !important;
        }
    }

    /* Enhanced styling */
    .lab-header {
        border-bottom: 2px solid #2c5aa0;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }

    .section-card {
        border: 1px solid #e0e0e0;
        margin-bottom: 1.5rem;
        page-break-inside: avoid;
    }

    .section-header {
        background: linear-gradient(135deg, #2c5aa0, #1e429f);
        color: white;
        padding: 0.75rem 1rem;
        font-weight: 600;
    }

    .patient-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .info-item {
        margin-bottom: 0.5rem;
    }

    .info-label {
        font-weight: 600;
        color: #555;
        min-width: 120px;
        display: inline-block;
    }

    .test-table {
        width: 100%;
        border-collapse: collapse;
    }

    .test-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        padding: 0.75rem;
        border-bottom: 2px solid #dee2e6;
    }

    .test-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }

    .total-row {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .signature-area {
        border-top: 1px dashed #ccc;
        padding-top: 2rem;
        margin-top: 2rem;
    }

    .barcode-container {
        text-align: center;
        padding: 1rem;
        border: 1px solid #e0e0e0;
        background: white;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
    }

    .watermark {
        position: relative;
    }

    .watermark::after {
        content: "{{ vendor.name }} - CONFIDENTIAL";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 4rem;
        color: rgba(0,0,0,0.1);
        z-index: -1;
        font-weight: bold;
        white-space: nowrap;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Action Buttons - Hidden in PDF -->
<div class="container-fluid py-4 no-print">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark mb-1">Test Request Details</h1>
            <p class="text-muted mb-0">Request ID: {{ test_request.request_id }}</p>
        </div>
        
        {% if test_request.barcode_image %}
        <div class="text-end">
            <div class="barcode-container rounded shadow-sm">
                <img src="{{ test_request.barcode_image.url }}" alt="Barcode" style="height:60px; width:auto;">
                <p class="small text-muted mb-0 mt-1">{{ test_request.request_id }}</p>
            </div>
        </div>
        {% endif %}
        
        <div class="d-flex gap-2">
            <a href="{% url 'labs:test_request_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
            <button onclick="printForm()" class="btn btn-primary">
                <i class="bi bi-printer me-2"></i>Print Form
            </button>
            <a href="{% url 'labs:download_test_request' test_request.pk %}" class="btn btn-success">
                <i class="bi bi-download me-2"></i>Download PDF
            </a>
            <a href="{% url 'labs:download_blank_test_request' blank=True %}" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark me-2"></i>Blank Form
            </a>
        </div>
    </div>
</div>

<!-- Printable Content -->
<div class="container my-4" id="printable-area">
    <!-- Header Section -->
    <div class="lab-header">
        <div class="row align-items-center">
            <div class="col-8">
                <div class="d-flex align-items-start">
                    {% if vendor_profile.logo %}
                    <img src="{{ vendor_profile.logo.url }}" alt="Lab Logo" style="height:80px; width:auto;" class="me-3">
                    {% else %}
                    <div class="bg-primary text-white rounded-3 p-3 me-3">
                        <i class="bi bi-droplet fs-1"></i>
                    </div>
                    {% endif %}
                    <div>
                        <h2 class="fw-bold text-primary mb-1">{{ vendor.name|upper }}</h2>
                        <p class="mb-1 text-dark">{{ vendor_profile.office_address }}</p>
                        <p class="mb-1 text-dark">{{ vendor_profile.office_city_state }}, {{ vendor_profile.office_country }}</p>
                        <p class="mb-1"><strong>Contact:</strong> {{ vendor_profile.contact_phone|default:"—" }}</p>
                        <small class="text-muted">Form Ref: LIMS-F01 | Version 2.0 | CLIA Certified</small>
                    </div>
                </div>
            </div>
            <div class="col-4 text-end">
                <div class="border-start ps-3">
                    <h3 class="text-primary fw-bold mb-2">TEST REQUEST FORM</h3>
                    <div class="d-flex flex-column gap-1">
                        <span><strong>Date:</strong> {{ test_request.created_at|date:"M d, Y" }}</span>
                        <span><strong>Request ID:</strong> {{ test_request.request_id }}</span>
                        <span><strong>Priority:</strong> 
                            <span class="badge {% if test_request.priority == 'HIGH' %}bg-danger{% elif test_request.priority == 'MEDIUM' %}bg-warning{% else %}bg-success{% endif %}">
                                {{ test_request.get_priority_display }}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Information -->
    <div class="section-card rounded-3">
        <div class="section-header rounded-top-3">
            <i class="bi bi-person-vcard me-2"></i>PATIENT INFORMATION
        </div>
        <div class="p-4">
            <div class="patient-info-grid">
                <div class="info-item">
                    <span class="info-label">Full Name:</span>
                    <strong>{{ test_request.patient.first_name }} {{ test_request.patient.last_name }}</strong>
                </div>
                <div class="info-item">
                    <span class="info-label">Patient ID:</span>
                    {{ test_request.patient.patient_id }}
                </div>
                <div class="info-item">
                    <span class="info-label">Date of Birth:</span>
                    {{ test_request.patient.date_of_birth|date:"M d, Y" }}
                </div>
                <div class="info-item">
                    <span class="info-label">Gender:</span>
                    {{ test_request.patient.get_gender_display }}
                </div>
                <div class="info-item">
                    <span class="info-label">Contact Phone:</span>
                    {{ test_request.patient.contact_phone|default:"—" }}
                </div>
                <div class="info-item">
                    <span class="info-label">Email:</span>
                    {{ test_request.patient.contact_email|default:"—" }}
                </div>
                <div class="info-item">
                    <span class="info-label">Requested By:</span>
                    {{ test_request.requested_by.get_full_name|default:test_request.requested_by.email }}
                </div>
                <div class="info-item">
                    <span class="info-label">Request Date:</span>
                    {{ test_request.created_at|date:"M d, Y H:i" }}
                </div>
            </div>
        </div>
    </div>

    <!-- Tests Ordered -->
    <div class="section-card rounded-3">
        <div class="section-header rounded-top-3">
            <i class="bi bi-clipboard2-check me-2"></i>TESTS ORDERED
        </div>
        <div class="p-0">
            <table class="test-table">
                <thead>
                    <tr>
                        <th style="width: 15%">Test Code</th>
                        <th style="width: 35%">Test Name</th>
                        <th style="width: 20%">Department</th>
                        <th style="width: 15%">Result Type</th>
                        <th style="width: 15%" class="text-end">Price (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test in requested_tests %}
                    <tr>
                        <td><strong>{{ test.code }}</strong></td>
                        <td>{{ test.name }}</td>
                        <td>{{ test.assigned_department.name }}</td>
                        <td>{{ test.get_result_type_display }}</td>
                        <td class="text-end">₦{{ test.price|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td colspan="4" class="text-end"><strong>Total Amount:</strong></td>
                        <td class="text-end"><strong>₦{{ total_cost|floatformat:2 }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Billing Information -->
    <div class="section-card rounded-3">
        <div class="section-header rounded-top-3">
            <i class="bi bi-credit-card me-2"></i>BILLING INFORMATION
        </div>
        <div class="p-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Payment Mode:</span>
                        {{ payment_mode }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Amount Paid:</span>
                        <strong class="text-success">₦{{ total_cost|floatformat:2 }}</strong>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Balance Due:</span>
                        <strong class="text-danger">₦0.00</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Information -->
    <div class="section-card rounded-3">
        <div class="section-header rounded-top-3">
            <i class="bi bi-droplet me-2"></i>SAMPLE / SPECIMEN DETAILS
        </div>
        <div class="p-4">
            {% for sample in samples %}
            <div class="border rounded-3 p-3 mb-3 bg-light">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Sample ID:</strong><br>
                        <span class="text-primary">{{ sample.sample_id }}</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Specimen Type:</strong><br>
                        {{ sample.specimen_type }}
                    </div>
                    <div class="col-md-3">
                        <strong>Collected By:</strong><br>
                        {{ sample.collected_by|default:"—" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Collection Date:</strong><br>
                        {{ sample.collected_at|date:"M d, Y H:i" }}
                    </div>
                </div>
                <div class="mt-2">
                    <strong>Status:</strong>
                    <span class="status-badge {% if sample.status == 'COLLECTED' %}bg-success{% elif sample.status == 'PENDING' %}bg-warning{% else %}bg-secondary{% endif %} text-white">
                        {{ sample.get_status_display }}
                    </span>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-3 text-muted">
                <i class="bi bi-droplet fs-1 opacity-50"></i>
                <p class="mb-0">No samples recorded yet</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Consent Section -->
    <div class="section-card rounded-3 watermark">
        <div class="section-header rounded-top-3">
            <i class="bi bi-clipboard-check me-2"></i>PATIENT / GUARDIAN CONSENT
        </div>
        <div class="p-4">
            <p class="mb-4">
                I, <span class="text-decoration-underline" style="min-width: 300px; display: inline-block;">&nbsp;</span>, 
                hereby give my informed consent for the laboratory tests listed above to be conducted. 
                I understand the purpose of these tests and authorize the release of results to my healthcare provider.
            </p>

            <div class="signature-area">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Signature of Patient/Guardian</strong></p>
                        <div style="border-bottom: 1px solid #000; padding-top: 30px; margin-bottom: 10px;"></div>
                        <small class="text-muted">Sign above</small>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Date</strong></p>
                        <div style="border-bottom: 1px solid #000; padding-top: 30px; margin-bottom: 10px;"></div>
                        <small class="text-muted">MM/DD/YYYY</small>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-3 bg-light rounded-3">
                <small class="text-muted">
                    <strong>Note:</strong> This document contains confidential health information. 
                    Unauthorized disclosure is prohibited by law. Results are typically available 
                    within 24-48 hours unless otherwise specified.
                </small>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-4 pt-3 border-top">
        <small class="text-muted">
            © {% now "Y" %} {{ vendor.name }} Laboratory — Powered by FirstJP LIMS | 
            Printed on: {% now "M d, Y H:i" %}
        </small>
    </div>
</div>

<script>
function printForm() {
    const originalContent = document.body.innerHTML;
    const printableArea = document.getElementById('printable-area').innerHTML;
    
    document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Test Request - {{ test_request.request_id }}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
            <style>
                body { 
                    font-family: 'Segoe UI', system-ui, sans-serif; 
                    background: white !important;
                    color: black !important;
                    padding: 20px;
                }
                .section-header {
                    background: #2c5aa0 !important;
                    color: white !important;
                    -webkit-print-color-adjust: exact;
                }
                .bg-light {
                    background-color: #f8f9fa !important;
                    -webkit-print-color-adjust: exact;
                }
                .table-active {
                    background-color: rgba(0,0,0,.075) !important;
                    -webkit-print-color-adjust: exact;
                }
                .watermark::after {
                    opacity: 0.1;
                }
                @page {
                    size: A4;
                    margin: 1cm;
                }
            </style>
        </head>
        <body>
            ${printableArea}
        </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    window.location.reload();
}

// Add page break for PDF
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.section-card');
    cards.forEach((card, index) => {
        if (index > 0 && index % 2 === 0) {
            card.style.pageBreakBefore = 'always';
        }
    });
});
</script>
{% endblock %}