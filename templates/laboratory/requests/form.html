{% extends "laboratory/assets/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}New Test Request - FirstJP LIMS{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title fw-bold text-dark mb-1">New Test Request</h1>
            <p class="page-subtitle text-muted mb-0">Order laboratory tests and collect specimen information</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'labs:test_request_list' %}" class="btn btn-danger btn-lg shadow-sm">
                <i class="bi bi-arrow-left me-2"></i>Back to Requests
            </a>
        </div>
    </div>
</div>

<div class="dashboard-content">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-0" role="alert">
                <i class="bi bi-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %}-fill me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" novalidate id="testRequestForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-8">
                <!-- Patient Information Card -->
                <div class="main-card card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title mb-0 fw-semibold">
                            <i class="bi bi-person-plus me-2 text-primary"></i>
                            Patient Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Patient Selection Section -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person-check me-2"></i>
                                Select Existing Patient
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="patientSearch" class="form-label fw-semibold">Search Patient</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="patientSearch" 
                                               placeholder="Search by name, patient ID, or phone number...">
                                        <button class="btn btn-outline-secondary" type="button" id="clearPatientSearch">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Searchable Patient Select -->
                                    <select class="form-select" id="id_existing_patient" name="existing_patient" size="5" 
                                            style="min-height: 150px;">
                                        <option value="">-- Select a patient --</option>
                                        {% for patient in form.existing_patient.field.queryset %}
                                        <option value="{{ patient.id }}" 
                                                data-search="{{ patient.first_name|lower }} {{ patient.last_name|lower }} {{ patient.patient_id|lower }} {{ patient.contact_phone|default:'' }}">
                                            {{ patient.patient_id }} - {{ patient.first_name }} {{ patient.last_name }}
                                            {% if patient.date_of_birth %} (DOB: {{ patient.date_of_birth|date:"Y-m-d" }}){% endif %}
                                            {% if patient.contact_phone %} - {{ patient.contact_phone }}{% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Click on a patient to select</small>
                                </div>
                            </div>

                            <div class="text-center mb-3">
                                <span class="badge bg-secondary">OR</span>
                            </div>

                            <div class="alert alert-info border-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>New Patient?</strong> Enter patient details below
                            </div>
                        </div>

                        <!-- New Patient Details -->
                        <div id="newPatientSection">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person-plus me-2"></i>
                                New Patient Details
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.first_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.last_name|as_crispy_field }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ form.date_of_birth|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ form.gender|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ form.contact_phone|as_crispy_field }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    {{ form.contact_email|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Selection Card -->
                <div class="main-card card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title mb-0 fw-semibold">
                            <i class="bi bi-clipboard-check me-2 text-primary"></i>
                            Test Selection
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning border-0" id="testSelectionAlert" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Please select at least one test to proceed.
                        </div>

                        <!-- Test Search -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Search Tests</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-light">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="testSearch" 
                                       placeholder="Search by test name, code, or department...">
                                <button class="btn btn-outline-secondary" type="button" id="clearTestSearch">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                            </div>
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllVisible">
                                    <i class="bi bi-check-all me-1"></i>Select All Visible
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">
                                    <i class="bi bi-x-square me-1"></i>Deselect All
                                </button>
                            </div>
                        </div>

                        <!-- Tests Grid -->
                        <div class="tests-container" style="max-height: 500px; overflow-y: auto;">
                            <div id="testsGrid" class="row g-2">
                                {% for test in form.tests_to_order.field.queryset %}
                                <div class="col-md-6 test-item" 
                                     data-test-id="{{ test.id }}"
                                     data-test-name="{{ test.name|lower }}"
                                     data-test-code="{{ test.code|lower }}"
                                     data-test-department="{{ test.assigned_department.name|lower }}"
                                     data-price="{{ test.price }}">
                                    <div class="card h-100 test-card">
                                        <div class="card-body p-3">
                                            <div class="form-check">
                                                <input class="form-check-input test-checkbox" 
                                                       type="checkbox" 
                                                       name="tests_to_order" 
                                                       value="{{ test.id }}" 
                                                       id="test_{{ test.id }}">
                                                <label class="form-check-label w-100" for="test_{{ test.id }}">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <div class="fw-bold text-primary">{{ test.code }}</div>
                                                            <div class="small text-dark">{{ test.name }}</div>
                                                            <div class="small text-muted mt-1">
                                                                <i class="bi bi-building me-1"></i>{{ test.assigned_department.name }}
                                                            </div>
                                                            <div class="small">
                                                                <span class="badge bg-{% if test.result_type == 'QNT' %}info{% else %}warning{% endif %} bg-opacity-15 text-{% if test.result_type == 'QNT' %}info{% else %}warning{% endif %}">
                                                                    {{ test.get_result_type_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="text-end ms-2">
                                                            <strong class="text-success">₦{{ test.price }}</strong>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No tests available. Please add tests to your catalog first.
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div id="noTestsFound" class="alert alert-warning mt-3" style="display: none;">
                                <i class="bi bi-search me-2"></i>
                                No tests found matching your search. Try different keywords.
                            </div>
                        </div>

                        <!-- Selected Tests Summary -->
                        <div class="card bg-light border-0 mt-3" id="selectedTestsSummary" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title fw-semibold">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Selected Tests (<span id="selectedCount">0</span>)
                                </h6>
                                <div id="selectedTestsList" class="small"></div>
                                <div class="mt-3 pt-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="text-dark">Total Price:</strong>
                                        <strong class="text-success fs-5">₦<span id="totalPrice">0.00</span></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sample Information Card -->
                <div class="main-card card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title mb-0 fw-semibold">
                            <i class="bi bi-droplet me-2 text-primary"></i>
                            Specimen Collection
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ sample_form.specimen_type|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ sample_form.container_type|as_crispy_field }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ sample_form.specimen_description|as_crispy_field }}
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ sample_form.collection_method|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ sample_form.collection_site|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ sample_form.volume_collected_ml|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ sample_form.collected_by|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ sample_form.location|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Additional Information Card -->
                <div class="main-card card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title mb-0 fw-semibold">
                            <i class="bi bi-file-text me-2 text-primary"></i>
                            Request Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.priority|as_crispy_field }}
                        </div>

                        <div class="mb-3">
                            {{ form.clinical_indication|as_crispy_field }}
                        </div>

                        <div class="mb-3">
                            {{ form.urgency_reason|as_crispy_field }}
                        </div>

                        <div class="mb-3">
                            {{ form.external_referral|as_crispy_field }}
                        </div>

                        <div class="mb-3">
                            {{ form.clinical_history|as_crispy_field }}
                        </div>

                        <div class="form-check">
                            {{ form.has_informed_consent }}
                            <label class="form-check-label" for="{{ form.has_informed_consent.id_for_label }}">
                                Patient has provided informed consent
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="main-card card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title mb-0 fw-semibold">
                            <i class="bi bi-info-circle me-2 text-primary"></i>
                            Guidelines
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary">Patient Selection</h6>
                        <ul class="list-unstyled small mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Search and select existing patient</li>
                            <li><i class="bi bi-check text-success me-2"></i>Or enter new patient details</li>
                        </ul>

                        <h6 class="text-primary">Test Selection</h6>
                        <ul class="list-unstyled small mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Use search to quickly find tests</li>
                            <li><i class="bi bi-check text-success me-2"></i>Select multiple tests as needed</li>
                            <li><i class="bi bi-check text-success me-2"></i>Review total price before submitting</li>
                        </ul>

                        <h6 class="text-primary">Specimen Types</h6>
                        <ul class="list-unstyled small">
                            <li><i class="bi bi-droplet text-primary me-2"></i>Blood, Urine, Tissue, Saliva</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="main-card card border-0 shadow-sm mt-4">
            <div class="card-body text-center py-4">
                <div class="d-flex gap-3 justify-content-center">
                    <a href="{% url 'labs:test_request_list' %}" class="btn btn-outline-secondary btn-lg px-5">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-send-check me-2"></i>Submit Test Request
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Patient search functionality
    const patientSearch = document.getElementById('patientSearch');
    const clearPatientSearch = document.getElementById('clearPatientSearch');
    const existingPatientSelect = document.getElementById('id_existing_patient');
    const newPatientSection = document.getElementById('newPatientSection');
    
    // Test search functionality
    const testSearch = document.getElementById('testSearch');
    const clearTestSearch = document.getElementById('clearTestSearch');
    const testCheckboxes = document.querySelectorAll('.test-checkbox');
    const testItems = document.querySelectorAll('.test-item');
    const selectAllVisible = document.getElementById('selectAllVisible');
    const deselectAll = document.getElementById('deselectAll');
    const noTestsFound = document.getElementById('noTestsFound');
    
    // Summary elements
    const selectedTestsSummary = document.getElementById('selectedTestsSummary');
    const selectedTestsList = document.getElementById('selectedTestsList');
    const selectedCount = document.getElementById('selectedCount');
    const totalPriceElement = document.getElementById('totalPrice');
    const testSelectionAlert = document.getElementById('testSelectionAlert');

    // ======================
    // PATIENT SEARCH
    // ======================
    function filterPatients() {
        const searchTerm = patientSearch.value.toLowerCase().trim();
        const options = existingPatientSelect.querySelectorAll('option');
        let hasVisibleOptions = false;
        
        options.forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
                return;
            }
            
            const searchData = option.dataset.search || '';
            if (searchData.includes(searchTerm)) {
                option.style.display = 'block';
                hasVisibleOptions = true;
            } else {
                option.style.display = 'none';
            }
        });
    }

    function toggleNewPatientSection() {
        if (existingPatientSelect && existingPatientSelect.value) {
            newPatientSection.style.display = 'none';
            // Clear new patient fields
            document.getElementById('id_first_name').value = '';
            document.getElementById('id_last_name').value = '';
        } else {
            newPatientSection.style.display = 'block';
        }
    }

    patientSearch.addEventListener('input', filterPatients);
    clearPatientSearch.addEventListener('click', function() {
        patientSearch.value = '';
        filterPatients();
    });
    existingPatientSelect.addEventListener('change', toggleNewPatientSection);

    // ======================
    // TEST SEARCH
    // ======================
    function filterTests() {
        const searchTerm = testSearch.value.toLowerCase().trim();
        let visibleCount = 0;
        
        testItems.forEach(item => {
            const testName = item.dataset.testName || '';
            const testCode = item.dataset.testCode || '';
            const testDept = item.dataset.testDepartment || '';
            const searchText = `${testName} ${testCode} ${testDept}`;
            
            if (!searchTerm || searchText.includes(searchTerm)) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show/hide "no tests found" message
        if (visibleCount === 0 && searchTerm) {
            noTestsFound.style.display = 'block';
        } else {
            noTestsFound.style.display = 'none';
        }
    }

    testSearch.addEventListener('input', filterTests);
    
    clearTestSearch.addEventListener('click', function() {
        testSearch.value = '';
        filterTests();
    });

    // Select/Deselect buttons
    selectAllVisible.addEventListener('click', function() {
        testItems.forEach(item => {
            if (item.style.display !== 'none') {
                const checkbox = item.querySelector('.test-checkbox');
                if (checkbox) checkbox.checked = true;
            }
        });
        updateSelectedTestsSummary();
    });

    deselectAll.addEventListener('click', function() {
        testCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedTestsSummary();
    });

    // ======================
    // SELECTED TESTS SUMMARY
    // ======================
    function updateSelectedTestsSummary() {
        const selectedTests = [];
        let totalPrice = 0;
        
        testItems.forEach(item => {
            const checkbox = item.querySelector('.test-checkbox');
            if (checkbox && checkbox.checked) {
                const testName = item.querySelector('label .text-dark').textContent;
                const testCode = item.querySelector('label .text-primary').textContent;
                const price = parseFloat(item.dataset.price || 0);
                const testId = item.dataset.testId;
                
                selectedTests.push({
                    id: testId,
                    code: testCode,
                    name: testName,
                    price: price
                });
                
                totalPrice += price;
            }
        });

        // Update count and display
        selectedCount.textContent = selectedTests.length;
        totalPriceElement.textContent = totalPrice.toFixed(2);

        if (selectedTests.length > 0) {
            selectedTestsSummary.style.display = 'block';
            testSelectionAlert.style.display = 'none';
            
            selectedTestsList.innerHTML = selectedTests.map(test => 
                `<div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                    <div>
                        <strong class="text-primary">${test.code}</strong>
                        <div class="text-muted">${test.name}</div>
                    </div>
                    <div class="text-end">
                        <strong class="text-success">₦${test.price.toFixed(2)}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-test" 
                                data-test-id="${test.id}" title="Remove test">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>`
            ).join('');
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-test').forEach(button => {
                button.addEventListener('click', function() {
                    const testId = this.dataset.testId;
                    const item = document.querySelector(`.test-item[data-test-id="${testId}"]`);
                    if (item) {
                        const checkbox = item.querySelector('.test-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                            updateSelectedTestsSummary();
                        }
                    }
                });
            });
        } else {
            selectedTestsSummary.style.display = 'none';
        }
    }

    // Listen to checkbox changes
    testCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedTestsSummary);
    });

    // ======================
    // FORM VALIDATION
    // ======================
    document.getElementById('testRequestForm').addEventListener('submit', function(e) {
        const selectedTests = Array.from(testCheckboxes).filter(cb => cb.checked);
        
        if (selectedTests.length === 0) {
            e.preventDefault();
            testSelectionAlert.style.display = 'block';
            testSelectionAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Flash the test selection card
            const testCard = testSelectionAlert.closest('.card');
            testCard.classList.add('border-danger');
            setTimeout(() => testCard.classList.remove('border-danger'), 2000);
        }
    });

    // Initialize
    toggleNewPatientSection();
    updateSelectedTestsSummary();
});
</script>

<style>
/* Test Card Styling */
.test-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
}

.test-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.15);
    transform: translateY(-2px);
}

.test-checkbox:checked + label {
    font-weight: 600;
}

.test-checkbox:checked ~ * .test-card,
.test-item:has(.test-checkbox:checked) .test-card {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.05);
}

/* Patient Select Styling */
#id_existing_patient {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#id_existing_patient option {
    padding: 0.5rem;
    border-bottom: 1px solid #f8f9fa;
}

#id_existing_patient option:hover {
    background-color: #e7f1ff;
}

/* Scrollbar Styling */
.tests-container::-webkit-scrollbar,
#id_existing_patient::-webkit-scrollbar {
    width: 8px;
}

.tests-container::-webkit-scrollbar-track,
#id_existing_patient::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.tests-container::-webkit-scrollbar-thumb,
#id_existing_patient::-webkit-scrollbar-thumb {
    background: #0d6efd;
    border-radius: 4px;
}

.tests-container::-webkit-scrollbar-thumb:hover,
#id_existing_patient::-webkit-scrollbar-thumb:hover {
    background: #0b5ed7;
}

/* Remove test button */
.remove-test {
    padding: 0.15rem 0.4rem;
    font-size: 0.75rem;
    line-height: 1;
}

/* Form check input */
.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

/* Transition for new patient section */
#newPatientSection {
    transition: all 0.3s ease;
}

/* Search input focus */
.input-group:focus-within .input-group-text {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

/* Alert animations */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.border-danger {
    animation: shake 0.5s;
}
</style>
{% endblock %}