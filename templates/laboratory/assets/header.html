{% load static %}
<!-- Laboratory Header - Redesigned to Match Dashboard -->
<header class="laboratory-header">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
        <div class="container-fluid">
            <!-- Brand Logo & Name - Aligned with Dashboard Colors -->
            <a class="navbar-brand d-flex align-items-center" href="{% url 'labs:vendor_dashboard' %}">
                {% if vendor_profile.logo %}
                <img src="{{ vendor_profile.logo.url }}" alt="{{ vendor.name }}" class="header-logo me-2">
                {% else %}
                <div class="brand-icon me-2">
                    <i class="bi bi-hexagon-fill text-brand-red"></i>
                </div>
                {% endif %}
                <div class="brand-text">
                    <strong class="text-brand-blue uppercase">{{ vendor.name|default:"MEDVUNO" }}</strong>
                    <small class="d-block text-muted" style="font-size: 0.75rem; line-height: 1;">Laboratory Management System</small>
                </div>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#labNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation Menu - Using Dashboard Color Scheme -->
            <div class="collapse navbar-collapse" id="labNavbar">
                <ul class="navbar-nav me-auto" style="font-size: 14px;">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'labs:vendor_dashboard' %}active{% endif %}" 
                            href="{% url 'labs:vendor_dashboard' %}">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a 
                        class="nav-link {% if request.resolver_match.url_name == 'labs:patient_list' %}active{% endif %}" 
                            href="{% url 'labs:patient_list' %}">
                            <i class="bi bi-people me-1"></i>Patients
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear me-1"></i>Test Operations
                        </a>
                        <ul class="dropdown-menu" style="font-size: 14px;">
                            <li>
                                <a class="dropdown-item {% if 'test_assignment' in request.resolver_match.url_name %}active{% endif %}" 
                                    href="{% url 'labs:test_assignment_list' %}">
                                    <i class="bi bi-list-task me-1"></i>Test Assignment
                                </a>
                            </li>
                         
                           <li class="">
                                <a class="dropdown-item {% if 'test_request' in request.resolver_match.url_name %}active{% endif %}" 
                                    href="{% url 'labs:test_request_list' %}">
                                    <i class="bi bi-clipboard-check me-1"></i>Test Requests
                                </a>
                            </li>
                            <li class="">
                                <a class="dropdown-item {% if 'result' in request.resolver_match.url_name %}active{% endif %}" 
                                    href="{% url 'labs:result_list' %}">
                                    <i class="bi bi-bar-chart me-1"></i>Test Results
                                </a>
                            <li><hr class="dropdown-divider"></li>
                            </li>
                            <li class="">
                                <a class="dropdown-item {% if 'sample' in request.resolver_match.url_name %}active{% endif %}" 
                                    href="{% url 'labs:sample-exam-list' %}">
                                    <i class="bi bi-droplet me-1"></i>Samples
                                </a>
                            </li>

                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear me-1"></i>Management
                        </a>
                        <ul class="dropdown-menu" style="font-size: 14px;">
                            <li><a class="dropdown-item" href="{% url 'labs:test_list' %}">
                                <i class="bi bi-clipboard2-pulse me-2"></i>Test Catalog
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'labs:department_list' %}">
                                <i class="bi bi-building me-2"></i>Departments
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'account:equipment_list' %}">
                                <i class="bi bi-sliders me-2"></i>Equipment Set Up
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'account:equipment_list' %}">
                                <i class="bi bi-sliders me-2"></i>Inventory
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'account:equipment_list' %}">
                                <i class="bi bi-sliders me-2"></i>Document Control
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-calendar-check me-1"></i>Appointment
                        </a>
                        <ul class="dropdown-menu" style="font-size: 14px;">
                            <li>
                                <a class="dropdown-item {% if 'staff_appointment_list' in request.resolver_match.url_name %}active{% endif %}"  href="{% url 'appointment:staff_appointment_list' %}"><i class="fas fa-calendar-check me-2"></i>
                                    All Bookings
                                </a>
                            </li>
                            <li><a class="dropdown-item {% if 'slot_calendar_view' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'appointment:slot_calendar_view' %}">
                                <i class="bi bi-calendar-check me-2"></i>Calendar
                            </a>
                        </li>
                            <li><a class="dropdown-item {% if 'slot_template_list' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'appointment:slot_template_list' %}">
                                <i class="fas fa-cogs me-2"></i>Slot Templates
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                           <li><a class="dropdown-item {% if 'slot_template_generate' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'appointment:slot_template_generate' %}">
                                <i class="fas fa-sync me-2"></i>Generate Slots
                            </a></li>
                           <li><a class="dropdown-item {% if 'slot_instance_list' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'appointment:slot_instance_list' %}">
                                <i class="fa-solid fa-group-arrows-rotate me-2"></i>All Slots
                            </a></li>
                        </ul>
                    </li>
                </ul>

                <!-- Right Side: User Menu & Actions -->
                <div class="navbar-nav align-items-center" style="font-size: 14px;">
                    <!-- Quick Actions -->
                    <div class="nav-item me-3">
                        <a href="{% url 'labs:create_test_request' %}" class="btn btn-brand-red btn-sm">
                            <i class="bi bi-plus-circle me-1"></i>New Request
                        </a>
                    </div>

                    <div>
                        <!-- notifications dropdown in topbar -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Notifications <span id="notificationCount" class="badge bg-danger">0</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown" style="width: 350px;">
                                <li class="dropdown-header">Recent Notifications</li>
                                <div id="notificationsContainer" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"></div>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a href="/notifications/" class="dropdown-item text-center">View All</a></li>
                            </ul>
                        </li>
                    </div>

                    <!-- User Menu -->
                    <div class="nav-item dropdown" style="font-size: 14px;">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <div class="user-avatar me-2">
                                {{ request.user.first_name|first }}{{ request.user.last_name|first }}
                            </div>
                            <span class="text-dark">{{ request.user.get_full_name|default:"User" }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">Signed in as</h6></li>
                            <li>
                                <span class="dropdown-item-text">
                                <small class="text-muted">{{ request.user.role|default:"Lab Staff" }}

                                </small>
                            </span></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'account:laboratory_profile' %}">
                                <i class="bi bi-person me-2"></i>Profile
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-bell me-2"></i>Notifications
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-question-circle me-2"></i>Help & Support
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-brand-red" href="{% url 'account:logout' %}">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
</div>

<style>

    :root {
    --brand-blue: #1a237e; /* Example brand colors */
    --brand-red: #d32f2f;
    }
    .text-brand-blue { color: var(--brand-blue); }
    .text-brand-red { color: var(--brand-red); }
    .btn-brand-red { background-color: var(--brand-red); color: white; border: none; }
    .btn-brand-red:hover { background-color: #b71c1c; color: white; }
    
    .user-avatar {
        width: 32px;
        height: 32px;
        background: var(--brand-blue);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.8rem;
    }

    .unread { border-left: 4px solid var(--brand-red) !important; }
    #notificationCount { font-size: 0.65rem; padding: 0.35em 0.65em; }
    
    /* Animation for Toasts */
    .toast { border-radius: 8px; overflow: hidden; border: none; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
</style>



<script>

document.addEventListener("DOMContentLoaded", function () {
    const notificationsContainer = document.getElementById("notificationsContainer");
    const notificationCount = document.getElementById("notificationCount");
    let unreadCount = 0;

    // --- 1. Helper Functions ---
    function updateBadge() {
        notificationCount.innerText = unreadCount;
        notificationCount.style.display = unreadCount > 0 ? "inline-block" : "none";
    }

    function showToast(notification) {
        const toastContainer = document.getElementById("toastContainer");
        const toastId = `toast-${Date.now()}`;
        const toastHtml = `
            <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-primary text-white">
                    <strong class="me-auto text-capitalize">${notification.event_type.replace(/_/g, ' ')}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${notification.payload.summary || "New update in the LIMS system."}
                </div>
            </div>
        `;
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        setTimeout(() => { if (toastElement) toastElement.remove(); }, 5000);
    }

    function addNotification(notification, prepend = true) {
        const item = document.createElement("a");
        item.href = "#"; 
        item.classList.add("list-group-item", "list-group-item-action");
        item.setAttribute("data-id", notification.id);

        if (!notification.read) {
            item.classList.add("unread", "bg-light");
            unreadCount++;
            updateBadge();
        }

        const message = notification.payload.summary || notification.payload.message || "New LIMS Update";
        item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-capitalize" style="font-size: 13px;">${notification.event_type.replace(/_/g, ' ')}</h6>
                <small class="text-muted">Now</small>
            </div>
            <p class="mb-1 small text-muted">${message}</p>
        `;
        if (prepend) notificationsContainer.prepend(item);
        else notificationsContainer.appendChild(item);
    }

    // --- 2. WebSocket Connection (Define this first!) ---
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${window.location.host}/ws/notifications/`);

    ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const notification = {
            id: data.id,
            event_type: data.type,
            payload: data.payload,
            read: false
        };
        addNotification(notification);
        showToast(notification);
    };

    // --- 3. Initial Data Fetch ---
    async function fetchNotifications() {
        try {
            const response = await fetch("/api/notifications/");
            const data = await response.json();
            unreadCount = 0;
            notificationsContainer.innerHTML = "";
            data.forEach(n => addNotification(n, false));
            updateBadge();
        } catch (err) { console.error("History fetch failed", err); }
    }
    fetchNotifications();

    // --- 4. Mark as Read ---
    const dropdownToggle = document.getElementById("notificationsDropdown");
    dropdownToggle.addEventListener("click", async () => {
        const unreadItems = notificationsContainer.querySelectorAll(".unread");
        if (unreadItems.length === 0) return;

        unreadCount = 0;
        updateBadge();

        unreadItems.forEach(item => {
            const id = item.dataset.id;
            item.classList.remove("unread", "bg-light");
            fetch(`/api/notifications/${id}/read/`, { 
                method: "POST",
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>