{% extends "laboratory/assets/base.html" %}
{% load static %}

{% block title %}{{ assignment.lab_test.name }} - {{ vendor.name }}{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'labs:test_assignment_list' %}" class="text-decoration-none">
                            <i class="bi bi-list-check me-1"></i>Assignments
                        </a>
                    </li>
                    <li class="breadcrumb-item active text-dark">{{ assignment.lab_test.name }}</li>
                </ol>
            </nav>
            <h1 class="page-title fw-bold text-dark mb-1">
                <i class="bi bi-clipboard-check me-2 text-primary"></i>Test Assignment
            </h1>
            <p class="page-subtitle text-muted mb-0">
                {{ assignment.lab_test.code }} • {{ assignment.request.request_id }}
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'labs:test_assignment_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>
</div>

<div class="dashboard-content">
    <!-- Quick Actions Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    {% if can_send and assignment.instrument %}
                    <form method="post" action="{% url 'labs:send_assignment_to_instrument' assignment.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-send me-2"></i>Send to Instrument
                        </button>
                    </form>
                    {% elif not assignment.instrument %}
                    <button class="btn btn-outline-warning w-100" disabled>
                        <i class="bi bi-exclamation-triangle me-2"></i>No Instrument Assigned
                    </button>
                    {% else %}
                    <button class="btn btn-outline-secondary w-100" disabled>
                        <i class="bi bi-check me-2"></i>Already Sent
                    </button>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    {% if not assignment.result %}
                        <a href="{% url 'labs:enter_manual_test_result' assignment.id %}"
                        class="btn btn-success w-100">
                            Enter Result
                        </a>
                    {% else %}
                        <a href="{% url 'labs:update_manual_test_result' assignment.result.id %}"
                        class="btn btn-outline-success w-100">
                            Update Result
                        </a>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    {% if result and not result.verified_at and result.entered_by != request.user %}
                    <form method="post" action="{% url 'labs:verify_result' result.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="bi bi-shield-check me-2"></i>Verify Result
                        </button>
                    </form>
                    {% elif result and result.verified_at and not result.released %}
                    <form method="post" action="{% url 'labs:release_result' result.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-info w-100">
                            <i class="bi bi-send-check me-2"></i>Release Result
                        </button>
                    </form>
                    {% else %}
                    <button class="btn btn-outline-secondary w-100" disabled>
                        <i class="bi bi-check-circle me-2"></i>Completed
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Assignment Information -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0 fw-semibold text-dark">
                        <i class="bi bi-info-circle me-2 text-primary"></i>
                        Assignment Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Request ID</label>
                            <p class="fs-6 mb-0 text-dark">
                                <a href="{% url 'labs:request_detail' assignment.request.id %}" class="text-decoration-none">
                                    {{ assignment.request.request_id }}
                                </a>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Test Code</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.lab_test.code }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Test Name</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.lab_test.name }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Price</label>
                            <p class="fs-6 mb-0 text-success">₦{{ assignment.lab_test.price|floatformat:2 }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Department</label>
                            <p class="fs-6 mb-0">
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border-0">
                                    {{ assignment.department.name }}
                                </span>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Result Type</label>
                            <p class="fs-6 mb-0">
                                {% if assignment.lab_test.result_type == 'QNT' %}
                                    <span class="badge bg-info bg-opacity-15 text-info border-0">Quantitative</span>
                                {% else %}
                                    <span class="badge bg-warning bg-opacity-15 text-warning border-0">Qualitative</span>
                                {% endif %}
                            </p>
                        </div>
                        {% if assignment.lab_test.default_units %}
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Default Units</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.lab_test.default_units }}</p>
                        </div>
                        {% endif %}
                        {% if assignment.lab_test.specimen_type %}
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Specimen Type</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.lab_test.specimen_type }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient & Status Information -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0 fw-semibold text-dark">
                        <i class="bi bi-person me-2 text-primary"></i>
                        Patient & Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Patient Name</label>
                            <p class="fs-6 mb-0 text-dark">
                                {{ assignment.request.patient.first_name }} {{ assignment.request.patient.last_name }}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Patient ID</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.request.patient.patient_id }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Date of Birth</label>
                            <p class="fs-6 mb-0 text-dark">
                                {{ assignment.request.patient.date_of_birth|date:"M d, Y" }}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Gender</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.request.patient.get_gender_display }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Status</label>
                            <p class="fs-6 mb-0">
                                {% if assignment.status == 'P' %}
                                    <span class="badge bg-warning bg-opacity-15 text-warning border-0">
                                        <i class="bi bi-clock me-1"></i>Pending
                                    </span>
                                {% elif assignment.status == 'Q' %}
                                    <span class="badge bg-info bg-opacity-15 text-info border-0">
                                        <i class="bi bi-list-check me-1"></i>Queued
                                    </span>
                                {% elif assignment.status == 'I' %}
                                    <span class="badge bg-primary bg-opacity-15 text-primary border-0">
                                        <i class="bi bi-play-circle me-1"></i>In Progress
                                    </span>
                                {% elif assignment.status == 'A' %}
                                    <span class="badge bg-success bg-opacity-15 text-success border-0">
                                        <i class="bi bi-check-circle me-1"></i>Completed
                                    </span>
                                {% elif assignment.status == 'V' %}
                                    <span class="badge bg-success bg-opacity-15 text-success border-0">
                                        <i class="bi bi-shield-check me-1"></i>Verified
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger bg-opacity-15 text-danger border-0">
                                        <i class="bi bi-x-circle me-1"></i>Rejected
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Priority</label>
                            <p class="fs-6 mb-0">
                                {% if assignment.request.priority == 'urgent' %}
                                    <span class="badge bg-danger bg-opacity-15 text-danger border-0">Urgent</span>
                                {% elif assignment.request.priority == 'stat' %}
                                    <span class="badge bg-danger bg-opacity-15 text-danger border-0">STAT</span>
                                {% else %}
                                    <span class="badge bg-secondary bg-opacity-15 text-secondary border-0">Routine</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Created</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Assigned To</label>
                            <p class="fs-6 mb-0 text-dark">
                                {% if assignment.assigned_to %}
                                    {{ assignment.assigned_to.get_full_name }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instrument Information -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0 fw-semibold text-dark">
                        <i class="bi bi-cpu me-2 text-info"></i>
                        Instrument Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if assignment.instrument %}
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Instrument Name</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.instrument.name }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Model</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.instrument.model }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Serial Number</label>
                            <p class="fs-6 mb-0 text-dark">
                                <code>{{ assignment.instrument.serial_number }}</code>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">API Configured</label>
                            <p class="fs-6 mb-0">
                                {% if assignment.instrument.api_endpoint %}
                                    <span class="badge bg-success bg-opacity-15 text-success border-0">
                                        <i class="bi bi-check-circle me-1"></i>Yes
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary bg-opacity-15 text-secondary border-0">
                                        <i class="bi bi-x-circle me-1"></i>No
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-12">
                            <a href="{% url 'account:equipment_detail' assignment.instrument.id %}" 
                               class="btn btn-outline-info btn-sm">
                                <i class="bi bi-eye me-1"></i>View Instrument Details
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-cpu fs-1 text-muted mb-3 opacity-50"></i>
                        <p class="text-muted mb-3">No instrument assigned to this test</p>
                        <a href="{% url 'labs:test_assignment_list' %}" class="btn btn-outline-warning btn-sm">
                            <i class="bi bi-pencil me-1"></i>Assign Instrument
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sample Information -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0 fw-semibold text-dark">
                        <i class="bi bi-droplet me-2 text-success"></i>
                        Sample Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if assignment.sample %}
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Sample ID</label>
                            <p class="fs-6 mb-0 text-dark">
                                <code>{{ assignment.sample.sample_id }}</code>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Specimen Type</label>
                            <p class="fs-6 mb-0 text-dark">{{ assignment.sample.specimen_type }}</p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Collection Date</label>
                            <p class="fs-6 mb-0 text-dark">
                                {{ assignment.sample.collected_at|date:"M d, Y H:i" }}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Collected By</label>
                            <p class="fs-6 mb-0 text-dark">
                                {{ assignment.sample.collected_by|default:"—" }}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label fw-semibold text-muted small mb-1">Sample Status</label>
                            <p class="fs-6 mb-0">
                                <span class="badge bg-success bg-opacity-15 text-success border-0">
                                    {{ assignment.sample.get_status_display }}
                                </span>
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-droplet fs-1 text-muted mb-3 opacity-50"></i>
                        <p class="text-muted mb-0">No sample information available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Test Result Section -->
        {% if result %}
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0 fw-semibold text-dark">
                        <i class="bi bi-clipboard-data me-2 text-success"></i>
                        Test Result
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Result Value</label>
                            <p class="fs-5 mb-0 text-dark fw-bold">{{ result.result_value }}</p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Units</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.units|default:assignment.lab_test.default_units }}</p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Reference Range</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.reference_range|default:"—" }}</p>
                        </div>
                        {% if result.interpretation %}
                        <div class="col-12">
                            <label class="form-label fw-semibold text-muted small mb-1">Interpretation</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.interpretation }}</p>
                        </div>
                        {% endif %}
                        {% if result.notes %}
                        <div class="col-12">
                            <label class="form-label fw-semibold text-muted small mb-1">Notes</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.notes }}</p>
                        </div>
                        {% endif %}
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Entered By</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.entered_by.get_full_name }}</p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Entered At</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                        {% if result.verified_at %}
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Verified By</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.verified_by.get_full_name }}</p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted small mb-1">Verified At</label>
                            <p class="fs-6 mb-0 text-dark">{{ result.verified_at|date:"M d, Y H:i" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Communication Logs -->
        {% if logs %}
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0 fw-semibold text-dark">
                        <i class="bi bi-clock-history me-2 text-secondary"></i>
                        Recent Communication Logs
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 ps-4">Timestamp</th>
                                    <th class="border-0">Action</th>
                                    <th class="border-0">Status</th>
                                    <th class="border-0">Message</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr class="border-top">
                                    <td class="ps-4">
                                        <small class="text-dark fw-medium d-block">{{ log.timestamp|date:"M d, Y" }}</small>
                                        <small class="text-muted">{{ log.timestamp|time:"H:i" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary border-0">
                                            {{ log.get_action_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if log.success %}
                                            <span class="badge bg-success bg-opacity-15 text-success border-0">
                                                <i class="bi bi-check-circle me-1"></i>Success
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger bg-opacity-15 text-danger border-0">
                                                <i class="bi bi-x-circle me-1"></i>Failed
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="pe-4">
                                        <small class="text-muted">{{ log.message|truncatewords:10 }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.table tbody tr {
    transition: background-color 0.3s ease;
}

.table tbody tr:hover {
    background-color: rgba(44, 90, 160, 0.02);
}

@media (max-width: 768px) {
    .page-header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 1rem;
    }
    
    .btn-group {
        flex-wrap: wrap;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confirmations for critical actions
    const sendButtons = document.querySelectorAll('form[action*="send_assignment_to_instrument"] button');
    sendButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            if (!confirm('Send this test to the instrument? This will queue the test for processing.')) {
                e.preventDefault();
            }
        });
    });
    
    const verifyButtons = document.querySelectorAll('form[action*="verify_test_result"] button');
    verifyButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            if (!confirm('Verify this test result? This action cannot be undone.')) {
                e.preventDefault();
            }
        });
    });
    
    const releaseButtons = document.querySelectorAll('form[action*="release_test_result"] button');
    releaseButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            if (!confirm('Release this result to the patient? This will make the result available.')) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}