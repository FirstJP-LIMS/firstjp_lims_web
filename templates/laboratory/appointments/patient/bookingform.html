{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% block title %}
        <title>Book Appointment | {{ vendor.name }}</title>
    {% endblock %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- tailwind setup -->
    <link rel="stylesheet" href="{% static 'dist/styles.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/tailwind.css' %}">
    
    <!-- google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <!-- font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer"/>
    
    <style>
        .step-indicator {
            position: relative;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }
        .step-active {
            background: #001f3f;
            color: white;
        }
        .step-complete {
            background: #10b981;
            color: white;
        }
        .slot-card {
            transition: all 0.2s ease;
        }
        .slot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 31, 63, 0.15);
        }
        .slot-radio:checked + .slot-label {
            background: #001f3f;
            color: white;
            border-color: #001f3f;
        }
        /* FIXED: Changed color for checked slot label text */
        .slot-radio:checked + .slot-label .slot-time,
        .slot-radio:checked + .slot-label .slot-type,
        .slot-radio:checked + .slot-label .slot-spots {
            color: white;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* ADDED: Better form field styling */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #001f3f;
            box-shadow: 0 0 0 3px rgba(0, 31, 63, 0.1);
        }
        textarea {
            min-height: 100px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-flask text-navy text-2xl mr-3"></i>
                    <span class="text-xl font-bold text-navy">{{ vendor.name }}</span>
                </div>
                <div class="flex items-center space-x-4">
                    {% if request.user.is_authenticated %}
                    <span class="text-sm text-gray-600">Welcome, {{ request.user.get_full_name }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
     <div class="container mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                Book an Appointment at {{ vendor.name }}
            </h1>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Select your preferred date and time slot for your lab visit
            </p>
        </div>

        <!-- Messages/Alerts -->
        {% if messages %}
        <div class="max-w-3xl mx-auto mb-6">
            {% for message in messages %}
            <div class="p-4 rounded-md {% if message.tags == 'error' %}bg-red-50 text-red-800{% else %}bg-green-50 text-green-800{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Booking Form -->
        <div class="max-w-6xl mx-auto">
            <form method="POST" class="bg-white rounded-xl shadow-lg overflow-hidden">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6 md:p-8">
                    <!-- Left Column: Patient Information -->
                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3">
                            Patient Information
                        </h2>

                        <!-- Existing Patient Selection -->
                        {% if user.is_authenticated and user.patient_profile %}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Are you booking for yourself?
                                </label>
                                <div class="flex items-center space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="use_existing" value="yes" class="form-radio text-blue-600" checked 
                                               onchange="togglePatientFields(true)">
                                        <span class="ml-2">Yes, book for myself</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="use_existing" value="no" class="form-radio text-blue-600"
                                               onchange="togglePatientFields(false)">
                                        <span class="ml-2">No, book for someone else</span>
                                    </label>
                                </div>
                            </div>

                            <div id="existing-patient-field">
                                {{ form.existing_patient.label_tag }}
                                <div class="relative">
                                    {{ form.existing_patient }}
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                {% if form.existing_patient.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.existing_patient.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- New Patient Fields -->
                        <div id="new-patient-fields" class="space-y-4 {% if user.is_authenticated and user.patient_profile %}hidden{% endif %}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    {{ form.visitor_first_name.label_tag }}
                                    {{ form.visitor_first_name }}
                                    {% if form.visitor_first_name.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.visitor_first_name.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    {{ form.visitor_last_name.label_tag }}
                                    {{ form.visitor_last_name }}
                                    {% if form.visitor_last_name.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.visitor_last_name.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>

                            <div>
                                {{ form.visitor_email.label_tag }}
                                {{ form.visitor_email }}
                                {% if form.visitor_email.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.visitor_email.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                {{ form.visitor_phone.label_tag }}
                                {{ form.visitor_phone }}
                                {% if form.visitor_phone.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.visitor_phone.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    {{ form.visitor_date_of_birth.label_tag }}
                                    <div class="relative">
                                        {{ form.visitor_date_of_birth }}
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3">
                                            <i class="fas fa-calendar text-gray-400"></i>
                                        </div>
                                    </div>
                                    {% if form.visitor_date_of_birth.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.visitor_date_of_birth.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    {{ form.visitor_gender.label_tag }}
                                    <div class="relative">
                                        {{ form.visitor_gender }}
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <i class="fas fa-chevron-down"></i>
                                        </div>
                                    </div>
                                    {% if form.visitor_gender.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.visitor_gender.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Appointment Details -->
                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3">
                            Appointment Details
                        </h2>

                        <!-- Appointment Type -->
                        <div>
                            {{ form.appointment_type.label_tag }}
                            <div class="grid grid-cols-2 gap-3 mt-2">
                                {% for value, label in form.appointment_type.field.choices %}
                                {% if value %}
                                <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none">
                                    <input type="radio" name="appointment_type" value="{{ value }}" class="sr-only" 
                                           {% if form.appointment_type.value == value %}checked{% endif %}>
                                    <div class="flex flex-1 items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="text-sm">
                                                <p class="font-medium text-gray-900">{{ label }}</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-check text-blue-600 opacity-0"></i>
                                    </div>
                                </label>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% if form.appointment_type.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.appointment_type.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Reason for Visit -->
                        <div>
                            {{ form.reason_for_visit.label_tag }}
                            {{ form.reason_for_visit }}
                            {% if form.reason_for_visit.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.reason_for_visit.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Special Requirements -->
                        <div>
                            {{ form.special_requirements.label_tag }}
                            {{ form.special_requirements }}
                            {% if form.special_requirements.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.special_requirements.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Time Slots Section -->
                <div class="border-t border-gray-200 p-6 md:p-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">
                        Select Date & Time
                    </h2>

                    {% if slots_by_date %}
                    <!-- Date Tabs -->
                    <div class="mb-6 overflow-x-auto">
                        <div class="flex space-x-2 pb-2">
                            {% for date, slots in slots_by_date.items %}
                            <button type="button"
                                    onclick="showDateSlots('{{ date|date:"Y-m-d" }}')"
                                    class="date-tab flex-shrink-0 px-4 py-2 rounded-lg border text-sm font-medium transition-colors
                                           {% if forloop.first %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                                <div class="text-center">
                                    <div class="text-xs">{{ date|date:"D" }}</div>
                                    <div class="font-semibold">{{ date|date:"d" }}</div>
                                    <div class="text-xs">{{ date|date:"M" }}</div>
                                </div>
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Time Slots Grid -->
                    <div class="space-y-4">
                        {% for date, slots in slots_by_date.items %}
                        <div id="slots-{{ date|date:'Y-m-d' }}" class="date-slots {% if not forloop.first %}hidden{% endif %}">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                Available slots for {{ date|date:"l, F d, Y" }}
                            </h3>
                            {% if slots %}
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                {% for slot in slots %}
                                <label class="relative">
                                    <input type="radio" name="slot" value="{{ slot.id }}" 
                                           class="sr-only peer" 
                                           {% if not slot.is_available %}disabled{% endif %}>
                                    <div class="p-4 border-2 rounded-lg cursor-pointer transition-all
                                                peer-checked:border-blue-500 peer-checked:bg-blue-50
                                                peer-disabled:opacity-50 peer-disabled:cursor-not-allowed
                                                hover:border-gray-400 peer-checked:hover:border-blue-500
                                                {% if slot.is_available %}bg-white border-gray-300{% else %}bg-gray-100 border-gray-200{% endif %}">
                                        <div class="text-center">
                                            <div class="font-medium text-gray-900">
                                                {{ slot.start_time|time:"g:i A" }}
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                to {{ slot.end_time|time:"g:i A" }}
                                            </div>
                                            {% if slot.is_available %}
                                            <div class="mt-2 text-xs text-green-600">
                                                <i class="fas fa-check-circle mr-1"></i>Available
                                            </div>
                                            {% else %}
                                            <div class="mt-2 text-xs text-red-600">
                                                <i class="fas fa-times-circle mr-1"></i>Booked
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-8 bg-gray-50 rounded-lg">
                                <i class="fas fa-calendar-times text-3xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">No available slots for this date</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.slot.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.slot.errors.0 }}</p>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <i class="fas fa-calendar-alt text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Available Slots</h3>
                        <p class="text-gray-600 max-w-md mx-auto">
                            There are no available appointment slots at the moment. Please check back later or contact the lab directly.
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- Form Actions -->
                <div class="border-t border-gray-200 p-6 md:p-8 bg-gray-50">
                    <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                        <div class="text-sm text-gray-600">
                            <p><i class="fas fa-info-circle mr-2"></i>You'll receive a confirmation email after booking</p>
                        </div>
                        <div class="flex space-x-4">
                            <a href="#" 
                               class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                                Cancel
                            </a>
                            <button type="submit"
                                    class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors
                                           {% if not slots_by_date %}opacity-50 cursor-not-allowed{% endif %}"
                                    {% if not slots_by_date %}disabled{% endif %}>
                                <i class="fas fa-calendar-check mr-2"></i>
                                Book Appointment
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Additional Info -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 p-3 rounded-lg mr-4">
                            <i class="fas fa-clock text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900">Duration</h3>
                    </div>
                    <p class="text-gray-600">Appointments typically last 15-30 minutes depending on the service type.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center mb-4">
                        <div class="bg-green-100 p-3 rounded-lg mr-4">
                            <i class="fas fa-notes-medical text-green-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900">Preparation</h3>
                    </div>
                    <p class="text-gray-600">Some tests may require fasting. Check your appointment confirmation for specific instructions.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-lg mr-4">
                            <i class="fas fa-calendar-times text-purple-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900">Cancellation</h3>
                    </div>
                    <p class="text-gray-600">You can cancel or reschedule up to 24 hours before your appointment.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden field values for JavaScript -->
{% if user.is_authenticated and user.patient_profile %}
<div id="patient-data" 
     data-first-name="{{ user.patient_profile.patient.first_name }}"
     data-last-name="{{ user.patient_profile.patient.last_name }}"
     data-email="{{ user.email }}"
     data-phone="{{ user.patient_profile.patient.phone_number }}"
     data-dob="{{ user.patient_profile.patient.date_of_birth|date:'Y-m-d' }}"
     data-gender="{{ user.patient_profile.patient.gender }}">
</div>
{% endif %}

<style>
    /* Form styling */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    select,
    textarea {
        @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors;
    }
    
    textarea {
        @apply min-h-[100px] resize-y;
    }
    
    label {
        @apply block text-sm font-medium text-gray-700 mb-1;
    }
    
    /* Radio button styling */
    input[type="radio"]:checked + div .fa-check {
        @apply opacity-100;
    }
    
    /* Date slot selection */
    .date-slots {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>

<script>
    // Toggle between existing patient and new patient fields
    function togglePatientFields(useExisting) {
        const newPatientFields = document.getElementById('new-patient-fields');
        const existingPatientField = document.getElementById('existing-patient-field');
        
        if (useExisting) {
            newPatientFields.classList.add('hidden');
            existingPatientField.classList.remove('hidden');
            fillPatientData();
        } else {
            newPatientFields.classList.remove('hidden');
            existingPatientField.classList.add('hidden');
            clearPatientData();
        }
    }
    
    // Fill form with existing patient data
    function fillPatientData() {
        const patientData = document.getElementById('patient-data');
        if (patientData) {
            document.querySelector('[name="visitor_first_name"]').value = patientData.dataset.firstName || '';
            document.querySelector('[name="visitor_last_name"]').value = patientData.dataset.lastName || '';
            document.querySelector('[name="visitor_email"]').value = patientData.dataset.email || '';
            document.querySelector('[name="visitor_phone"]').value = patientData.dataset.phone || '';
            document.querySelector('[name="visitor_date_of_birth"]').value = patientData.dataset.dob || '';
            document.querySelector('[name="visitor_gender"]').value = patientData.dataset.gender || '';
        }
    }
    
    // Clear patient data
    function clearPatientData() {
        document.querySelector('[name="visitor_first_name"]').value = '';
        document.querySelector('[name="visitor_last_name"]').value = '';
        document.querySelector('[name="visitor_email"]').value = '';
        document.querySelector('[name="visitor_phone"]').value = '';
        document.querySelector('[name="visitor_date_of_birth"]').value = '';
        document.querySelector('[name="visitor_gender"]').value = '';
    }
    
    // Show slots for selected date
    function showDateSlots(date) {
        // Hide all date slots
        document.querySelectorAll('.date-slots').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.date-tab').forEach(tab => {
            tab.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            tab.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        });
        
        // Show selected date slots
        const selectedSlots = document.getElementById(`slots-${date}`);
        if (selectedSlots) {
            selectedSlots.classList.remove('hidden');
        }
        
        // Add active class to clicked tab
        event.currentTarget.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        event.currentTarget.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    }
    
    // Initialize form validation
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        
        form.addEventListener('submit', function(e) {
            const slotSelected = document.querySelector('input[name="slot"]:checked');
            if (!slotSelected) {
                e.preventDefault();
                alert('Please select an appointment time slot.');
                return;
            }
            
            // Check if new patient fields are visible and filled
            const newPatientFields = document.getElementById('new-patient-fields');
            if (!newPatientFields.classList.contains('hidden')) {
                const requiredFields = [
                    'visitor_first_name',
                    'visitor_last_name',
                    'visitor_email',
                    'visitor_phone'
                ];
                
                const missingFields = [];
                requiredFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && !field.value.trim()) {
                        missingFields.push(fieldName.replace('visitor_', '').replace('_', ' '));
                    }
                });
                
                if (missingFields.length > 0) {
                    e.preventDefault();
                    alert(`Please fill in the following fields: ${missingFields.join(', ')}`);
                }
            }
        });
        
        // Auto-select first available date tab
        const firstDateTab = document.querySelector('.date-tab');
        if (firstDateTab) {
            firstDateTab.click();
        }
    });
</script>
