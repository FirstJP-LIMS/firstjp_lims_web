{% extends 'laboratory/assets/base_apt.html' %}
{% load static %}
{% block content %}

<div class="min-h-screen bg-gray-50">

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-lab-black mb-2">Slot Calendar</h1>
                <p class="text-gray-600">Weekly view of appointment slots and bookings</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex space-x-3">
                <a href="{% url 'appointment:staff_appointment_list' %}" class="px-4 py-2.5 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors font-medium">
                    <i class="fas fa-list mr-2"></i> List View
                </a>
                <a href="{% url 'appointment:slot_template_generate' %}" class="px-4 py-2.5 bg-lab-red hover:bg-lab-red-light text-white rounded-lg transition-colors font-medium">
                    <i class="fas fa-calendar-plus mr-2"></i> Generate Slots
                </a>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-navy">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Slots</p>
                        <p class="text-2xl font-bold text-lab-black mt-1">{{ total_slots }}</p>
                    </div>
                    <i class="fas fa-calendar-alt text-navy text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Available Slots</p>
                        <p class="text-2xl font-bold text-lab-black mt-1">{{ available_slots }}</p>
                    </div>
                    <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-lab-red">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Booked Slots</p>
                        <p class="text-2xl font-bold text-lab-black mt-1">{{ booked_slots }}</p>
                    </div>
                    <i class="fas fa-users text-lab-red text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Week Appointments</p>
                        <p class="text-2xl font-bold text-lab-black mt-1" id="appointmentsCount">0</p>
                    </div>
                    <i class="fas fa-calendar-check text-purple-500 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Calendar Header -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-navy-light bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-calendar-alt text-navy text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-lab-black">Week of {{ week_start|date:"M d" }} - {{ week_end|date:"M d, Y" }}</h2>
                        <p class="text-gray-600 text-sm">Viewing slots from {{ week_start|date:"F d" }} to {{ week_end|date:"F d, Y" }}</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Date Navigation -->
                    <div class="flex items-center space-x-2">
                        <a href="?date={{ prev_week|date:'Y-m-d' }}" 
                           class="w-10 h-10 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                            <i class="fas fa-chevron-left text-gray-600"></i>
                        </a>
                        
                        <div class="relative">
                            <input type="date" 
                                   id="datePicker" 
                                   value="{{ selected_date|date:'Y-m-d' }}"
                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy focus:border-navy transition-colors">
                        </div>
                        
                        <a href="?date={{ next_week|date:'Y-m-d' }}" 
                           class="w-10 h-10 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </a>
                        
                        <a href="?date={% now 'Y-m-d' %}" 
                           class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors font-medium">
                            Today
                        </a>
                    </div>
                    
                    <!-- View Options -->
                    <div class="relative group">
                        <button class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors font-medium flex items-center">
                            <i class="fas fa-cog mr-2"></i> Options
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden group-hover:block">
                            <button onclick="toggleSlotTypes()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-eye mr-2"></i> Toggle Slot Types
                            </button>
                            <button onclick="exportCalendar()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-download mr-2"></i> Export Week
                            </button>
                            <a href="{% url 'appointment:slot_template_list' %}?date={{ selected_date|date:'Y-m-d' }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-list mr-2"></i> View as List
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Calendar Header -->
            <div class="grid grid-cols-1 md:grid-cols-8 border-b border-gray-200">
                <div class="p-4 border-r border-gray-200 bg-gray-50">
                    <div class="text-sm font-medium text-gray-500 uppercase tracking-wider">Time</div>
                </div>
                
                {% for day in week_days %}
                <div class="p-4 border-r border-gray-200 {% if day.is_today %}bg-blue-50{% else %}bg-gray-50{% endif %}">
                    <div class="text-center">
                        <div class="text-sm font-medium text-gray-900">{{ day.date|date:"D" }}</div>
                        <div class="text-lg font-bold text-lab-black mt-1 {% if day.is_today %}text-blue-600{% endif %}">
                            {{ day.date|date:"d" }}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">{{ day.date|date:"M" }}</div>
                        <div class="mt-2">
                            <span class="inline-block px-2 py-1 text-xs rounded-full 
                                {% if day.slots|length == 0 %}bg-gray-100 text-gray-600
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ day.slots|length }} slots
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Calendar Body -->
            <div class="divide-y divide-gray-200">
                <!-- Time Slots -->
                {% for hour in hours %}
                <div class="grid grid-cols-1 md:grid-cols-8">
                    <!-- Time Label -->
                    <div class="p-3 border-r border-gray-200 bg-gray-50">
                        <div class="text-sm font-medium text-gray-700 text-right">
                            {{ hour|time:"g:i A" }}
                        </div>
                    </div>
                    
                    <!-- Day Columns -->
                    {% for day in week_days %}
                    <div class="p-3 border-r border-gray-200 min-h-20 {% if forloop.last %}border-r-0{% endif %} 
                        {% if day.is_today %}bg-blue-50 bg-opacity-30{% endif %}">
                        <!-- Slots for this time -->
                        {% for slot in day.slots %}
                            {% if slot.start_time.hour == hour.hour %}
                            <div class="slot-item mb-2" data-slot-type="{{ slot.slot_type }}">
                                <div class="slot-card p-3 rounded-lg border cursor-pointer transition-all hover:shadow-md"
                                     onclick="showSlotDetails({{ slot.id }})"
                                     data-slot-id="{{ slot.id }}"
                                     data-status="{% if slot.is_available %}available{% else %}booked{% endif %}">
                                    
                                    <!-- Slot Header -->
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <span class="slot-type-indicator {{ slot.slot_type }}"></span>
                                            <span class="text-xs font-medium ml-2">
                                                {{ slot.start_time|time:"g:i" }} - {{ slot.end_time|time:"g:i" }}
                                            </span>
                                        </div>
                                        <span class="text-xs px-2 py-0.5 rounded-full 
                                            {% if slot.is_available %}bg-green-100 text-green-800
                                            {% else %}bg-red-100 text-red-800{% endif %}">
                                            {{ slot.current_bookings }}/{{ slot.max_appointments }}
                                        </span>
                                    </div>
                                    
                                    <!-- Slot Details -->
                                    <div class="space-y-1">
                                        <div class="text-xs text-gray-600 flex items-center">
                                            <i class="fas {% if slot.is_active %}fa-toggle-on text-green-500{% else %}fa-toggle-off text-gray-400{% endif %} mr-1"></i>
                                            {% if slot.is_active %}Active{% else %}Inactive{% endif %}
                                        </div>
                                        
                                        
                                        <!-- Appointments in this slot -->
                                        <div class="appointments-list mt-2">
                                            {% for appointment in day.appointments %}
                                                {% if appointment.slot.id == slot.id %}
                                                <div class="appointment-item p-2 mb-1 bg-white border border-gray-200 rounded text-xs"
                                                     onclick="showAppointmentDetails('{{ appointment.appointment_id }}')">
                                                    <div class="flex items-center justify-between">
                                                        <div class="font-medium truncate">
                                                            {{ appointment.get_patient_name|truncatechars:15 }}
                                                        </div>
                                                        <span class="status-badge status-{{ appointment.status }}">
                                                            {{ appointment.status|slice:":1"|upper }}
                                                        </span>
                                                    </div>
                                                    <div class="text-gray-500 text-xs mt-1">
                                                        {{ appointment.appointment_type|slice:":10" }}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Legend -->
        <div class="mt-6 bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-lab-black mb-4">Calendar Legend</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></div>
                    <span class="text-sm text-gray-700">Available Slot</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></div>
                    <span class="text-sm text-gray-700">Fully Booked</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded mr-2"></div>
                    <span class="text-sm text-gray-700">Today's Date</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-gray-100 border border-gray-300 rounded mr-2"></div>
                    <span class="text-sm text-gray-700">Inactive Slot</span>
                </div>
            </div>
            
            <!-- Slot Type Indicators -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Slot Types</h4>
                <div class="flex flex-wrap gap-3">
                    <div class="flex items-center">
                        <span class="slot-type-indicator sample_collection mr-2"></span>
                        <span class="text-xs text-gray-600">Sample Collection</span>
                    </div>
                    <div class="flex items-center">
                        <span class="slot-type-indicator consultation mr-2"></span>
                        <span class="text-xs text-gray-600">Consultation</span>
                    </div>
                    <div class="flex items-center">
                        <span class="slot-type-indicator result_discussion mr-2"></span>
                        <span class="text-xs text-gray-600">Result Discussion</span>
                    </div>
                    <div class="flex items-center">
                        <span class="slot-type-indicator general mr-2"></span>
                        <span class="text-xs text-gray-600">General Visit</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Slot Details Modal -->
<div id="slotDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto h-full w-full flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-navy bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-calendar-day text-navy"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-lab-black">Slot Details</h3>
                        <p class="text-gray-600 text-sm" id="slotDateTime"></p>
                    </div>
                </div>
                <button onclick="closeSlotModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="slotDetailsContent">
                <!-- Filled by JavaScript -->
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeSlotModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Close
                </button>
                <a id="editSlotBtn" href="#" class="px-4 py-2 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">
                    <i class="fas fa-edit mr-2"></i> Edit Slot
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Details Modal -->
<div id="appointmentDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto h-full w-full flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-lab-red bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-calendar-check text-lab-red"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-lab-black">Appointment Details</h3>
                        <p class="text-gray-600 text-sm" id="appointmentId"></p>
                    </div>
                </div>
                <button onclick="closeAppointmentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="appointmentDetailsContent">
                <!-- Filled by JavaScript -->
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeAppointmentModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Close
                </button>
                <a id="viewAppointmentBtn" href="#" class="px-4 py-2 bg-lab-red hover:bg-lab-red-light text-white rounded-lg transition-colors">
                    <i class="fas fa-eye mr-2"></i> View Details
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom styles */
    .slot-card {
        border: 1px solid #e5e7eb;
        background: white;
        transition: all 0.2s ease;
    }
    
    .slot-card:hover {
        border-color: #001f3f;
        box-shadow: 0 4px 12px rgba(0, 31, 63, 0.1);
    }
    
    .slot-card[data-status="available"] {
        border-left: 3px solid #10b981;
    }
    
    .slot-card[data-status="booked"] {
        border-left: 3px solid #ef4444;
    }
    
    .slot-card[data-status="inactive"] {
        border-left: 3px solid #9ca3af;
    }
    
    .slot-type-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .slot-type-indicator.sample_collection {
        background-color: #3b82f6;
    }
    
    .slot-type-indicator.consultation {
        background-color: #8b5cf6;
    }
    
    .slot-type-indicator.result_discussion {
        background-color: #06b6d4;
    }
    
    .slot-type-indicator.general {
        background-color: #10b981;
    }
    
    .status-badge {
        padding: 0.1rem 0.4rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .status-pending {
        background-color: rgba(245, 158, 11, 0.1);
        color: #b45309;
    }
    
    .status-confirmed {
        background-color: rgba(34, 197, 94, 0.1);
        color: #15803d;
    }
    
    .status-cancelled {
        background-color: rgba(239, 68, 68, 0.1);
        color: #b91c1c;
    }
    
    .appointment-item {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .appointment-item:hover {
        background-color: #f9fafb;
        transform: translateX(2px);
    }
    
    /* Time column styling */
    .hours {
        position: relative;
    }
    
    .hour-label {
        position: absolute;
        right: 0.75rem;
        transform: translateY(-50%);
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    /* Calendar grid lines */
    .calendar-grid {
        display: grid;
        grid-template-columns: 80px repeat(7, 1fr);
        gap: 1px;
    }
    
    /* Today highlight */
    .today-highlight {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    /* Animation for modals */
    .modal-content {
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // Generate hours from 8 AM to 6 PM
    const hours = [];
    for (let h = 8; h <= 18; h++) {
        const hour = new Date();
        hour.setHours(h, 0, 0, 0);
        hours.push(hour);
    }
    
    // Update appointments count
    document.addEventListener('DOMContentLoaded', function() {
        let appointmentsCount = 0;
        {% for day in week_days %}
            appointmentsCount += {{ day.appointments|length }};
        {% endfor %}
        document.getElementById('appointmentsCount').textContent = appointmentsCount;
        
        // Date picker functionality
        const datePicker = document.getElementById('datePicker');
        datePicker.addEventListener('change', function() {
            window.location.href = `?date=${this.value}`;
        });
        
        // Initialize tooltips
        initializeTooltips();
    });
    
    // Show slot details
    function showSlotDetails(slotId) {
        // In a real implementation, you would fetch slot details via AJAX
        // For now, we'll redirect to the slot edit page
        window.location.href = `/appointments/slot/${slotId}/edit/`;
    }
    
    // Show appointment details
    function showAppointmentDetails(appointmentId) {
        // In a real implementation, you would fetch appointment details via AJAX
        // For now, we'll redirect to the appointment detail page
        window.location.href = `/appointments/staff/${appointmentId}/`;
    }
    
    // Close slot modal
    function closeSlotModal() {
        document.getElementById('slotDetailsModal').classList.add('hidden');
    }
    
    // Close appointment modal
    function closeAppointmentModal() {
        document.getElementById('appointmentDetailsModal').classList.add('hidden');
    }
    
    // Toggle slot types visibility
    function toggleSlotTypes() {
        const slotItems = document.querySelectorAll('.slot-item');
        let visible = true;
        
        // Check if any are hidden
        slotItems.forEach(item => {
            if (item.classList.contains('hidden')) {
                visible = false;
            }
        });
        
        // Toggle visibility
        slotItems.forEach(item => {
            if (visible) {
                item.classList.add('hidden');
            } else {
                item.classList.remove('hidden');
            }
        });
        
        // Show notification
        showNotification(visible ? 'All slot types hidden' : 'All slot types shown');
    }
    
    // Export calendar data
    function exportCalendar() {
        const weekRange = `{{ week_start|date:'Y-m-d' }} to {{ week_end|date:'Y-m-d' }}`;
        const data = {
            week: weekRange,
            slots: {{ total_slots }},
            available: {{ available_slots }},
            booked: {{ booked_slots }},
            days: []
        };
        
        {% for day in week_days %}
        data.days.push({
            date: '{{ day.date|date:"Y-m-d" }}',
            slots: {{ day.slots|length }},
            appointments: {{ day.appointments|length }}
        });
        {% endfor %}
        
        // Create and download JSON file
        const dataStr = JSON.stringify(data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `slot-calendar-{{ week_start|date:'Y-m-d' }}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showNotification('Calendar data exported successfully');
    }
    
    // Show notification
    function showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        notification.textContent = message;
        notification.style.animation = 'slideIn 0.3s ease-out';
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    
    // Initialize tooltips
    function initializeTooltips() {
        const slotCards = document.querySelectorAll('.slot-card');
        slotCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                // Add tooltip logic here
            });
        });
    }
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape closes modals
        if (e.key === 'Escape') {
            closeSlotModal();
            closeAppointmentModal();
        }
        
        // Arrow keys for navigation
        if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            window.location.href = '?date={{ prev_week|date:"Y-m-d" }}';
        }
        if (e.key === 'ArrowRight' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            window.location.href = '?date={{ next_week|date:"Y-m-d" }}';
        }
        if (e.key === 't' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            window.location.href = '?date={% now "Y-m-d" %}';
        }
    });
</script>

{% endblock %}