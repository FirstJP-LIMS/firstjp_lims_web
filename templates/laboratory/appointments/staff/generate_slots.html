{% extends 'laboratory/assets/base_apt.html' %}
{% load static %}
{% block content %}
<style>
    /* Custom styles */
    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 31, 63, 0.1);
    }
    
    .date-picker {
        position: relative;
    }
    
    .date-picker::after {
        content: '';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23001f3f'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        pointer-events: none;
    }
    
    .template-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 31, 63, 0.1);
    }
    
    .template-card.selected {
        border-color: #dc2626;
        background-color: rgba(220, 38, 38, 0.03);
    }
    
    .day-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .weekday-badge {
        background-color: rgba(37, 99, 235, 0.1);
        color: rgb(29, 78, 216);
    }
    
    .weekend-badge {
        background-color: rgba(168, 85, 247, 0.1);
        color: rgb(126, 34, 206);
    }
    
    .slot-type-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .badge-sample-collection {
        background-color: rgba(37, 99, 235, 0.1);
        color: rgb(29, 78, 216);
    }
    
    .badge-consultation {
        background-color: rgba(168, 85, 247, 0.1);
        color: rgb(126, 34, 206);
    }
    
    .badge-result-discussion {
        background-color: rgba(14, 165, 233, 0.1);
        color: rgb(2, 132, 199);
    }
    
    .badge-general {
        background-color: rgba(6, 182, 212, 0.1);
        color: rgb(14, 116, 144);
    }
    
    .generation-summary {
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .progress-bar {
        height: 4px;
        border-radius: 2px;
        background: linear-gradient(90deg, #dc2626, #ef4444);
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }
</style>

    
<!-- Main Content -->
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
            
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <a href="{% url 'appointment:slot_template_list' %}" class="ml-3 text-sm font-medium text-gray-700 hover:text-lab-red-light">Slot Templates</a>
                    </div>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <span class="ml-3 text-sm font-medium text-lab-black">Generate Slots</span>
                    </div>
                </li>
            </ol>
        </nav>
    </div>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-lab-black mb-2">Generate Appointment Slots</h1>
        <p class="text-gray-600">Create actual appointment slots from your templates for specific date ranges</p>
    </div>

    <!-- Messages Display -->
    {% if messages %}
    <div class="mb-8 space-y-3">
        {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% elif message.tags == 'info' %}bg-blue-50 border border-blue-200 text-blue-700{% else %}bg-green-50 border border-green-200 text-green-700{% endif %}">
            <div class="flex items-center">
                <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'info' %}fa-info-circle{% else %}fa-check-circle{% endif %} mr-3"></i>
                <span>{{ message }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column - Templates Selection -->
        <div class="lg:col-span-2">
            <!-- Template Selection Card -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-lab-red bg-opacity-10 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-layer-group text-lab-red text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-lab-black">Select Template</h2>
                        <p class="text-gray-600 text-sm">Choose a template to generate slots from</p>
                    </div>
                </div>
                
                {% if templates %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    {% for template in templates %}
                    <div class="template-card p-4 bg-white border border-gray-200 rounded-xl cursor-pointer"
                            onclick="selectTemplate({{ template.id }})"
                            id="template-{{ template.id }}">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="font-bold text-lab-black mb-1">{{ template.name }}</h3>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-sm text-gray-600">
                                        {{ template.start_time|time:"g:i A" }} - {{ template.end_time|time:"g:i A" }}
                                    </span>
                                    <span class="slot-type-badge badge-{{ template.slot_type }}">
                                        {{ template.get_slot_type_display }}
                                    </span>
                                </div>
                                
                                <!-- Days -->
                                <div class="mb-2">
                                    {% if template.recurrence_pattern == 'weekdays' %}
                                    <span class="day-badge weekday-badge">Mon-Fri</span>
                                    {% elif template.recurrence_pattern == 'weekends' %}
                                    <span class="day-badge weekend-badge">Sat-Sun</span>
                                    {% elif template.recurrence_pattern == 'daily' %}
                                    <span class="day-badge bg-green-100 text-green-800">Daily</span>
                                    {% else %}
                                    <div class="flex flex-wrap gap-1">
                                        {% if template.monday %}<span class="day-badge weekday-badge">M</span>{% endif %}
                                        {% if template.tuesday %}<span class="day-badge weekday-badge">T</span>{% endif %}
                                        {% if template.wednesday %}<span class="day-badge weekday-badge">W</span>{% endif %}
                                        {% if template.thursday %}<span class="day-badge weekday-badge">T</span>{% endif %}
                                        {% if template.friday %}<span class="day-badge weekday-badge">F</span>{% endif %}
                                        {% if template.saturday %}<span class="day-badge weekend-badge">S</span>{% endif %}
                                        {% if template.sunday %}<span class="day-badge weekend-badge">S</span>{% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">{{ template.duration_minutes }}min</span> slots â€¢ 
                                    <span class="font-medium">{{ template.max_appointments }}</span> appointments/slot
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                    <div class="w-3 h-3 bg-lab-red rounded-full hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- No Templates Available -->
                <div class="text-center py-8">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-calendar-plus text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No active templates found</h3>
                    <p class="text-gray-500 mb-4">You need to create an active slot template first.</p>
                    <a href="{% url 'appointment:slot_template_create' %}" class="inline-flex items-center px-4 py-2 bg-lab-red hover:bg-lab-red-light text-white rounded-lg transition-colors text-sm">
                        <i class="fas fa-plus mr-2"></i> Create Template
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Date Range Card -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-navy bg-opacity-10 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-calendar-alt text-navy text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-lab-black">Select Date Range</h2>
                        <p class="text-gray-600 text-sm">Choose when to generate slots</p>
                    </div>
                </div>
                
                <form id="generateForm" method="POST">
                    {% csrf_token %}
                    
                    <!-- Hidden Template Field -->
                    <input type="hidden" name="template" id="selectedTemplate">
                    
                    <!-- Template Selection Error -->
                    {% if form.template.errors %}
                    <div class="mb-4 p-3 bg-red-50 border border-red-100 rounded-lg">
                        <div class="flex items-center text-red-700">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span class="text-sm">{{ form.template.errors.0 }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Start Date -->
                        <div>
                            <label for="id_start_date" class="block text-sm font-medium text-gray-700 mb-2">
                                Start Date <span class="text-lab-red">*</span>
                            </label>
                            <div class="date-picker">
                                <input type="date" 
                                        name="start_date" 
                                        id="id_start_date" 
                                        value="{{ form.start_date.value|default:'' }}"
                                        min="{% now 'Y-m-d' %}"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy focus:border-navy transition-colors"
                                        required>
                            </div>
                            {% if form.start_date.errors %}
                            <div class="mt-2 text-sm text-lab-red">
                                {% for error in form.start_date.errors %}
                                <p>
                                    <i class="fas fa-exclamation-circle mr-1"></i> {{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- End Date -->
                        <div>
                            <label for="id_end_date" class="block text-sm font-medium text-gray-700 mb-2">
                                End Date <span class="text-lab-red">*</span>
                            </label>
                            <div class="date-picker">
                                <input type="date" 
                                        name="end_date" 
                                        id="id_end_date" 
                                        value="{{ form.end_date.value|default:'' }}"
                                        min="{% now 'Y-m-d' %}"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy focus:border-navy transition-colors"
                                        required>
                            </div>
                            {% if form.end_date.errors %}
                            <div class="mt-2 text-sm text-lab-red">
                                {% for error in form.end_date.errors %}
                                <p><i class="fas fa-exclamation-circle mr-1"></i> {{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Date Range Validation -->
                    {% if form.non_field_errors %}
                    <div class="mt-4 p-3 bg-red-50 border border-red-100 rounded-lg">
                        <p class="text-sm text-red-700">
                            <i class="fas fa-exclamation-circle mr-2"></i>End date must be after start date
                        </p>
                    </div>
                    {% endif %}
                    
                    <!-- Generation Summary (Initially Hidden) -->
                    <div id="generationSummary" class="mt-6 hidden">
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 generation-summary">
                            <h3 class="font-bold text-lab-black mb-2">Generation Summary</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Template:</span>
                                    <span id="summaryTemplate" class="font-medium text-lab-black"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Date Range:</span>
                                    <span id="summaryDateRange" class="font-medium text-lab-black"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Days:</span>
                                    <span id="summaryTotalDays" class="font-medium text-lab-black"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Matching Days:</span>
                                    <span id="summaryMatchingDays" class="font-medium text-lab-black"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Estimated Slots:</span>
                                    <span id="summaryEstimatedSlots" class="font-medium text-green-600">Calculating...</span>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i> Existing slots won't be duplicated
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="mt-8">
                        <button type="submit" 
                                id="generateButton"
                                class="w-full md:w-auto px-8 py-3.5 bg-lab-red hover:bg-lab-red-light text-white font-medium rounded-lg transition-colors shadow-md hover:shadow-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-calendar-plus mr-2"></i> Generate Slots
                        </button>
                    </div>
                </form>
            </div>

            <!-- Recent Generations (Placeholder) -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-green-500 bg-opacity-10 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-history text-green-500 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-lab-black">Recent Generations</h2>
                        <p class="text-gray-600 text-sm">View recently generated slots</p>
                    </div>
                </div>
                
                <div class="text-center py-8">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-chart-line text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-500">Generation history will appear here after creating slots.</p>
                    <a href="{% url 'appointment:slot_calendar_view' %}" class="inline-flex items-center px-4 py-2 mt-4 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors text-sm">
                        <i class="fas fa-calendar-day mr-2"></i> View Slot Calendar
                    </a>
                </div>
            </div>
        </div>

        <!-- Right Column - Information & Help -->
        <div class="lg:col-span-1">
            <!-- Info Card -->
            <div class="glass-card rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-lab-black mb-4 flex items-center">
                    <i class="fas fa-info-circle text-navy mr-2"></i> How It Works
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 h-8 bg-lab-red-light bg-opacity-10 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-lab-red font-bold text-sm">1</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Select Template</h4>
                            <p class="text-sm text-gray-600 mt-1">Choose a template that defines the slot pattern</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 h-8 bg-navy bg-opacity-10 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-navy font-bold text-sm">2</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Set Date Range</h4>
                            <p class="text-sm text-gray-600 mt-1">Choose when to generate slots (future dates only)</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 h-8 bg-green-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-green-500 font-bold text-sm">3</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Generate & Review</h4>
                            <p class="text-sm text-gray-600 mt-1">System creates slots and skips existing ones</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="font-medium text-gray-900 mb-2">Tips</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                            <span>Generate slots for 1-2 weeks at a time for better control</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                            <span>Slots won't be created on dates with existing slots</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                            <span>You can always generate additional slots later</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Quick Actions Card -->
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-bold text-lab-black mb-4 flex items-center">
                    <i class="fas fa-bolt text-lab-red-light mr-2"></i> Quick Actions
                </h3>
                
                <div class="space-y-3">
                    <a href="{% url 'appointment:slot_template_create' %}" class="flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <div class="w-10 h-10 bg-lab-red-light bg-opacity-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-plus text-lab-red-light"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">New Template</h4>
                            <p class="text-xs text-gray-600">Create a new slot template</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'appointment:slot_template_list' %}" class="flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <div class="w-10 h-10 bg-navy bg-opacity-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-list text-navy"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">All Templates</h4>
                            <p class="text-xs text-gray-600">View and manage templates</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'appointment:slot_calendar_view' %}" class="flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <div class="w-10 h-10 bg-green-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-calendar-day text-green-500"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Slot Calendar</h4>
                            <p class="text-xs text-gray-600">View generated slots</p>
                        </div>
                    </a>
                </div>
                
                <!-- Bulk Generation (Optional) -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="font-medium text-gray-900 mb-3">Bulk Generation</h4>
                    <p class="text-sm text-gray-600 mb-3">Generate slots from all active templates for the next month</p>
                    <button id="bulkGenerateBtn" class="w-full px-4 py-2.5 bg-navy hover:bg-navy-dark text-white text-sm font-medium rounded-lg transition-colors flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> Generate for Next 30 Days
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay (Initially Hidden) -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
        <div class="w-16 h-16 mx-auto mb-4 bg-lab-red-light bg-opacity-10 rounded-full flex items-center justify-center">
            <i class="fas fa-calendar-plus text-lab-red-light text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-lab-black mb-2">Generating Slots</h3>
        <p class="text-gray-600 mb-6">Please wait while we create your appointment slots...</p>
        
        <!-- Animated Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-2 mb-4 overflow-hidden">
            <div class="progress-bar w-3/4"></div>
        </div>
        
        <p class="text-sm text-gray-500">This may take a few seconds</p>
    </div>
</div>


<script>
    let selectedTemplateId = null;
    const templateData = {
        {% for template in templates %}
        {{ template.id }}: {
            name: "{{ template.name }}",
            days: {{ template.get_active_days|safe }},
            startTime: "{{ template.start_time|time:'H:i' }}",
            endTime: "{{ template.end_time|time:'H:i' }}",
            recurrencePattern: "{{ template.recurrence_pattern }}",
            duration: {{ template.duration_minutes }},
            maxAppointments: {{ template.max_appointments }}
        },
        {% endfor %}
    };
    
    function selectTemplate(templateId) {
        // Remove selection from all templates
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
            const check = card.querySelector('.w-3.h-3');
            if (check) check.classList.add('hidden');
        });
        
        // Add selection to clicked template
        const templateCard = document.getElementById(`template-${templateId}`);
        templateCard.classList.add('selected');
        const check = templateCard.querySelector('.w-3.h-3');
        if (check) check.classList.remove('hidden');
        
        // Update form field
        selectedTemplateId = templateId;
        document.getElementById('selectedTemplate').value = templateId;
        
        // Enable generate button if dates are selected
        updateGenerateButton();
        
        // Update summary if dates are selected
        updateGenerationSummary();
    }
    
    function updateGenerateButton() {
        const startDate = document.getElementById('id_start_date').value;
        const endDate = document.getElementById('id_end_date').value;
        const generateButton = document.getElementById('generateButton');
        
        if (selectedTemplateId && startDate && endDate) {
            generateButton.disabled = false;
        } else {
            generateButton.disabled = true;
        }
    }
    
    function updateGenerationSummary() {
        const startDate = document.getElementById('id_start_date').value;
        const endDate = document.getElementById('id_end_date').value;
        const summaryDiv = document.getElementById('generationSummary');
        
        if (selectedTemplateId && startDate && endDate) {
            summaryDiv.classList.remove('hidden');
            
            const template = templateData[selectedTemplateId];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Update template name
            document.getElementById('summaryTemplate').textContent = template.name;
            
            // Update date range
            const formatDate = (date) => {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            };
            document.getElementById('summaryDateRange').textContent = 
                `${formatDate(start)} - ${formatDate(end)}`;
            
            // Calculate days
            const timeDiff = end.getTime() - start.getTime();
            const totalDays = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            document.getElementById('summaryTotalDays').textContent = totalDays;
            
            // Calculate matching days
            let matchingDays = 0;
            const templateDays = template.days;
            
            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(start);
                currentDate.setDate(start.getDate() + i);
                const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
                
                // Convert to Monday=0 format
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                if (templateDays.includes(adjustedDay)) {
                    matchingDays++;
                }
            }
            
            document.getElementById('summaryMatchingDays').textContent = matchingDays;
            
            // Estimate slots per day
            const startTime = new Date(`2000-01-01T${template.startTime}`);
            const endTime = new Date(`2000-01-01T${template.endTime}`);
            const durationMs = template.duration * 60 * 1000;
            
            let slotsPerDay = 0;
            let currentSlot = new Date(startTime);
            
            while (currentSlot.getTime() + durationMs <= endTime.getTime()) {
                slotsPerDay++;
                currentSlot.setTime(currentSlot.getTime() + durationMs);
            }
            
            const estimatedSlots = slotsPerDay * matchingDays;
            document.getElementById('summaryEstimatedSlots').textContent = 
                `${estimatedSlots} slot${estimatedSlots !== 1 ? 's' : ''}`;
            
        } else {
            summaryDiv.classList.add('hidden');
        }
    }
    
    // Add event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Date input listeners
        document.getElementById('id_start_date').addEventListener('change', function() {
            // Set end date min to start date
            document.getElementById('id_end_date').min = this.value;
            updateGenerateButton();
            updateGenerationSummary();
        });
        
        document.getElementById('id_end_date').addEventListener('change', function() {
            updateGenerateButton();
            updateGenerationSummary();
        });
        
        // Form submission
        document.getElementById('generateForm').addEventListener('submit', function(e) {
            // Validate template is selected
            if (!selectedTemplateId) {
                e.preventDefault();
                alert('Please select a template first.');
                return false;
            }
            
            // Validate dates
            const startDate = new Date(document.getElementById('id_start_date').value);
            const endDate = new Date(document.getElementById('id_end_date').value);
            
            if (endDate < startDate) {
                e.preventDefault();
                alert('End date must be after start date.');
                return false;
            }
            
            // Show loading overlay
            document.getElementById('loadingOverlay').classList.remove('hidden');
            return true;
        });
        
        // Bulk generation button
        document.getElementById('bulkGenerateBtn').addEventListener('click', function() {
            // Set dates to next 30 days
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setDate(today.getDate() + 30);
            
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            document.getElementById('id_start_date').value = formatDate(today);
            document.getElementById('id_end_date').value = formatDate(nextMonth);
            document.getElementById('id_end_date').min = formatDate(today);
            
            updateGenerateButton();
            updateGenerationSummary();
            
            // Scroll to date section
            document.getElementById('id_start_date').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        });
        
        // Auto-select first template if only one exists
        const templates = document.querySelectorAll('.template-card');
        if (templates.length === 1) {
            const firstTemplate = templates[0];
            const templateId = firstTemplate.id.replace('template-', '');
            selectTemplate(templateId);
        }
        
        // Set today as default start date
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.getElementById('id_start_date');
        if (!startDateInput.value) {
            startDateInput.value = today;
            startDateInput.min = today;
        }
        
        // Set default end date to 7 days from today
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        const nextWeekFormatted = nextWeek.toISOString().split('T')[0];
        const endDateInput = document.getElementById('id_end_date');
        if (!endDateInput.value) {
            endDateInput.value = nextWeekFormatted;
            endDateInput.min = today;
        }
    });
    
    // Function to calculate days between dates
    function daysBetween(date1, date2) {
        const oneDay = 24 * 60 * 60 * 1000;
        return Math.round(Math.abs((date1 - date2) / oneDay));
    }
</script>
{% endblock %}
