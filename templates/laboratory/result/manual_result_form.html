{% extends "laboratory/assets/base.html" %}
{% load static %}

{% block title %}Enter Result - {{ assignment.lab_test.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <!-- Header & Breadcrumbs -->
            <div class="mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'labs:test_assignment_list' %}">Assignments</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'labs:test_assignment_detail' result.id %}">
                                {{ assignment.request.request_id }}
                            </a>
                        </li>
                        <li class="breadcrumb-item active">Enter Result</li>
                    </ol>
                </nav>
                <h2><i class="bi bi-clipboard-data"></i> Enter Manual Result</h2>
            </div>

            <!-- Patient & Test Info Card -->
            <div class="card mb-4 border-info">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Patient Information</h6>
                            <p class="mb-1"><strong>Name:</strong> {{ assignment.request.patient.get_full_name }}</p>
                            <p class="mb-0"><strong>ID:</strong> {{ assignment.request.patient.patient_id }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Test Information</h6>
                            <p class="mb-1"><strong>Test:</strong> {{ assignment.lab_test.name }}</p>
                            <p class="mb-1"><strong>Code:</strong> <code>{{ assignment.lab_test.code }}</code></p>
                            <p class="mb-0">
                                <strong>Type:</strong>
                                <span class="badge bg-primary">
                                    {% if is_quantitative %}Quantitative (Numeric){% else %}Qualitative (Categorical){% endif %}
                                </span>
                            </p>
                        </div>
                    </div>

                    <!-- Sample & Instrument Info -->
                    <div class="mt-3 pt-3 border-top">
                        <p class="mb-1"><strong>Sample:</strong> {{ assignment.sample.sample_type }} 
                            <span class="badge bg-secondary ms-2">{{ assignment.sample.barcode }}</span>
                        </p>
                        {% if assignment.instrument %}
                        <p class="mb-0"><strong>Instrument:</strong> {{ assignment.instrument.name }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Result Entry Form -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square"></i> Result Entry
                        {% if existing_result %}
                            <span class="badge bg-warning ms-2">Updating Existing Result</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="resultForm">
                        {% csrf_token %}

                        <!-- Reference Range Display -->
                        {% if reference_range %}
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle"></i>
                            <strong>Reference Range:</strong> {{ reference_range }}
                            {% if is_quantitative and default_unit %}   ({{ default_unit }})
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Quantitative Result Entry -->
                        {% if is_quantitative %}
                        <div class="mb-4">
                            <label for="result_value" class="form-label"><strong>Result Value</strong> <span class="text-danger">*</span></label>
                            <div class="input-group input-group-lg">
                                <input type="text" 
                                       class="form-control" 
                                       id="result_value" 
                                       name="result_value" 
                                       placeholder="Enter numeric value"
                                       value="{% if existing_result %}{{ existing_result.result_value }}{% endif %}"
                                       pattern="[0-9]*\.?[0-9]+"
                                       inputmode="decimal"
                                       required
                                       autofocus>
                                <input type="text"
                                       class="form-control"
                                       id="unit"
                                       name="unit"
                                       placeholder="Unit"
                                       value="{% if existing_result %}{{ existing_result.units }}{% else %}{{ default_unit }}{% endif %}"
                                       style="max-width: 120px;">
                            </div>
                            <small class="text-muted">Examples: 14.5, 120, 0.85</small>

                            {% if existing_result %}
                            <div class="alert alert-warning mt-2 mb-0">
                                <i class="bi bi-exclamation-triangle"></i>
                                Previous value: <strong>{{ existing_result.result_value }} {{ existing_result.units }}</strong>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Qualitative Result Entry -->
                        {% else %}
                        {% if qualitative_options %}
                        <div class="mb-4">
                            <label class="form-label"><strong>Select Result</strong> <span class="text-danger">*</span></label>
                            <div class="btn-group-vertical w-100" role="group">
                                {% for option in qualitative_options %}
                                <input type="radio" 
                                       class="btn-check" 
                                       name="qualitative_option" 
                                       id="option_{{ option.id }}" 
                                       value="{{ option.id }}"
                                       {% if existing_result and existing_result.result_value == option.value %}checked{% endif %}
                                       {% if forloop.first and not existing_result %}checked{% endif %} 
                                       required>
                                <label class="btn btn-outline-primary text-start py-3" for="option_{{ option.id }}">
                                    <i class="bi bi-circle{% if option.is_normal %}-fill text-success{% endif %} me-2"></i>
                                    <strong>{{ option.value }}</strong>
                                    {% if option.is_normal %}
                                        <span class="badge bg-success ms-2">Normal</span>
                                    {% endif %}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <div class="mb-4">
                            <label for="result_value" class="form-label"><strong>Result</strong> <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg" 
                                   id="result_value" name="result_value" 
                                   placeholder="Enter result (e.g., Positive, Negative, Reactive)"
                                   value="{% if existing_result %}{{ existing_result.result_value }}{% endif %}" required autofocus>
                            <small class="text-muted">Common values: Positive, Negative, Reactive, Not detected</small>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Interpretation -->
                        <div class="mb-4">
                            <label for="interpretation" class="form-label"><strong>Clinical Interpretation</strong> (Optional)</label>
                            <textarea class="form-control" id="interpretation" name="interpretation" rows="3"
                                      placeholder="Add clinical interpretation...">{% if existing_result %}{{ existing_result.interpretation }}{% endif %}</textarea>
                        </div>

                        <!-- Remarks -->
                        <div class="mb-4">
                            <label for="remarks" class="form-label"><strong>Remarks</strong> (Optional)</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="2"
                                      placeholder="Any special observations...">{% if existing_result %}{{ existing_result.remarks }}{% endif %}</textarea>
                        </div>

                        <!-- Current User Info -->
                        <div class="alert alert-light border">
                            <small class="text-muted">
                                <i class="bi bi-person-badge"></i> Entered by: <strong>{{ request.user.get_full_name }}</strong><br>
                                <i class="bi bi-clock"></i> Time: <strong>{% now "Y-m-d H:i" %}</strong>
                            </small>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            {% comment %} <a href="{% url 'labs:test_assignment_detail' assignment.id %}" class="btn btn-secondary"> {% endcomment %}
                            <a href="{% url 'labs:test_assignment_detail' result.id %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="bi bi-save"></i> {% if existing_result %}Update{% else %}Save{% endif %} Result
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card mt-3 border-warning">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-lightbulb"></i> Important Notes</h6>
                    <ul class="mb-0 small">
                        <li>Double-check your entry before submitting</li>
                        <li>Results will be marked as <strong>Analyzed</strong> and require verification</li>
                        <li>You cannot modify results after they are verified</li>
                        <li>Contact your supervisor for any critical or unusual results</li>
                        {% if is_quantitative %}
                        <li>Ensure the correct unit is selected</li>
                        <li>System will auto-flag results outside reference range</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resultForm');
    const submitBtn = document.getElementById('submitBtn');

    // Disable double submit & validate numeric
    form.addEventListener('submit', function(e) {
        const resultValue = document.getElementById('result_value');
        {% if is_quantitative %}
        if (resultValue && resultValue.value) {
            const val = parseFloat(resultValue.value);
            if (isNaN(val)) {
                e.preventDefault();
                alert('Please enter a valid numeric value');
                resultValue.focus();
                return false;
            }
            {% if existing_result %}
            const oldVal = parseFloat('{{ existing_result.result_value }}');
            const percentChange = Math.abs((val - oldVal) / oldVal * 100);
            if (percentChange > 50) {
                if (!confirm(`Warning: Result changed by ${percentChange.toFixed(1)}% from previous value (${oldVal}). Continue?`)) {
                    e.preventDefault();
                    return false;
                }
            }
            {% endif %}
        }
        {% endif %}
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    });

    // Auto-focus quantitative input
    document.getElementById('result_value')?.focus();

    // Qualitative button styling
    document.querySelectorAll('.btn-check').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
            if (this.checked) this.nextElementSibling.classList.add('active');
        });
    });
});
</script>

<style>
.btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
.btn-outline-primary:hover {
    background-color: #e7f1ff;
    color: #0d6efd;
}
.input-group-lg .form-control { font-size: 1.5rem; font-weight: 600; }
@media (max-width: 768px) { .input-group-lg .form-control { font-size: 1.2rem; } }
</style>
{% endblock %}

