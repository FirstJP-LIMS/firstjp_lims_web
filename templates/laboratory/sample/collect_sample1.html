{% extends "laboratory/assets/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-vial fa-lg"></i>
                    </div>
                </div>
                <div>
                    <h1 class="h3 fw-bold mb-1">Specimen Collection</h1>
                    <div class="d-flex align-items-center">
                        <p class="text-muted mb-0 me-3">Request ID: <span class="badge bg-dark">{{ test_request.request_id }}</span></p>
                        <span class="badge bg-light border text-dark">
                            <i class="fas fa-clock me-1"></i> {{ test_request.created_at|date:"M d, Y" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted d-block">Collection Status</small>
                            <div class="d-flex align-items-center">
                                <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
                                <span class="fw-bold text-success">Ready for Collection</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Billing Status</small>
                            <span class="badge {% if billing.payment_status == 'PAID' %}bg-success{% elif billing.payment_status == 'AUTHORIZED' %}bg-info{% elif billing.payment_status == 'WAIVED' %}bg-warning{% else %}bg-danger{% endif %} fs-6 px-3 py-2">
                                {{ billing.get_payment_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Patient & Billing Info -->
        <div class="col-lg-4">
            <!-- Patient Profile Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-user-circle text-primary me-2"></i>Patient Profile
                    </h5>
                </div>
                <div class="card-body pt-0">
                    <div class="d-flex align-items-start mb-4">
                        <div class="flex-shrink-0">
                            <div class="bg-light text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-user fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h4 class="mb-1">{{ test_request.patient.first_name }} {{ test_request.patient.last_name }}</h4>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-id-card me-1"></i> {{ test_request.patient.patient_id }}
                                </span>
                                {% if test_request.patient.date_of_birth %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-birthday-cake me-1"></i> {{ test_request.patient.date_of_birth|timesince }}
                                </span>
                                {% endif %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-venus-mars me-1"></i> {{ test_request.patient.get_gender_display }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Contact Info -->
                    <div class="border-top pt-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Contact Information</h6>
                        {% if test_request.patient.phone_number %}
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-phone text-muted me-2" style="width: 20px;"></i>
                            <span>{{ test_request.patient.phone_number }}</span>
                        </div>
                        {% endif %}
                        {% if test_request.patient.email %}
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-envelope text-muted me-2" style="width: 20px;"></i>
                            <span>{{ test_request.patient.email }}</span>
                        </div>
                        {% endif %}
                        {% if test_request.patient.address %}
                        <div class="d-flex align-items-start">
                            <i class="fas fa-home text-muted me-2 mt-1" style="width: 20px;"></i>
                            <span class="small">{{ test_request.patient.address }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Billing Summary Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt text-success me-2"></i>Billing Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">Billing Type:</span>
                            <span class="badge bg-primary">{{ billing.get_billing_type_display }}</span>
                        </div>
                        {% if billing.billing_type == 'HMO' and billing.insurance_provider %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">Insurance Provider:</span>
                            <span class="fw-bold">{{ billing.insurance_provider.name }}</span>
                        </div>
                        {% if billing.policy_number %}
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Policy Number:</span>
                            <span class="fw-bold">{{ billing.policy_number }}</span>
                        </div>
                        {% endif %}
                        {% elif billing.billing_type == 'CORPORATE' and billing.corporate_client %}
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Corporate Client:</span>
                            <span class="fw-bold">{{ billing.corporate_client.name }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Total Amount:</span>
                            <span class="h5 fw-bold text-dark">₦{{ billing.total_amount|floatformat:2 }}</span>
                        </div>
                        {% if billing.billing_type == 'HMO' %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">Patient Portion:</span>
                            <span class="fw-bold">₦{{ billing.patient_portion|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Insurance Portion:</span>
                            <span class="fw-bold">₦{{ billing.insurance_portion|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        
                        <!-- Payment Details -->
                        <div class="mt-3 pt-3 border-top">
                            <small class="text-muted d-block mb-2">Payment Details:</small>
                            {% if billing.authorized_by %}
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-user-check text-info me-2"></i>
                                <small>Authorized by: {{ billing.authorized_by.get_full_name }}</small>
                            </div>
                            {% endif %}
                            {% if billing.authorization_reason %}
                            <div class="mt-2">
                                <small class="text-muted">Reason:</small>
                                <p class="small mb-0">{{ billing.authorization_reason|truncatechars:60 }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tests Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-flask text-info me-2"></i>Tests to Perform
                        </h5>
                        <span class="badge bg-info">{{ test_request.requested_tests.all|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for test in test_request.requested_tests.all %}
                        <div class="list-group-item border-0 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ test.test_name }}</h6>
                                    <small class="text-muted">{{ test.code }}</small>
                                    {% if test.category %}
                                    <span class="badge bg-light text-dark border ms-2">{{ test.category }}</span>
                                    {% endif %}
                                </div>
                                <span class="badge {% if test.sample_type == 'BLOOD' %}bg-danger{% elif test.sample_type == 'URINE' %}bg-warning{% elif test.sample_type == 'SWAB' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ test.sample_type }}
                                </span>
                            </div>
                            {% if test.turnaround_time %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i> {{ test.turnaround_time }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Collection Form -->
        <div class="col-lg-8">
            <!-- Collection Details Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clipboard-check text-success me-2"></i>Collection Details
                        </h5>
                        <div class="text-end">
                            <small class="text-muted d-block">Technician</small>
                            <span class="badge bg-light text-dark">{{ request.user.get_full_name }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Collection Guide Alert -->
                    <div class="alert alert-warning border-warning bg-light-warning mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-warning fa-lg mt-1"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-2">Collection Guidelines</h6>
                                <p class="small mb-2">Ensure you have gathered the appropriate containers before proceeding:</p>
                                <div class="mt-2">
                                    {% with sample_types=test_request.requested_tests.all|dictsort:"sample_type" %}
                                    {% for test in sample_types %}
                                    <span class="badge bg-warning-subtle text-warning border border-warning me-1 mb-1">
                                        <i class="fas fa-vial me-1"></i> {{ test.sample_type }}
                                    </span>
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collection Form -->
                    <form method="post" id="collectionForm">
                        {% csrf_token %}
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted mb-3">Specimen Information</h6>
                                        {{ form.specimen_type|as_crispy_field }}
                                        {{ form.collection_method|as_crispy_field }}
                                        {{ form.collection_site|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted mb-3">Collection Details</h6>
                                        {{ form.container_type|as_crispy_field }}
                                        {{ form.volume_collected_ml|as_crispy_field }}
                                        {{ form.fasting_status|as_crispy_field }}
                                        {{ form.location|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="card border mb-4">
                            <div class="card-body">
                                <h6 class="card-title text-muted mb-3">Additional Information</h6>
                                {{ form.specimen_description|as_crispy_field }}
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ form.collected_by|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="border-top pt-4">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'billing:billing_detail' billing.pk %}" class="btn btn-outline-secondary btn-lg px-4">
                                    <i class="fas fa-arrow-left me-2"></i> Back to Billing
                                </a>
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    <i class="fas fa-vial me-2"></i> Finalize Collection
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Stats Footer -->
            <div class="mt-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center py-3">
                                <h3 class="text-primary mb-0">{{ test_request.requested_tests.all|length }}</h3>
                                <small class="text-muted">Total Tests</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center py-3">
                                <h3 class="text-success mb-0">₦{{ billing.total_amount|floatformat:0 }}</h3>
                                <small class="text-muted">Total Amount</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center py-3">
                                <h3 class="text-info mb-0">
                                    {% with sample_types=test_request.requested_tests.all|dictsort:"sample_type" %}
                                    {{ sample_types|slice:":1"|first }}
                                    {% endwith %}
                                </h3>
                                <small class="text-muted">Primary Sample Type</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 10px;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,.05);
        padding: 1.25rem 1.5rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .list-group-item {
        border-left: 0;
        border-right: 0;
        border-color: rgba(0,0,0,.03);
    }
    
    .list-group-item:first-child {
        border-top: 0;
    }
    
    .list-group-item:last-child {
        border-bottom: 0;
    }
    
    .bg-light-warning {
        background-color: rgba(255, 193, 7, 0.1);
    }
    
    .bg-warning-subtle {
        background-color: #fff3cd;
    }
    
    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    
    /* Improve form field spacing */
    .form-group {
        margin-bottom: 1.25rem;
    }
    
    /* Custom styling for the submit button */
    .btn-success {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
        border-color: #198754;
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #157347 0%, #0d5c3a 100%);
        border-color: #146c43;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }
</style>
{% endblock %}