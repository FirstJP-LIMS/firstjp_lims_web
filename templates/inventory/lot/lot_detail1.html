{% extends "laboratory/assets/base.html" %}

{% block title %}Stock Lot - {{ lot.lot_number }}{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-left: 4px solid;
        padding: 15px;
        margin-bottom: 15px;
    }
    .stat-card.success { border-color: #28a745; }
    .stat-card.warning { border-color: #ffc107; }
    .stat-card.danger { border-color: #dc3545; }
    .stat-card.info { border-color: #17a2b8; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Stock Lot: {{ lot.lot_number }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                     <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'inventory:lot_list' %}">Stock Lots</a></li>
                    <li class="breadcrumb-item active">{{ lot.lot_number }}</li>
                    <li class="breadcrumb-item"><a href="{% url 'inventory:lot_mark_expired' %}">Mark as Expired</a></li>
                    <li class="breadcrumb-item active">{{ lot.lot_number }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-3">
        <div class="col-12">
            {% if user.is_vendor_staff %}
            <a href="{% url 'inventory:lot_update' lot.pk %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit Lot
            </a>
            {% endif %}
            
            {% if user.is_vendor_admin %}
            <button type="button" class="btn btn-danger" onclick="deleteLot({{ lot.pk }})">
                <i class="bi bi-trash"></i> Delete Lot
            </button>
            {% endif %}
            
            {% if lot.status == 'AVAILABLE' and lot.is_expired %}
            <button type="button" class="btn btn-warning" onclick="markExpired({{ lot.pk }})">
                <i class="bi bi-calendar-x"></i> Mark as Expired
            </button>
            {% endif %}
            
            <a href="{% url 'inventory:item_detail' lot.item.pk %}" class="btn btn-outline-primary">
                <i class="bi bi-box-seam"></i> View Item
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Lot Information -->
        <div class="col-md-4">
            <!-- Basic Info -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Lot Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <th width="40%">Item:</th>
                            <td>
                                <a href="{% url 'inventory:item_detail' lot.item.pk %}">
                                    <strong>{{ lot.item.item_code }}</strong>
                                </a>
                                <br>
                                <small>{{ lot.item.name }}</small>
                            </td>
                        </tr>
                        <tr>
                            <th>Lot Number:</th>
                            <td><strong>{{ lot.lot_number }}</strong></td>
                        </tr>
                        {% if lot.barcode %}
                        <tr>
                            <th>Barcode:</th>
                            <td><code>{{ lot.barcode }}</code></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Status:</th>
                            <td>
                                <span class="badge 
                                    {% if lot.status == 'AVAILABLE' %}bg-success
                                    {% elif lot.status == 'IN_USE' %}bg-primary
                                    {% elif lot.status == 'EXPIRED' %}bg-danger
                                    {% elif lot.status == 'DEPLETED' %}bg-secondary
                                    {% else %}bg-warning{% endif %}">
                                    {{ lot.get_status_display }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Dates -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Important Dates</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <th width="40%">Received:</th>
                            <td>{{ lot.received_date|date:"M d, Y" }}</td>
                        </tr>
                        {% if lot.manufacture_date %}
                        <tr>
                            <th>Manufactured:</th>
                            <td>{{ lot.manufacture_date|date:"M d, Y" }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Expiry:</th>
                            <td>
                                {{ lot.expiry_date|date:"M d, Y" }}
                                {% if days_until_expiry is not None %}
                                <br>
                                <small class="{% if days_until_expiry < 0 %}text-danger{% elif days_until_expiry <= 7 %}text-danger{% elif days_until_expiry <= 30 %}text-warning{% else %}text-muted{% endif %}">
                                    {% if days_until_expiry < 0 %}
                                        <i class="bi bi-exclamation-triangle"></i> Expired {{ days_until_expiry|abs }} days ago
                                    {% else %}
                                        <i class="bi bi-clock"></i> {{ days_until_expiry }} days remaining
                                    {% endif %}
                                </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% if lot.opened_date %}
                        <tr>
                            <th>Opened:</th>
                            <td>{{ lot.opened_date|date:"M d, Y" }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Purchase Info -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Purchase Information</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <th width="40%">Supplier:</th>
                            <td>{{ lot.supplier }}</td>
                        </tr>
                        {% if lot.purchase_order %}
                        <tr>
                            <th>PO Number:</th>
                            <td>{{ lot.purchase_order }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Unit Cost:</th>
                            <td>₦{{ lot.unit_cost }}</td>
                        </tr>
                        <tr>
                            <th>Total Cost:</th>
                            <td><strong>₦{{ lot.total_cost }}</strong></td>
                        </tr>
                        <tr>
                            <th>Received By:</th>
                            <td>{{ lot.received_by.get_full_name|default:lot.received_by.username }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Storage -->
            {% if lot.storage_location %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Storage Location</h6>
                </div>
                <div class="card-body">
                    <i class="bi bi-geo-alt"></i> {{ lot.storage_location }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Statistics and History -->
        <div class="col-md-8">
            <!-- Statistics -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="stat-card {% if percentage_remaining > 50 %}success{% elif percentage_remaining > 20 %}warning{% else %}danger{% endif %}">
                        <h6 class="text-muted mb-1">Quantity Remaining</h6>
                        <h3 class="mb-0">{{ lot.quantity_remaining }}</h3>
                        <small class="text-muted">of {{ lot.quantity_received }} {{ lot.item.unit_of_measure }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card info">
                        <h6 class="text-muted mb-1">Total Used</h6>
                        <h3 class="mb-0">{{ total_used|default:0 }}</h3>
                        <small class="text-muted">{{ lot.item.unit_of_measure }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card warning">
                        <h6 class="text-muted mb-1">Total Adjusted</h6>
                        <h3 class="mb-0">{{ total_adjusted|default:0 }}</h3>
                        <small class="text-muted">{{ lot.item.unit_of_measure }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card {% if percentage_remaining > 50 %}success{% elif percentage_remaining > 20 %}warning{% else %}danger{% endif %}">
                        <h6 class="text-muted mb-1">Remaining %</h6>
                        <h3 class="mb-0">{{ percentage_remaining|floatformat:0 }}%</h3>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" style="width: {{ percentage_remaining }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            {% if user.is_vendor_staff and lot.status == 'AVAILABLE' %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary w-100" 
                                    onclick="showQuickAdjust('add')">
                                <i class="bi bi-plus-circle"></i> Add Stock
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-warning w-100" 
                                    onclick="showQuickAdjust('remove')">
                                <i class="bi bi-dash-circle"></i> Remove Stock
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Usage by Type -->
            {% if usage_by_type %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Usage by Type</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for usage in usage_by_type %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ usage.usage_type }}</span>
                                <strong>{{ usage.total }} {{ lot.item.unit_of_measure }}</strong>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Usage History -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Usage History</h6>
                    <span class="badge bg-secondary">{{ usage_history.count }}</span>
                </div>
                <div class="card-body">
                    {% if usage_history %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Quantity</th>
                                    <th>Type</th>
                                    <th>User</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usage in usage_history %}
                                <tr>
                                    <td>{{ usage.used_at|date:"M d, Y H:i" }}</td>
                                    <td><strong>{{ usage.quantity_used }}</strong> {{ lot.item.unit_of_measure }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ usage.get_usage_type_display }}</span>
                                    </td>
                                    <td>{{ usage.used_by.username }}</td>
                                    <td>{{ usage.notes|truncatewords:10|default:"—" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No usage recorded yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Adjustments -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Stock Adjustments</h6>
                    <span class="badge bg-secondary">{{ adjustments.count }}</span>
                </div>
                <div class="card-body">
                    {% if adjustments %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Adjustment</th>
                                    <th>Reason</th>
                                    <th>User</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for adj in adjustments %}
                                <tr>
                                    <td>{{ adj.adjusted_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <span class="badge {% if adj.quantity_adjusted > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if adj.quantity_adjusted > 0 %}+{% endif %}{{ adj.quantity_adjusted }}
                                        </span>
                                    </td>
                                    <td>{{ adj.get_reason_display }}</td>
                                    <td>{{ adj.adjusted_by.username }}</td>
                                    <td>{{ adj.notes|truncatewords:10|default:"—" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No adjustments recorded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Adjust Modal -->
<div class="modal fade" id="quickAdjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustModalTitle">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickAdjustForm">
                    {% csrf_token %}
                    <input type="hidden" id="adjustmentType" name="adjustment_type">
                    
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="adjustQuantity" 
                               name="quantity" min="1" required>
                        <div class="form-text">Current: {{ lot.quantity_remaining }} {{ lot.item.unit_of_measure }}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" id="adjustReason" 
                                  name="reason" rows="2" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickAdjust()">
                    Adjust Stock
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Delete Lot
function deleteLot(lotId) {
    if (!confirm('Are you sure you want to delete this stock lot? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/inventory/lots/${lotId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = data.redirect_url;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the lot.');
    });
}

// Mark Expired
function markExpired(lotId) {
    if (!confirm('Mark this lot as expired?')) {
        return;
    }
    
    fetch(`/inventory/lots/${lotId}/mark-expired/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}

// Quick Adjust Modal
let adjustModal;
document.addEventListener('DOMContentLoaded', function() {
    adjustModal = new bootstrap.Modal(document.getElementById('quickAdjustModal'));
});

function showQuickAdjust(type) {
    document.getElementById('adjustmentType').value = type;
    document.getElementById('adjustModalTitle').textContent = 
        type === 'add' ? 'Add Stock' : 'Remove Stock';
    document.getElementById('quickAdjustForm').reset();
    adjustModal.show();
}

function submitQuickAdjust() {
    const form = document.getElementById('quickAdjustForm');
    const formData = new FormData(form);
    
    fetch(`/inventory/lots/{{ lot.pk }}/quick-adjust/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}
</script>
{% endblock %}