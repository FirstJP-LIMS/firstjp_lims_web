{% extends "learn/assets/base.html" %}

{% load widget_tweaks %}

{% block title %}Add Lesson - {{ module.title }} - LearnHub{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <div class="text-sm breadcrumbs">
            <ul>
                <li><a href="{% url 'facilitator_draft_list' %}" class="text-brand-red hover:text-red-700">My Drafts</a></li>
                <li><a href="{% url 'facilitator_draft_detail' module.course_draft.id %}" class="text-brand-red hover:text-red-700">{{ module.course_draft.title|truncatechars:30 }}</a></li>
                <li><a href="#" class="text-brand-red hover:text-red-700">{{ module.title|truncatechars:20 }}</a></li>
                <li class="text-navy font-semibold">Add Lesson</li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-navy mb-2">
                    <i class="fas fa-book-open mr-2"></i>Add New Lesson
                </h1>
                <p class="text-gray-600">Add a lesson to "{{ module.title }}" module</p>
            </div>
            <a href="{% url 'facilitator_media_upload' %}" class="btn btn-outline border-navy text-navy hover:bg-navy hover:text-white">
                <i class="fas fa-upload mr-2"></i> Upload Media
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="card bg-white shadow-lg border border-gray-200">
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                
                <!-- Form Errors -->
                {% if form.errors %}
                <div class="alert alert-error bg-red-50 border-l-4 border-brand-red mb-6">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-brand-red text-xl mr-3"></i>
                        <div>
                            <h3 class="font-bold text-red-800">Please correct the errors below</h3>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- Title -->
                        <div class="form-control">
                            <label class="label" for="{{ form.title.id_for_label }}">
                                <span class="label-text font-semibold text-navy">Lesson Title *</span>
                            </label>
                            {% render_field form.title class="input input-bordered w-full focus:ring-2 focus:ring-navy focus:border-navy" placeholder="e.g., Introduction to Variables" %}
                        </div>

                        <!-- Lesson Type -->
                        <div class="form-control">
                            <label class="label" for="{{ form.lesson_type.id_for_label }}">
                                <span class="label-text font-semibold text-navy">Lesson Type *</span>
                            </label>
                            {% render_field form.lesson_type class="select select-bordered w-full focus:ring-2 focus:ring-navy focus:border-navy" %}
                        </div>

                        <!-- Position -->
                        <div class="form-control">
                            <label class="label" for="{{ form.position.id_for_label }}">
                                <span class="label-text font-semibold text-navy">Position in Module</span>
                            </label>
                            {% render_field form.position class="input input-bordered w-full focus:ring-2 focus:ring-navy focus:border-navy" %}
                        </div>

                        <!-- Duration -->
                        <div class="form-control">
                            <label class="label" for="{{ form.duration_seconds.id_for_label }}">
                                <span class="label-text font-semibold text-navy">Duration (seconds)</span>
                            </label>
                            {% render_field form.duration_seconds class="input input-bordered w-full focus:ring-2 focus:ring-navy focus:border-navy" placeholder="e.g., 600 for 10 minutes" %}
                            <label class="label">
                                <span class="label-text-alt text-gray-500">Convert minutes to seconds (10 min = 600 sec)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Summary -->
                        <div class="form-control">
                            <label class="label" for="{{ form.summary.id_for_label }}">
                                <span class="label-text font-semibold text-navy">Lesson Summary</span>
                            </label>
                            {% render_field form.summary class="textarea textarea-bordered w-full focus:ring-2 focus:ring-navy focus:border-navy" rows="4" placeholder="Brief overview of what this lesson covers" %}
                        </div>

                        <!-- Media -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold text-navy">Attach Media</span>
                            </label>
                            <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-3">
                                {% for checkbox in form.media %}
                                <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    {{ checkbox.tag }}
                                    <div>
                                        <span class="text-gray-700">{{ checkbox.choice_label }}</span>
                                        <div class="text-xs text-gray-500">{{ checkbox.data.title.media_type }}</div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            <label class="label">
                                <span class="label-text-alt text-gray-500">Select media files to attach to this lesson</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Body (Full Width) -->
                <div class="mt-6">
                    <div class="form-control">
                        <label class="label" for="{{ form.body.id_for_label }}">
                            <span class="label-text font-semibold text-navy">Lesson Content *</span>
                        </label>
                        {% render_field form.body class="textarea textarea-bordered w-full focus:ring-2 focus:ring-navy focus:border-navy" rows="10" placeholder="Write your lesson content here. You can use Markdown formatting." %}
                        <label class="label">
                            <span class="label-text-alt text-gray-500">Supports Markdown formatting for rich content</span>
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between">
                    <a href="{% url 'facilitator_draft_detail' module.course_draft.id %}" class="btn btn-outline border-gray-300 text-gray-700 hover:bg-gray-50">
                        Cancel
                    </a>
                    <div class="space-x-3">
                        <button type="submit" class="btn bg-navy text-white hover:bg-navy hover:opacity-90">
                            <i class="fas fa-save mr-2"></i> Save Lesson
                        </button>
                        <button type="submit" name="add_another" class="btn bg-brand-red text-white hover:bg-red-700">
                            <i class="fas fa-plus-circle mr-2"></i> Save & Add Another
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Help -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="font-bold text-navy mb-3 flex items-center">
            <i class="fas fa-eye mr-2"></i> Content Preview Tips
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Markdown Formatting:</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li><code># Heading 1</code> - Large heading</li>
                    <li><code>## Heading 2</code> - Medium heading</li>
                    <li><code>**bold**</code> - <strong>bold text</strong></li>
                    <li><code>*italic*</code> - <em>italic text</em></li>
                    <li><code>[link](url)</code> - Hyperlinks</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Lesson Types:</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li><strong>Text</strong> - Written content with formatting</li>
                    <li><strong>Video</strong> - Video lessons with embedded media</li>
                    <li><strong>Quiz</strong> - Interactive quizzes and assessments</li>
                    <li><strong>Assignment</strong> - Practical exercises</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Auto-calculate duration in minutes
    const durationField = document.getElementById('{{ form.duration_seconds.id_for_label }}');
    if (durationField) {
        const durationHelp = document.createElement('div');
        durationHelp.className = 'text-sm text-gray-500 mt-1';
        durationField.parentNode.appendChild(durationHelp);
        
        function updateDurationHelp() {
            const seconds = parseInt(durationField.value) || 0;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            durationHelp.textContent = `Duration: ${minutes} min ${remainingSeconds} sec`;
        }
        
        durationField.addEventListener('input', updateDurationHelp);
        updateDurationHelp();
    }
    
    // Auto-calculate next position
    document.addEventListener('DOMContentLoaded', function() {
        const positionField = document.getElementById('{{ form.position.id_for_label }}');
        if (positionField && !positionField.value) {
            // In a real app, you would fetch the max position from the server
            positionField.value = {{ module.lessons.count|add:1 }};
        }
    });
</script>
{% endblock %}

{% endblock %}