{% extends 'laboratory/assets/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .review-type-card {
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        height: 100%;
    }
    .review-type-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
    }
    .review-type-card.selected {
        border-color: #007bff !important;
        border-width: 2px;
    }
    .form-card {
        border-top: 4px solid #007bff;
    }
    .assignee-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
    }
    .date-input-group .input-group-prepend {
        min-width: 140px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'documents:review_list' %}">Reviews</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
                </ol>
            </nav>
            
            <h2 class="mb-0">{{ title }}</h2>
            {% if document %}
            <p class="text-muted mb-0 mt-2">
                For document: <strong>{{ document.document_number }} - {{ document.title }}</strong>
            </p>
            {% endif %}
        </div>
        <div class="col-md-4 text-md-right mt-3 mt-md-0">
            <a href="{% if document %}{% url 'documents:document_detail' document.pk %}{% else %}{% url 'documents:review_list' %}{% endif %}" 
               class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left mr-2"></i>Cancel
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <!-- Main Form Card -->
            <div class="card shadow form-card mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-clipboard-check mr-2"></i>Review Assignment
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="reviewForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            {{ form.non_field_errors }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endif %}

                        <!-- Document Selection -->
                        <div class="form-group">
                            <label for="{{ form.document.id_for_label }}" class="form-label font-weight-bold">
                                Document to Review <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                </div>
                                {{ form.document }}
                            </div>
                            {% if form.document.errors %}
                                <div class="invalid-feedback d-block">{{ form.document.errors }}</div>
                            {% endif %}
                            {% if document %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Pre-selected document: {{ document.document_number }} v{{ document.version }}
                            </small>
                            {% else %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Select the document that requires review
                            </small>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <!-- Review Type Selection -->
                        <div class="form-group">
                            <label class="form-label font-weight-bold">
                                Review Type <span class="text-danger">*</span>
                            </label>
                            <div class="row">
                                {% for choice in form.review_type.field.choices %}
                                <div class="col-md-6 mb-3">
                                    <div class="card review-type-card border 
                                        {% if form.review_type.value == choice.0 %}selected border-primary{% else %}border-light{% endif %}"
                                         onclick="selectReviewType('{{ choice.0 }}')">
                                        <div class="card-body text-center p-3">
                                            <div class="mb-3">
                                                {% if choice.0 == 'initial' %}
                                                <i class="fas fa-flag fa-2x text-primary"></i>
                                                {% elif choice.0 == 'periodic' %}
                                                <i class="fas fa-calendar-alt fa-2x text-info"></i>
                                                {% elif choice.0 == 'change' %}
                                                <i class="fas fa-exchange-alt fa-2x text-warning"></i>
                                                {% elif choice.0 == 'audit' %}
                                                <i class="fas fa-search fa-2x text-danger"></i>
                                                {% endif %}
                                            </div>
                                            <h6 class="card-title mb-1">{{ choice.1 }}</h6>
                                            <p class="card-text small text-muted mb-0">
                                                {% if choice.0 == 'initial' %}
                                                First review of new document
                                                {% elif choice.0 == 'periodic' %}
                                                Scheduled periodic review
                                                {% elif choice.0 == 'change' %}
                                                Review after significant changes
                                                {% elif choice.0 == 'audit' %}
                                                Compliance or audit review
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {{ form.review_type }}
                            {% if form.review_type.errors %}
                                <div class="invalid-feedback d-block">{{ form.review_type.errors }}</div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <!-- Review Assignment -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.reviewer.id_for_label }}" class="form-label font-weight-bold">
                                        Reviewer <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-user-circle"></i></span>
                                        </div>
                                        {{ form.reviewer }}
                                    </div>
                                    {% if form.reviewer.errors %}
                                        <div class="invalid-feedback d-block">{{ form.reviewer.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Person responsible for conducting the review
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.approver.id_for_label }}" class="form-label font-weight-bold">
                                        Approver (Optional)
                                    </label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-user-check"></i></span>
                                        </div>
                                        {{ form.approver }}
                                    </div>
                                    {% if form.approver.errors %}
                                        <div class="invalid-feedback d-block">{{ form.approver.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Person responsible for final approval (optional)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Due Date -->
                        <div class="form-group">
                            <label for="{{ form.due_date.id_for_label }}" class="form-label font-weight-bold">
                                Due Date <span class="text-danger">*</span>
                            </label>
                            <div class="input-group date-input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar-day mr-2"></i>
                                        Review Due By
                                    </span>
                                </div>
                                {{ form.due_date }}
                            </div>
                            {% if form.due_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.due_date.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                When should this review be completed?
                                <span id="dueDateInfo" class="ml-2 text-info"></span>
                            </small>
                        </div>

                        <!-- Status -->
                        <div class="form-group">
                            <label for="{{ form.status.id_for_label }}" class="form-label font-weight-bold">
                                Initial Status
                            </label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-tasks"></i></span>
                                </div>
                                {{ form.status }}
                            </div>
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Set to "Pending Review" for new assignments
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Comments -->
                        <div class="form-group">
                            <label for="{{ form.comments.id_for_label }}" class="form-label font-weight-bold">
                                Instructions/Comments
                            </label>
                            {{ form.comments }}
                            {% if form.comments.errors %}
                                <div class="invalid-feedback d-block">{{ form.comments.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Optional instructions or context for the reviewer
                            </small>
                        </div>

                        <!-- Recommendations (Optional) -->
                        <div class="form-group mb-0">
                            <label for="{{ form.recommendations.id_for_label }}" class="form-label font-weight-bold">
                                Expected Recommendations
                            </label>
                            {{ form.recommendations }}
                            {% if form.recommendations.errors %}
                                <div class="invalid-feedback d-block">{{ form.recommendations.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                What kind of recommendations are you expecting? (optional)
                            </small>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-group mt-5 pt-4 border-top">
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary btn-lg px-4">
                                    <i class="fas fa-save mr-2"></i>Create Review Assignment
                                </button>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-info" onclick="previewAssignment()">
                                        <i class="fas fa-eye mr-2"></i>Preview
                                    </button>
                                    <a href="{% if document %}{% url 'documents:document_detail' document.pk %}{% else %}{% url 'documents:review_list' %}{% endif %}" 
                                       class="btn btn-outline-secondary btn-lg px-4">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Guide -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-light">
                    <h6 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-lightbulb mr-2"></i>Review Assignment Guide
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="mr-3">
                                    <i class="fas fa-calendar-alt text-primary fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Due Dates</h6>
                                    <p class="small text-muted mb-0">
                                        Set realistic due dates based on review complexity and document length.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="mr-3">
                                    <i class="fas fa-users text-success fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Assignments</h6>
                                    <p class="small text-muted mb-0">
                                        Assign reviewers with relevant expertise and approvers with authority.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="mr-3">
                                    <i class="fas fa-comments text-warning fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Instructions</h6>
                                    <p class="small text-muted mb-0">
                                        Provide clear instructions to ensure thorough and consistent reviews.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Preview (if document is selected) -->
            {% if document %}
            <div class="card shadow">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-file-alt mr-2"></i>Document Preview
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <th width="40%" class="text-muted">Document:</th>
                                        <td>{{ document.document_number }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">Title:</th>
                                        <td>{{ document.title }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">Version:</th>
                                        <td><span class="badge badge-info">v{{ document.version }}</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <th width="40%" class="text-muted">Status:</th>
                                        <td>
                                            <span class="badge 
                                                {% if document.status == 'effective' %}badge-success
                                                {% elif document.status == 'approved' %}badge-info
                                                {% elif document.status == 'obsolete' %}badge-dark
                                                {% else %}badge-secondary{% endif %}">
                                                {{ document.get_status_display }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">Owner:</th>
                                        <td>{{ document.owner.get_full_name|default:document.owner.username }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">Last Review:</th>
                                        <td>{{ document.next_review_date|date:"Y-m-d"|default:"Never" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <a href="{% url 'documents:document_detail' document.pk %}" class="btn btn-outline-primary btn-sm mr-2">
                            <i class="fas fa-eye mr-1"></i>View Full Details
                        </a>
                        <a href="{{ document.file.url }}" target="_blank" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download mr-1"></i>Download v{{ document.version }}
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Review type selection
    function selectReviewType(type) {
        document.getElementById('{{ form.review_type.auto_id }}').value = type;
        
        // Update card selection
        document.querySelectorAll('.review-type-card').forEach(card => {
            card.classList.remove('selected', 'border-primary');
        });
        
        // Add selected class to clicked card
        document.querySelectorAll('.review-type-card').forEach(card => {
            if (card.querySelector('i').classList.contains('fa-flag') && type === 'initial') {
                card.classList.add('selected', 'border-primary');
            } else if (card.querySelector('i').classList.contains('fa-calendar-alt') && type === 'periodic') {
                card.classList.add('selected', 'border-primary');
            } else if (card.querySelector('i').classList.contains('fa-exchange-alt') && type === 'change') {
                card.classList.add('selected', 'border-primary');
            } else if (card.querySelector('i').classList.contains('fa-search') && type === 'audit') {
                card.classList.add('selected', 'border-primary');
            }
        });
        
        // Update due date suggestion
        updateDueDateSuggestion();
    }
    
    // Calculate and display due date suggestion
    function updateDueDateSuggestion() {
        const reviewType = document.getElementById('{{ form.review_type.auto_id }}').value;
        const today = new Date();
        const dueDateInfo = document.getElementById('dueDateInfo');
        
        if (!reviewType) {
            dueDateInfo.textContent = '';
            return;
        }
        
        let suggestion = '';
        switch(reviewType) {
            case 'initial':
                suggestion = 'Suggested: 2-5 business days';
                break;
            case 'periodic':
                suggestion = 'Suggested: 10-14 business days';
                break;
            case 'change':
                suggestion = 'Suggested: 3-7 business days';
                break;
            case 'audit':
                suggestion = 'Suggested: 15-30 business days';
                break;
            default:
                suggestion = '';
        }
        
        dueDateInfo.textContent = suggestion;
    }
    
    // Due date input handling
    document.getElementById('{{ form.due_date.auto_id }}').addEventListener('change', function(e) {
        const selectedDate = new Date(e.target.value);
        const today = new Date();
        const timeDiff = selectedDate.getTime() - today.getTime();
        const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        const dueDateInfo = document.getElementById('dueDateInfo');
        if (dayDiff < 0) {
            dueDateInfo.innerHTML = '<span class="text-danger">Date is in the past</span>';
        } else if (dayDiff === 0) {
            dueDateInfo.textContent = 'Due today';
        } else if (dayDiff === 1) {
            dueDateInfo.textContent = 'Due tomorrow';
        } else if (dayDiff <= 7) {
            dueDateInfo.textContent = `Due in ${dayDiff} days`;
        } else if (dayDiff <= 30) {
            dueDateInfo.textContent = `Due in ${Math.ceil(dayDiff / 7)} weeks`;
        } else {
            dueDateInfo.textContent = `Due in ${Math.ceil(dayDiff / 30)} months`;
        }
    });
    
    // Initialize due date if set
    document.addEventListener('DOMContentLoaded', function() {
        const dueDateField = document.getElementById('{{ form.due_date.auto_id }}');
        if (dueDateField.value) {
            dueDateField.dispatchEvent(new Event('change'));
        }
        
        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        dueDateField.setAttribute('min', today);
        
        // Initialize review type selection if already set
        const initialType = document.getElementById('{{ form.review_type.auto_id }}').value;
        if (initialType) {
            selectReviewType(initialType);
        } else {
            // Set default to initial
            selectReviewType('initial');
        }
    });
    
    // Form preview
    function previewAssignment() {
        const documentSelect = document.getElementById('{{ form.document.auto_id }}');
        const selectedDocument = documentSelect.options[documentSelect.selectedIndex].text;
        const reviewType = document.getElementById('{{ form.review_type.auto_id }}').value;
        const reviewer = document.getElementById('{{ form.reviewer.auto_id }}').options[
            document.getElementById('{{ form.reviewer.auto_id }}').selectedIndex
        ].text;
        const dueDate = document.getElementById('{{ form.due_date.auto_id }}').value;
        
        let message = 'Review Assignment Preview:\n\n';
        message += `Document: ${selectedDocument}\n`;
        message += `Review Type: ${reviewType.charAt(0).toUpperCase() + reviewType.slice(1)}\n`;
        message += `Reviewer: ${reviewer}\n`;
        message += `Due Date: ${dueDate}\n\n`;
        message += 'Do you want to submit this review assignment?';
        
        if (confirm(message)) {
            document.getElementById('reviewForm').submit();
        }
    }
</script>
{% endblock %}