{% extends 'laboratory/assets/base.html' %}

{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .version-preview-card {
        border-left: 4px solid #007bff;
    }
    .current-version-card {
        border-left: 4px solid #28a745;
    }
    .change-type-major { border-left-color: #dc3545; }
    .change-type-minor { border-left-color: #ffc107; }
    .change-type-editorial { border-left-color: #6c757d; }
    .file-info-box {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 10px;
        border: 1px solid #dee2e6;
    }
    .version-badge {
        font-size: 0.9em;
        font-weight: 600;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'documents:document_detail' document.pk %}">{{ document.document_number }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Create New Version</li>
                </ol>
            </nav>
            
            <h2 class="mb-2">{{ title }}</h2>
            <p class="text-muted mb-0">Creating a new version for: <strong>{{ document.document_number }} - {{ document.title }}</strong></p>
        </div>
        <div class="col-md-4 text-md-right mt-3 mt-md-0">
            <a href="{% url 'documents:document_detail' document.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Document
            </a>
            <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#helpModal">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Main Form Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-code-branch mr-2"></i>New Version Details
                    </h6>
                    <span class="badge badge-light version-badge">Current: v{{ document.version }}</span>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="versionForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                {{ form.non_field_errors }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endif %}

                        <!-- Version Control Warning -->
                        <div class="alert alert-warning border-left-warning">
                            <div class="d-flex">
                                <div class="mr-3">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading">Important: Version Control Rules</h6>
                                    <ul class="mb-0 pl-3">
                                        <li>Creating a new version will <strong>archive the current version (v{{ document.version }})</strong></li>
                                        <li>The new version will become the <strong>active version</strong> immediately or on the effective date</li>
                                        <li>Archived versions remain accessible in the version history</li>
                                        <li>Version numbers must follow semantic versioning (e.g., 1.1, 2.0, 2.1)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Version Number Field -->
                        <div class="form-group">
                            <label for="{{ form.version_number.id_for_label }}" class="form-label font-weight-bold required-field">
                                New Version Number
                            </label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">v</span>
                                </div>
                                {{ form.version_number }}
                                <div class="input-group-append">
                                    <button class="btn btn-outline-info" type="button" id="suggestVersionBtn">
                                        <i class="fas fa-lightbulb"></i> Suggest
                                    </button>
                                </div>
                            </div>
                            {% if form.version_number.errors %}
                                <div class="invalid-feedback d-block">{{ form.version_number.errors }}</div>
                            {% endif %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Based on the change type you select, the system will suggest appropriate version numbers:
                                    <ul class="mb-0 pl-3 mt-1">
                                        <li><strong>Major:</strong> Increment first digit (e.g., 1.0 → 2.0)</li>
                                        <li><strong>Minor:</strong> Increment second digit (e.g., 1.0 → 1.1)</li>
                                        <li><strong>Editorial:</strong> Increment third digit (e.g., 1.0.0 → 1.0.1)</li>
                                    </ul>
                                </small>
                            </div>
                        </div>

                        <!-- Change Type with Visual Indicators -->
                        <div class="form-group">
                            <label for="{{ form.change_type.id_for_label }}" class="form-label font-weight-bold required-field">
                                Change Type
                            </label>
                            <div class="row">
                                {% for choice in form.change_type.field.choices %}
                                    <div class="col-md-4 mb-2">
                                        <div class="card h-100 change-type-{{ choice.0 }} {% if form.change_type.value == choice.0 %}border-primary{% endif %}" 
                                             style="cursor: pointer;" onclick="document.getElementById('{{ form.change_type.auto_id }}').value='{{ choice.0 }}'; highlightSelected(this);">
                                            <div class="card-body text-center p-3">
                                                <div class="mb-2">
                                                    {% if choice.0 == 'major' %}
                                                        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                                    {% elif choice.0 == 'minor' %}
                                                        <i class="fas fa-edit fa-2x text-warning"></i>
                                                    {% else %}
                                                        <i class="fas fa-spell-check fa-2x text-secondary"></i>
                                                    {% endif %}
                                                </div>
                                                <h6 class="card-title mb-1">{{ choice.1 }}</h6>
                                                <p class="card-text small text-muted mb-0">
                                                    {% if choice.0 == 'major' %}
                                                        Significant procedural changes
                                                    {% elif choice.0 == 'minor' %}
                                                        Minor updates, non-procedural
                                                    {% else %}
                                                        Typos, formatting, grammar
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {{ form.change_type }}
                            {% if form.change_type.errors %}
                                <div class="invalid-feedback d-block">{{ form.change_type.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Change Description -->
                        <div class="form-group">
                            <label for="{{ form.change_description.id_for_label }}" class="form-label font-weight-bold required-field">
                                Change Description / Rationale
                            </label>
                            {{ form.change_description }}
                            {% if form.change_description.errors %}
                                <div class="invalid-feedback d-block">{{ form.change_description.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-lightbulb mr-1"></i>
                                Be specific about what changed and why. This will appear in the version history and change log.
                                <br>
                                <strong>Example:</strong> "Updated step 4.2 to include new validation procedure per SOP-123. Added new section 5.3 for data retention policy."
                            </small>
                        </div>

                        <!-- File Upload with Preview -->
                        <div class="form-group">
                            <label for="{{ form.file.id_for_label }}" class="form-label font-weight-bold required-field">
                                New Document File
                            </label>
                            <div class="custom-file">
                                {{ form.file }}
                                <label class="custom-file-label" for="{{ form.file.id_for_label }}" id="fileLabel">
                                    Choose file...
                                </label>
                            </div>
                            {% if form.file.errors %}
                                <div class="invalid-feedback d-block">{{ form.file.errors }}</div>
                            {% endif %}
                            
                            <!-- File Preview/Info -->
                            <div id="fileInfo" class="file-info-box mt-3 d-none">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file mr-2"></i>
                                        <span id="fileName"></span>
                                        <span id="fileSize" class="text-muted ml-2"></span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Accepted formats: PDF, DOCX, XLSX, TXT (Max 25MB). 
                                <strong>Tip:</strong> Ensure the document number and version in the file match the values above.
                            </small>
                        </div>

                        <!-- Effective Date with Calendar -->
                        <div class="form-group">
                            <label for="{{ form.effective_date.id_for_label }}" class="form-label font-weight-bold">
                                Effective Date
                            </label>
                            <div class="input-group date" id="effectiveDatePicker" data-target-input="nearest">
                                {{ form.effective_date }}
                                <div class="input-group-append" data-target="#effectiveDatePicker" data-toggle="datetimepicker">
                                    <div class="input-group-text">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                </div>
                            </div>
                            {% if form.effective_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.effective_date.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-clock mr-1"></i>
                                This version will become active on this date. Leave blank for immediate effect.
                                Cannot be earlier than today.
                            </small>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-group mt-5 pt-4 border-top">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary btn-lg px-4">
                                        <i class="fas fa-save mr-2"></i>Create New Version
                                    </button>
                                    <a href="{% url 'documents:document_detail' document.pk %}" class="btn btn-outline-secondary btn-lg px-4">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </a>
                                </div>
                                <button type="button" class="btn btn-outline-info" onclick="previewSubmission()">
                                    <i class="fas fa-eye mr-2"></i>Preview
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar Information -->
        <div class="col-lg-4">
            <!-- Current Version Card -->
            <div class="card shadow current-version-card mb-4">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-file-alt mr-2"></i>Current Version
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="badge badge-success badge-pill px-3 py-2 version-badge">
                            v{{ document.version }}
                        </span>
                        <p class="text-muted small mt-1 mb-0">Active Version</p>
                    </div>
                    
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            <tr>
                                <th width="40%" class="text-muted">Document:</th>
                                <td>{{ document.document_number }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Title:</th>
                                <td>{{ document.title }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Status:</th>
                                <td>
                                    {% if document.status == 'effective' %}
                                        <span class="badge badge-success">{{ document.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ document.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Owner:</th>
                                <td>{{ document.owner.get_full_name }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Last Updated:</th>
                                <td>{{ document.updated_at|date:"M d, Y H:i" }}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="mt-3 pt-3 border-top">
                        <a href="{{ document.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm btn-block">
                            <i class="fas fa-download mr-2"></i>Download Current Version
                        </a>
                    </div>
                </div>
            </div>

            <!-- Version History Summary -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-history mr-2"></i>Version History Summary
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        This document has {{ document.versions.count }} previous version(s).
                    </p>
                    
                    {% if document.versions.exists %}
                    <div class="list-group list-group-flush">
                        {% for version in document.versions.all|slice:":3" %}
                        <div class="list-group-item px-0 py-2 border-0">
                            <div class="d-flex w-100 justify-content-between">
                                <span class="badge badge-secondary">{{ version.version_number }}</span>
                                <small class="text-muted">{{ version.created_at|date:"Y-m-d" }}</small>
                            </div>
                            <p class="mb-1 small">{{ version.change_description|truncatechars:60 }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if document.versions.count > 3 %}
                    <div class="text-center mt-2">
                        <a href="{% url 'documents:version_history' document.pk %}" class="btn btn-sm btn-outline-info">
                            View All {{ document.versions.count }} Versions
                        </a>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-history fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No previous versions</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card shadow">
                <div class="card-header py-3 bg-light">
                    <h6 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-lightbulb mr-2"></i>Quick Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0 small">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Always review the current version before creating a new one
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Use descriptive change descriptions for audit trails
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Set future effective dates for scheduled updates
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Notify relevant stakeholders after version creation
                        </li>
                        <li>
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Archive superseded versions remain accessible
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="helpModalLabel">
                    <i class="fas fa-question-circle mr-2"></i>Creating Document Versions
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6>About Version Control</h6>
                <p>Version control ensures document integrity and provides an audit trail of all changes made to documents over time.</p>
                
                <h6 class="mt-4">Change Types Explained</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>When to Use</th>
                                <th>Version Increment</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge badge-danger">Major</span></td>
                                <td>Procedural changes, new requirements, significant content updates</td>
                                <td>X.0 → (X+1).0</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-warning">Minor</span></td>
                                <td>Clarifications, additional information, non-procedural updates</td>
                                <td>X.Y → X.(Y+1)</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-secondary">Editorial</span></td>
                                <td>Grammar, spelling, formatting, typos</td>
                                <td>X.Y.Z → X.Y.(Z+1)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6 class="mt-4">Best Practices</h6>
                <ul>
                    <li>Always include detailed change descriptions for audit purposes</li>
                    <li>Use effective dates for future-dated implementations</li>
                    <li>Ensure the uploaded file has the correct version number in its content</li>
                    <li>Review the version history before creating new versions</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // File upload preview
    document.getElementById('{{ form.file.auto_id }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileLabel = document.getElementById('fileLabel');
        
        if (file) {
            fileLabel.textContent = file.name;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('d-none');
        }
    });

    function clearFile() {
        const fileInput = document.getElementById('{{ form.file.auto_id }}');
        const fileInfo = document.getElementById('fileInfo');
        const fileLabel = document.getElementById('fileLabel');
        
        fileInput.value = '';
        fileLabel.textContent = 'Choose file...';
        fileInfo.classList.add('d-none');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Change type selection highlighting
    function highlightSelected(card) {
        // Remove border-primary from all cards
        document.querySelectorAll('.card[onclick*="highlightSelected"]').forEach(function(el) {
            el.classList.remove('border-primary');
        });
        // Add border-primary to selected card
        card.classList.add('border-primary');
    }

    // Version suggestion based on change type
    document.getElementById('suggestVersionBtn').addEventListener('click', function() {
        const currentVersion = '{{ document.version }}';
        const changeType = document.getElementById('{{ form.change_type.auto_id }}').value;
        const versionInput = document.getElementById('{{ form.version_number.auto_id }}');
        
        if (!changeType) {
            alert('Please select a change type first');
            return;
        }
        
        const parts = currentVersion.split('.').map(Number);
        
        if (changeType === 'major') {
            parts[0] += 1;
            parts[1] = 0;
            if (parts.length > 2) parts[2] = 0;
        } else if (changeType === 'minor') {
            parts[1] = (parts[1] || 0) + 1;
            if (parts.length > 2) parts[2] = 0;
        } else if (changeType === 'editorial') {
            if (parts.length < 3) parts.push(1);
            else parts[2] += 1;
        }
        
        versionInput.value = parts.join('.');
    });

    // Initialize date picker
    $(document).ready(function() {
        $('#effectiveDatePicker').datetimepicker({
            format: 'YYYY-MM-DD',
            minDate: moment(),
            icons: {
                time: 'fas fa-clock',
                date: 'fas fa-calendar',
                up: 'fas fa-chevron-up',
                down: 'fas fa-chevron-down',
                previous: 'fas fa-chevron-left',
                next: 'fas fa-chevron-right',
                today: 'fas fa-calendar-check',
                clear: 'fas fa-trash'
            }
        });
    });

    // Form preview
    function previewSubmission() {
        // Basic validation before preview
        const versionNumber = document.getElementById('{{ form.version_number.auto_id }}').value;
        const changeType = document.getElementById('{{ form.change_type.auto_id }}').value;
        const changeDesc = document.getElementById('{{ form.change_description.auto_id }}').value;
        
        let message = 'Preview of New Version Submission:\n\n';
        message += `New Version: v${versionNumber}\n`;
        message += `Change Type: ${changeType}\n`;
        message += `Change Description: ${changeDesc.substring(0, 100)}${changeDesc.length > 100 ? '...' : ''}\n\n`;
        message += 'Are you ready to submit?';
        
        if (confirm(message)) {
            document.getElementById('versionForm').submit();
        }
    }

    // Initialize change type cards if value exists
    document.addEventListener('DOMContentLoaded', function() {
        const changeTypeValue = document.getElementById('{{ form.change_type.auto_id }}').value;
        if (changeTypeValue) {
            document.querySelectorAll('.card[onclick*="highlightSelected"]').forEach(function(card) {
                if (card.classList.contains(`change-type-${changeTypeValue}`)) {
                    card.classList.add('border-primary');
                }
            });
        }
    });
</script>
{% endblock %}