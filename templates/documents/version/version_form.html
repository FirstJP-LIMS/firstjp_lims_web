{% extends 'laboratory/assets/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row align-items-center mb-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h3 mb-2" style="color: var(--primary-color);">
                        <i class="fas fa-code-branch me-2"></i>
                        Create New Version
                    </h2>
                    <p class="text-muted mb-0">
                        For document: <strong>{{ document.document_number }} - {{ document.title|truncatechars:50 }}</strong>
                    </p>
                </div>
                <div>
                    <a href="{% url 'documents:document_detail' document.pk %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Version Control Warning -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="alert-heading mb-2">Important: Version Control Rules</h5>
                        <ul class="mb-0 ps-3">
                            <li>Creating a new version will <strong>archive the current version (v{{ document.version }})</strong></li>
                            <li>The new version will become the <strong>active version</strong> immediately or on the effective date</li>
                            <li>Archived versions remain accessible in the version history</li>
                            <li>Version numbers must follow semantic versioning (e.g., 1.1, 2.0, 2.1)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Form Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>New Version Details
                        <span class="badge bg-info float-end">Current: v{{ document.version }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="versionForm">
                        {% csrf_token %}
                        
                        <!-- Form Errors -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Version Number -->
                        <div class="card mb-4 border">
                            <div class="card-header bg-light border-bottom">
                                <h6 class="mb-0">
                                    <i class="fas fa-hashtag me-2"></i>Version Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="{{ form.version_number.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-code-branch me-1"></i> New Version Number *
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">v</span>
                                            {{ form.version_number }}
                                            <button class="btn btn-outline-info" type="button" id="suggestVersionBtn">
                                                <i class="fas fa-lightbulb"></i> Suggest
                                            </button>
                                        </div>
                                        {% if form.version_number.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.version_number.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="form-text">
                                            Based on the change type you select, the system will suggest appropriate version numbers
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="{{ form.change_type.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-exchange-alt me-1"></i> Change Type *
                                        </label>
                                        {{ form.change_type }}
                                        {% if form.change_type.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.change_type.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Change Description -->
                        <div class="card mb-4 border">
                            <div class="card-header bg-light border-bottom">
                                <h6 class="mb-0">
                                    <i class="fas fa-comment-alt me-2"></i>Change Description
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="{{ form.change_description.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-align-left me-1"></i> Change Description / Rationale *
                                        </label>
                                        {{ form.change_description }}
                                        {% if form.change_description.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.change_description.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="form-text">
                                            Be specific about what changed and why. Example: "Updated step 4.2 to include new validation procedure per SOP-123"
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Document File -->
                        <div class="card mb-4 border">
                            <div class="card-header bg-light border-bottom">
                                <h6 class="mb-0">
                                    <i class="fas fa-paperclip me-2"></i>Document File
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="{{ form.file.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-upload me-1"></i> New Document File *
                                        </label>
                                        <div class="file-upload-area">
                                            <label for="{{ form.file.id_for_label }}" class="btn btn-outline-primary w-100">
                                                <i class="fas fa-upload me-1"></i> Choose File
                                            </label>
                                            {{ form.file }}
                                            <div id="fileInfo" class="mt-2 d-none">
                                                <small class="text-muted" id="fileName"></small>
                                                <small class="text-muted ms-2" id="fileSize"></small>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearFile()">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% if form.file.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.file.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="form-text">PDF, DOCX, XLSX, TXT (Max 25MB)</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Effective Date -->
                        <div class="card mb-4 border">
                            <div class="card-header bg-light border-bottom">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-alt me-2"></i>Timeline
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="{{ form.effective_date.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-calendar-check me-1"></i> Effective Date
                                        </label>
                                        <div class="input-group">
                                            {{ form.effective_date }}
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar text-muted"></i>
                                            </span>
                                        </div>
                                        {% if form.effective_date.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.effective_date.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="form-text">
                                            This version will become active on this date. Leave blank for immediate effect.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-5 pt-4 border-top">
                            <a href="{% url 'documents:document_detail' document.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-info" onclick="previewSubmission()">
                                    <i class="fas fa-eye me-1"></i> Preview
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="fas fa-save me-1"></i> Create New Version
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Current Version -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Current Version
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="badge bg-success badge-pill px-3 py-2">
                            v{{ document.version }}
                        </span>
                        <p class="text-muted small mt-1 mb-0">Active Version</p>
                    </div>
                    
                    <table class="table table-sm table-borderless mb-3">
                        <tbody>
                            <tr>
                                <th width="40%" class="text-muted">Document:</th>
                                <td>{{ document.document_number }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Title:</th>
                                <td>{{ document.title|truncatechars:40 }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Status:</th>
                                <td>
                                    <span class="badge 
                                        {% if document.status == 'effective' %}bg-success
                                        {% elif document.status == 'approved' %}bg-info
                                        {% elif document.status == 'obsolete' %}bg-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ document.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Last Updated:</th>
                                <td>{{ document.updated_at|date:"M d, Y" }}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ document.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download me-1"></i>Download Current Version
                        </a>
                    </div>
                </div>
            </div>

            <!-- Version History -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Version History
                    </h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        This document has {{ document.versions.count }} previous version(s).
                    </p>
                    
                    {% if document.versions.exists %}
                    <div class="d-flex flex-column gap-2">
                        {% for version in document.versions.all|slice:":3" %}
                        <div class="d-flex justify-content-between align-items-start border-bottom pb-2">
                            <div>
                                <span class="badge bg-secondary">{{ version.version_number }}</span>
                                <p class="small text-muted mb-0 mt-1">{{ version.change_description|truncatechars:50 }}</p>
                            </div>
                            <small class="text-muted">{{ version.created_at|date:"Y-m-d" }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if document.versions.count > 3 %}
                    <div class="text-center mt-3">
                        <a href="{% url 'documents:version_history' document.pk %}" class="btn btn-outline-info btn-sm">
                            View All {{ document.versions.count }} Versions
                        </a>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-history fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No previous versions</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Quick Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <div>
                                <small class="text-muted">Always review the current version before creating a new one</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <div>
                                <small class="text-muted">Use descriptive change descriptions for audit trails</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <div>
                                <small class="text-muted">Set future effective dates for scheduled updates</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <div>
                                <small class="text-muted">Notify relevant stakeholders after version creation</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .card {
        border-radius: var(--border-radius);
        transition: var(--transition);
        border: 1px solid #e9ecef;
    }
    
    .form-control, .form-select {
        border-radius: var(--border-radius);
        border: 1px solid #ced4da;
        transition: var(--transition);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(44, 90, 160, 0.25);
    }
    
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }
    
    .input-group-text {
        background-color: var(--light-bg);
        border: 1px solid #ced4da;
    }
    
    .file-upload-area {
        position: relative;
        border: 2px dashed #dee2e6;
        border-radius: var(--border-radius);
        padding: 1rem;
        text-align: center;
        transition: var(--transition);
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background-color: rgba(44, 90, 160, 0.02);
    }
    
    .file-upload-area input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .card-body .row > .col-md-6,
        .card-body .row > .col-md-8,
        .card-body .row > .col-md-4,
        .card-body .row > .col-md-12 {
            margin-bottom: 1rem;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 1rem;
        }
        
        .d-flex.justify-content-between .btn {
            width: 100%;
        }
        
        .d-flex.gap-2 {
            flex-direction: column;
            gap: 0.5rem !important;
        }
    }
</style>

<script>
    // File upload preview
    document.getElementById('{{ form.file.auto_id }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('d-none');
        }
    });

    function clearFile() {
        const fileInput = document.getElementById('{{ form.file.auto_id }}');
        const fileInfo = document.getElementById('fileInfo');
        
        fileInput.value = '';
        fileInfo.classList.add('d-none');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Version suggestion based on change type
    document.getElementById('suggestVersionBtn').addEventListener('click', function() {
        const currentVersion = '{{ document.version }}';
        const changeType = document.getElementById('{{ form.change_type.auto_id }}').value;
        const versionInput = document.getElementById('{{ form.version_number.auto_id }}');
        
        if (!changeType) {
            alert('Please select a change type first');
            return;
        }
        
        const parts = currentVersion.split('.').map(Number);
        
        if (changeType === 'major') {
            parts[0] += 1;
            parts[1] = 0;
            if (parts.length > 2) parts[2] = 0;
        } else if (changeType === 'minor') {
            parts[1] = (parts[1] || 0) + 1;
            if (parts.length > 2) parts[2] = 0;
        } else if (changeType === 'editorial') {
            if (parts.length < 3) parts.push(1);
            else parts[2] += 1;
        }
        
        versionInput.value = parts.join('.');
    });

    // Set minimum date to today for effective date
    document.addEventListener('DOMContentLoaded', function() {
        const effectiveDateField = document.getElementById('{{ form.effective_date.auto_id }}');
        if (effectiveDateField) {
            const today = new Date().toISOString().split('T')[0];
            effectiveDateField.setAttribute('min', today);
        }
    });

    // Form preview
    function previewSubmission() {
        const versionNumber = document.getElementById('{{ form.version_number.auto_id }}').value;
        const changeType = document.getElementById('{{ form.change_type.auto_id }}').value;
        const changeDesc = document.getElementById('{{ form.change_description.auto_id }}').value;
        
        let message = 'New Version Preview:\n\n';
        message += `Document: ${document.document_number}\n`;
        message += `New Version: v${versionNumber}\n`;
        message += `Change Type: ${changeType}\n`;
        message += `Change Description: ${changeDesc.substring(0, 100)}${changeDesc.length > 100 ? '...' : ''}\n\n`;
        message += 'Do you want to create this new version?';
        
        if (confirm(message)) {
            document.getElementById('versionForm').submit();
        }
    }
</script>
{% endblock %}