{% extends "clinician/assets/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex">
    <!-- Sidebar -->
    {% include 'clinician/assets/sidebar.html' %}

    <!-- Main Content -->
    <main class="flex-1 md:ml-64">
        <!-- Mobile Header Spacer -->
        <div class="md:hidden h-16"></div>

        <div class="p-6">
            <!-- Header with Action Buttons -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <a href="{% url 'clinician:patient_detail' test_request.patient.patient_id %}" 
                               class="btn btn-sm btn-ghost">
                                <i class="fas fa-arrow-left mr-1"></i> Back to Patient
                            </a>
                            <span class="badge badge-{{ test_request.status|lower }}">
                                {{ test_request.get_status_display }}
                            </span>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900">Test Request: {{ test_request.request_id }}</h1>
                        <p class="text-gray-600 mt-1">
                            Ordered {{ test_request.created_at|timesince }} ago • 
                            {% if test_request.collected_at %}
                                Collected {{ test_request.collected_at|timesince }} ago
                            {% else %}
                                Not yet collected
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        {% if test_request.status == 'pending' %}
                        <button onclick="collectSample()" class="btn btn-primary">
                            <i class="fas fa-syringe mr-2"></i> Mark as Collected
                        </button>
                        {% endif %}
                        
                        <a href="#" class="btn btn-outline">
                            <i class="fas fa-print mr-2"></i> Print Requisition
                        </a>
                        
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-ghost">
                                <i class="fas fa-ellipsis-v"></i>
                            </label>
                            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li><a href="#"><i class="fas fa-edit mr-2"></i> Edit Request</a></li>
                                {% if test_request.status != 'cancelled' %}
                                <li><a onclick="cancelRequest()" class="text-red-600"><i class="fas fa-times-circle mr-2"></i> Cancel Request</a></li>
                                {% endif %}
                                <li><a href="#"><i class="fas fa-copy mr-2"></i> Duplicate Order</a></li>
                                <li><a href="#"><i class="fas fa-download mr-2"></i> Export Results</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Patient & Order Info -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Patient Info Card -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900">Patient Information</h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="flex items-start gap-4">
                                <div class="bg-primary/10 p-3 rounded-full">
                                    <i class="fas fa-user text-primary text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3">
                                        <div>
                                            <h4 class="text-lg font-semibold text-gray-900">
                                                {{ test_request.patient.first_name }} {{ test_request.patient.last_name }}
                                            </h4>
                                            <div class="flex items-center gap-3 mt-1">
                                                <span class="text-sm text-gray-600">
                                                    <i class="fas fa-id-card mr-1"></i> {{ test_request.patient.patient_id }}
                                                </span>
                                                <span class="text-sm text-gray-600">
                                                    <i class="fas fa-venus-mars mr-1"></i> {{ test_request.patient.get_gender_display }}
                                                </span>
                                                {% if test_request.patient.date_of_birth %}
                                                <span class="text-sm text-gray-600">
                                                    <i class="fas fa-birthday-cake mr-1"></i> 
                                                    {{ test_request.patient.date_of_birth|date:"Y-m-d" }}
                                                    ({{ test_request.patient.age }})
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <a href="{% url 'clinician:patient_detail' test_request.patient.patient_id %}" 
                                           class="btn btn-sm btn-outline">
                                            View Patient Profile
                                        </a>
                                    </div>
                                    
                                    <!-- Contact Info -->
                                    {% if test_request.patient.contact_phone or test_request.patient.contact_email %}
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        {% if test_request.patient.contact_phone %}
                                        <div class="flex items-center gap-3">
                                            <div class="bg-gray-100 p-2 rounded-full">
                                                <i class="fas fa-phone text-gray-600"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-600">Phone</p>
                                                <p class="font-medium">{{ test_request.patient.contact_phone }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if test_request.patient.contact_email %}
                                        <div class="flex items-center gap-3">
                                            <div class="bg-gray-100 p-2 rounded-full">
                                                <i class="fas fa-envelope text-gray-600"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-600">Email</p>
                                                <p class="font-medium">{{ test_request.patient.contact_email }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tests List Card -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-900">Requested Tests</h3>
                                <span class="badge badge-lg">
                                    {{ test_request.requested_tests.count }} tests
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="overflow-x-auto">
                                <table class="table table-zebra">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="font-medium text-gray-700">Test Name</th>
                                            <th class="font-medium text-gray-700">Code</th>
                                            <th class="font-medium text-gray-700">Department</th>
                                            <th class="font-medium text-gray-700">Status</th>
                                            <th class="font-medium text-gray-700">Price</th>
                                            <th class="font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for test in test_request.requested_tests.all %}
                                        <tr>
                                            <td>
                                                <div class="font-medium text-gray-900">{{ test.name }}</div>
                                                {% if test.specimen_type %}
                                                <div class="text-sm text-gray-500">
                                                    <i class="fas fa-flask mr-1"></i> {{ test.specimen_type }}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td class="font-mono">{{ test.code }}</td>
                                            <td>
                                                <span class="badge badge-outline">
                                                    {{ test.assigned_department.name }}
                                                </span>
                                            </td>
                                            <td>
                                                {% with test_result=test_request.test_results.filter|test=test|first %}
                                                {% if test_result %}
                                                    <span class="badge badge-{{ test_result.status|lower }}">
                                                        {{ test_result.get_status_display }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-warning">
                                                        Not Started
                                                    </span>
                                                {% endif %}
                                                {% endwith %}
                                            </td>
                                            <td class="font-semibold">₦{{ test.price|floatformat:2|intcomma }}</td>
                                            <td>
                                                <a href="{% url 'clinician:test_detail' test.id %}" 
                                                   class="btn btn-xs btn-ghost">
                                                    <i class="fas fa-info-circle"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-gray-500">
                                                <i class="fas fa-flask text-gray-300 text-3xl mb-3"></i>
                                                <p>No tests found in this request</p>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-gray-50">
                                            <td colspan="4" class="font-semibold text-right">Total:</td>
                                            <td class="font-bold text-lg text-primary">
                                                ₦{{ test_request.calculate_total|default:"0.00"|intcomma }}
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Clinical Information Card -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900">Clinical Information</h3>
                        </div>
                        <div class="card-body p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Clinical Indication
                                </label>
                                <div class="p-3 bg-gray-50 rounded border border-gray-200">
                                    {{ test_request.clinical_indication|default:"Not specified"|linebreaks }}
                                </div>
                            </div>
                            
                            {% if test_request.special_instructions %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Special Instructions
                                </label>
                                <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                                    <i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i>
                                    {{ test_request.special_instructions|linebreaks }}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Priority
                                    </label>
                                    <span class="badge badge-{{ test_request.priority|lower }}">
                                        {{ test_request.get_priority_display }}
                                    </span>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Urgency
                                    </label>
                                    <span class="badge badge-outline">
                                        {{ test_request.get_urgency_display|default:"Routine" }}
                                    </span>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Collection Method
                                    </label>
                                    <span>
                                        {{ test_request.get_collection_method_display|default:"Not specified" }}
                                    </span>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Insurance Provider
                                    </label>
                                    <span>
                                        {{ test_request.insurance_provider|default:"Self-pay" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Preview (if available) -->
                    {% if test_request.test_results.exists %}
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-900">Results Preview</h3>
                                {% if test_request.status == 'completed' %}
                                <a href="#" class="btn btn-sm btn-primary">
                                    <i class="fas fa-download mr-2"></i> Download Full Report
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body p-4">
                            {% for result in test_request.test_results.all|slice:":3" %}
                            <div class="border border-gray-200 rounded-lg p-4 mb-3 last:mb-0">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-medium text-gray-900">{{ result.test.name }}</h4>
                                        <p class="text-sm text-gray-500">{{ result.test.code }}</p>
                                    </div>
                                    <span class="badge badge-{{ result.status|lower }}">
                                        {{ result.get_status_display }}
                                    </span>
                                </div>
                                
                                {% if result.value %}
                                <div class="mt-3">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <span class="text-lg font-bold">{{ result.value }}</span>
                                            <span class="text-sm text-gray-600 ml-2">{{ result.unit }}</span>
                                        </div>
                                        {% if result.in_panic_range %}
                                        <span class="badge badge-error">
                                            <i class="fas fa-exclamation-triangle mr-1"></i> Critical
                                        </span>
                                        {% elif result.reference_range_indicator == -1 %}
                                        <span class="badge badge-warning">Low</span>
                                        {% elif result.reference_range_indicator == 1 %}
                                        <span class="badge badge-warning">High</span>
                                        {% else %}
                                        <span class="badge badge-success">Normal</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if result.test.min_reference_value and result.test.max_reference_value %}
                                    <div class="mt-2">
                                        <div class="text-sm text-gray-600 mb-1">Reference Range:</div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-primary h-2 rounded-full" style="width: 60%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>{{ result.test.min_reference_value }}</span>
                                            <span>{{ result.test.max_reference_value }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if result.comment %}
                                    <div class="mt-3 p-2 bg-gray-50 rounded text-sm">
                                        <i class="fas fa-comment mr-2 text-gray-400"></i>
                                        {{ result.comment }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            {% if test_request.test_results.count > 3 %}
                            <div class="text-center mt-4">
                                <a href="#" class="btn btn-outline">
                                    View All {{ test_request.test_results.count }} Results
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Column: Timeline & Actions -->
                <div class="space-y-6">
                    <!-- Status Timeline -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900">Order Timeline</h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="space-y-4">
                                <!-- Order Created -->
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                            <i class="fas fa-check text-green-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Order Created</p>
                                        <p class="text-sm text-gray-500">{{ test_request.created_at|date:"F j, Y g:i A" }}</p>
                                        <p class="text-xs text-gray-400">by Dr. {{ test_request.ordering_clinician.last_name }}</p>
                                    </div>
                                </div>
                                
                                <!-- Sample Collected -->
                                {% if test_request.collected_at %}
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                            <i class="fas fa-syringe text-green-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Sample Collected</p>
                                        <p class="text-sm text-gray-500">{{ test_request.collected_at|date:"F j, Y g:i A" }}</p>
                                        <p class="text-xs text-gray-400">Collected by lab technician</p>
                                    </div>
                                </div>
                                {% else %}
                                <div class="flex items-start opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                            <i class="fas fa-syringe text-gray-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Sample Collection</p>
                                        <p class="text-sm text-gray-500">Pending</p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Results Available -->
                                {% if test_request.completed_at %}
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                            <i class="fas fa-flask text-green-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Results Available</p>
                                        <p class="text-sm text-gray-500">{{ test_request.completed_at|date:"F j, Y g:i A" }}</p>
                                        <p class="text-xs text-gray-400">Reviewed by lab director</p>
                                    </div>
                                </div>
                                {% else %}
                                <div class="flex items-start opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                            <i class="fas fa-flask text-gray-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Results Analysis</p>
                                        <p class="text-sm text-gray-500">In progress</p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Report Delivered -->
                                {% if test_request.report_delivered_at %}
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                            <i class="fas fa-file-medical text-green-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Report Delivered</p>
                                        <p class="text-sm text-gray-500">{{ test_request.report_delivered_at|date:"F j, Y g:i A" }}</p>
                                        <p class="text-xs text-gray-400">Sent to clinician portal</p>
                                    </div>
                                </div>
                                {% else %}
                                <div class="flex items-start opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                            <i class="fas fa-file-medical text-gray-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-900">Report Delivery</p>
                                        <p class="text-sm text-gray-500">Pending</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Card -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900">Order Summary</h3>
                        </div>
                        <div class="card-body p-4 space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Order ID:</span>
                                <span class="font-mono font-semibold">{{ test_request.request_id }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Created:</span>
                                <span>{{ test_request.created_at|date:"M d, Y" }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="badge badge-{{ test_request.status|lower }}">
                                    {{ test_request.get_status_display }}
                                </span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Priority:</span>
                                <span class="badge badge-{{ test_request.priority|lower }}">
                                    {{ test_request.get_priority_display }}
                                </span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Number of Tests:</span>
                                <span class="font-semibold">{{ test_request.requested_tests.count }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Estimated Turnaround:</span>
                                <span>{{ test_request.estimated_turnaround|default:"24-48 hours" }}</span>
                            </div>
                            
                            <div class="pt-3 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-gray-900">Total Cost:</span>
                                    <span class="text-xl font-bold text-primary">
                                        ₦{{ test_request.calculate_total|default:"0.00"|intcomma }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Information -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900">Billing Information</h3>
                        </div>
                        <div class="card-body p-4 space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment Status:</span>
                                <span class="badge badge-{{ test_request.payment_status|lower|default:'warning' }}">
                                    {{ test_request.get_payment_status_display|default:"Pending" }}
                                </span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Insurance:</span>
                                <span>{{ test_request.insurance_provider|default:"Self-pay" }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600">Authorization:</span>
                                <span>{{ test_request.authorization_number|default:"Not required" }}</span>
                            </div>
                            
                            {% if test_request.invoice_number %}
                            <div class="flex justify-between">
                                <span class="text-gray-600">Invoice #:</span>
                                <span class="font-mono">{{ test_request.invoice_number }}</span>
                            </div>
                            {% endif %}
                            
                            <div class="pt-3 border-t border-gray-200">
                                <a href="#" class="btn btn-outline w-full">
                                    <i class="fas fa-receipt mr-2"></i> View Invoice
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card bg-white shadow-sm border border-gray-200">
                        <div class="card-header border-b border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900">Quick Actions</h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="space-y-2">
                                <button onclick="sendReminder()" class="btn btn-outline w-full justify-start">
                                    <i class="fas fa-bell mr-2"></i> Send Reminder
                                </button>
                                
                                <a href="#" class="btn btn-outline w-full justify-start">
                                    <i class="fas fa-share-alt mr-2"></i> Share Results
                                </a>
                                
                                <button onclick="requestAmendments()" class="btn btn-outline w-full justify-start">
                                    <i class="fas fa-edit mr-2"></i> Request Amendments
                                </button>
                                
                                <button onclick="addNote()" class="btn btn-outline w-full justify-start">
                                    <i class="fas fa-sticky-note mr-2"></i> Add Clinical Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log (Optional - could be collapsible) -->
            <div class="mt-6">
                <div class="card bg-white shadow-sm border border-gray-200">
                    <div class="card-header border-b border-gray-200 p-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-gray-900">Activity Log</h3>
                            <button onclick="toggleActivityLog()" class="btn btn-sm btn-ghost">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div id="activity-log" class="card-body p-4 hidden">
                        <div class="space-y-4">
                            {% for activity in test_request.activities.all|slice:":5" %}
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <div class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center">
                                        <i class="fas fa-{{ activity.icon|default:'info' }} text-gray-500 text-xs"></i>
                                    </div>
                                </div>
                                <div class="ml-3 flex-1">
                                    <p class="text-sm">{{ activity.description }}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        {{ activity.created_at|timesince }} ago • 
                                        by {{ activity.user.get_full_name|default:activity.user.username }}
                                    </p>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-history text-2xl mb-2"></i>
                                <p>No activity recorded yet</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal for Sample Collection -->
<div id="collectSampleModal" class="modal hidden">
    <div class="modal-box">
        <h3 class="text-lg font-bold mb-4">Mark Sample as Collected</h3>
        <form id="collectSampleForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Collection Time</label>
                    <input type="datetime-local" class="input input-bordered w-full" 
                           value="{% now 'Y-m-d\TH:i' %}" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Collected By</label>
                    <input type="text" class="input input-bordered w-full" 
                           placeholder="Enter collector's name" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Collection Notes (Optional)</label>
                    <textarea class="textarea textarea-bordered w-full" rows="3" 
                              placeholder="Any notes about the collection..."></textarea>
                </div>
            </div>
            
            <div class="modal-action">
                <button type="button" onclick="closeCollectModal()" class="btn btn-ghost">Cancel</button>
                <button type="submit" class="btn btn-primary">Confirm Collection</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-box {
    background: white;
    border-radius: 0.5rem;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}
.hidden {
    display: none;
}
.badge-pending { background-color: #fef3c7; color: #92400e; }
.badge-collected { background-color: #dbeafe; color: #1e40af; }
.badge-processing { background-color: #e0e7ff; color: #3730a3; }
.badge-completed { background-color: #d1fae5; color: #065f46; }
.badge-cancelled { background-color: #fee2e2; color: #991b1b; }
.badge-urgent { background-color: #fef3c7; color: #92400e; }
.badge-routine { background-color: #dbeafe; color: #1e40af; }
.badge-paid { background-color: #d1fae5; color: #065f46; }
.badge-pending-payment { background-color: #fef3c7; color: #92400e; }
</style>

<script>
// Modal Functions
function collectSample() {
    document.getElementById('collectSampleModal').classList.remove('hidden');
}

function closeCollectModal() {
    document.getElementById('collectSampleModal').classList.add('hidden');
}

function cancelRequest() {
    if (confirm('Are you sure you want to cancel this test request? This action cannot be undone.')) {
        fetch(`/clinician/test-request/{{ test_request.request_id }}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Test request cancelled successfully', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.error || 'Failed to cancel request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
        });
    }
}

function toggleActivityLog() {
    const log = document.getElementById('activity-log');
    const icon = event.currentTarget.querySelector('i');
    
    if (log.classList.contains('hidden')) {
        log.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        log.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

function sendReminder() {
    fetch(`/clinician/test-request/{{ test_request.request_id }}/send-reminder/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Reminder sent successfully', 'success');
        } else {
            showNotification(data.error || 'Failed to send reminder', 'error');
        }
    });
}

function requestAmendments() {
    const amendments = prompt('Please describe the amendments needed:');
    if (amendments) {
        // Send amendment request
        showNotification('Amendment request submitted', 'success');
    }
}

function addNote() {
    const note = prompt('Enter your clinical note:');
    if (note) {
        fetch(`/clinician/test-request/{{ test_request.request_id }}/add-note/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ note: note })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Note added successfully', 'success');
            } else {
                showNotification('Failed to add note', 'error');
            }
        });
    }
}

// Handle sample collection form
document.getElementById('collectSampleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
    submitBtn.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        showNotification('Sample collection recorded successfully', 'success');
        closeCollectModal();
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Reload page to update status
        setTimeout(() => location.reload(), 1500);
    }, 1000);
});

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' : 'bg-red-50 border border-red-200 text-red-700'}`;
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}