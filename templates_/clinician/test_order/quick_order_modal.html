<!-- clinician/order/quick_order_modal.html -->
<form method="POST" action="{% url 'clinician:quick_order' patient.patient_id %}" id="quick-order-form">
    {% csrf_token %}
    
    <div class="space-y-6">
        <!-- Clinical Information -->
        <div>
            <label for="{{ form.clinical_indication.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                Clinical Indication *
            </label>
            {{ form.clinical_indication }}
            {% if form.clinical_indication.errors %}
                <div class="mt-1 text-sm text-red-600">{{ form.clinical_indication.errors }}</div>
            {% endif %}
            <p class="mt-1 text-sm text-gray-500">Brief reason for ordering these tests</p>
        </div>
        
        <!-- Priority -->
        <div>
            <label for="{{ form.priority.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                Priority
            </label>
            {{ form.priority }}
            {% if form.priority.errors %}
                <div class="mt-1 text-sm text-red-600">{{ form.priority.errors }}</div>
            {% endif %}
        </div>
        
        <!-- Quick Test Selection -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Select Tests</label>
                    <p class="text-sm text-gray-500">Choose from commonly ordered tests</p>
                </div>
                <div class="flex gap-2">
                    <button type="button" id="select-all-tests" class="btn btn-xs btn-outline">
                        Select All
                    </button>
                    <button type="button" id="select-none-tests" class="btn btn-xs btn-outline">
                        Clear All
                    </button>
                </div>
            </div>
            
            <!-- Popular Test Groups -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Popular Panels</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="selectTestGroup('basic')" class="btn btn-xs btn-outline">
                        <i class="fas fa-vial mr-1"></i> Basic Metabolic
                    </button>
                    <button type="button" onclick="selectTestGroup('cbc')" class="btn btn-xs btn-outline">
                        <i class="fas fa-tint mr-1"></i> CBC
                    </button>
                    <button type="button" onclick="selectTestGroup('lipid')" class="btn btn-xs btn-outline">
                        <i class="fas fa-heart mr-1"></i> Lipid Profile
                    </button>
                    <button type="button" onclick="selectTestGroup('liver')" class="btn btn-xs btn-outline">
                        <i class="fas fa-liver mr-1"></i> Liver Function
                    </button>
                    <button type="button" onclick="selectTestGroup('thyroid')" class="btn btn-xs btn-outline">
                        <i class="fas fa-brain mr-1"></i> Thyroid Panel
                    </button>
                </div>
            </div>
            
            <!-- Tests List -->
            <div class="space-y-3 max-h-60 overflow-y-auto p-2 border border-gray-200 rounded-lg">
                {% for test in form.fields.tests.queryset %}
                <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded">
                    <div class="flex items-center gap-3">
                        <input 
                            type="checkbox" 
                            name="tests" 
                            value="{{ test.id }}" 
                            id="test_{{ test.id }}"
                            class="test-toggle checkbox checkbox-sm"
                        >
                        <div>
                            <label for="test_{{ test.id }}" class="font-medium text-gray-900 cursor-pointer">
                                {{ test.name }}
                            </label>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <span class="font-mono">{{ test.code }}</span>
                                <span>•</span>
                                <span>{{ test.assigned_department.name }}</span>
                                {% if test.available_for_online_booking %}
                                <span class="badge badge-xs badge-success">Patient</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-primary">₦{{ test.price|floatformat:2 }}</span>
                        <p class="text-xs text-gray-500">{{ test.get_estimated_turnaround }}h</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if form.tests.errors %}
                <div class="mt-2 text-sm text-red-600">{{ form.tests.errors }}</div>
            {% endif %}
            
            <div class="mt-3 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span id="selected-tests-count">0</span> tests selected
                </div>
                <div class="text-sm font-semibold">
                    Total: ₦<span id="quick-order-total">0.00</span>
                </div>
            </div>
        </div>
        
        <!-- Form Errors -->
        {% if form.non_field_errors %}
        <div class="p-3 bg-red-50 border border-red-200 rounded-md">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                <div class="text-sm text-red-700">
                    {{ form.non_field_errors }}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Action Buttons -->
        <div class="flex gap-3 pt-4 border-t border-gray-100">
            <button type="button" onclick="closeQuickOrderModal()" class="btn btn-ghost flex-1">
                Cancel
            </button>
            <button 
                type="submit" 
                id="submit-quick-order"
                class="btn btn-primary flex-1"
                disabled
            >
                <i class="fas fa-paper-plane mr-2"></i> Create Order
            </button>
        </div>
    </div>
</form>

<script>
// Calculate total price
function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.test-toggle:checked').forEach(checkbox => {
        const row = checkbox.closest('.flex.items-center.justify-between');
        const priceText = row.querySelector('.text-primary').textContent;
        const price = parseFloat(priceText.replace('₦', '').replace(',', ''));
        total += price;
    });
    
    document.getElementById('quick-order-total').textContent = total.toFixed(2);
    updateSelectedTests();
}

// Update test count
function updateSelectedTests() {
    const selectedCount = document.querySelectorAll('.test-toggle:checked').length;
    const countElement = document.getElementById('selected-tests-count');
    const submitBtn = document.getElementById('submit-quick-order');
    
    if (countElement) countElement.textContent = selectedCount;
    if (submitBtn) submitBtn.disabled = selectedCount === 0;
    
    calculateTotal();
}

// Select test groups
function selectTestGroup(group) {
    const groupTests = {
        'basic': ['GLU', 'CRE', 'BUN', 'NA', 'K'],
        'cbc': ['WBC', 'RBC', 'HGB', 'HCT', 'PLT'],
        'lipid': ['CHOL', 'HDL', 'LDL', 'TRIG'],
        'liver': ['ALT', 'AST', 'ALP', 'TBIL', 'ALB'],
        'thyroid': ['TSH', 'FT4', 'FT3']
    };
    
    const codes = groupTests[group] || [];
    document.querySelectorAll('.test-toggle').forEach(checkbox => {
        const row = checkbox.closest('.flex.items-center.justify-between');
        const codeElement = row.querySelector('.font-mono');
        if (codeElement && codes.includes(codeElement.textContent)) {
            checkbox.checked = true;
        }
    });
    
    calculateTotal();
}

// Attach event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.test-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', calculateTotal);
    });
    
    // Initial calculation
    calculateTotal();
});
</script>
