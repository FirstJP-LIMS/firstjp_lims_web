{% extends "laboratory/assets/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}New Test Request - FirstJP LIMS{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title fw-bold text-dark mb-1">New Test Request</h1>
            <p class="page-subtitle text-muted mb-0">Order laboratory tests and collect specimen information</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'labs:test_request_list' %}" class="btn btn-danger btn-lg shadow-sm">
                <i class="bi bi-arrow-left me-2"></i>Back to Requests
            </a>
        </div>
    </div>
</div>

<div class="dashboard-content">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-0" role="alert">
                <i class="bi bi-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %}-fill me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" novalidate id="testRequestForm">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Patient Information Card -->
                <div class="main-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-person-plus me-2"></i>
                            Patient Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Patient Selection Section -->
                        <div class="mb-4">
                            <h6 class="text-brand-blue border-bottom pb-2 mb-3">
                                <i class="bi bi-person-check me-2"></i>
                                Patient Selection
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    {{ form.existing_patient|as_crispy_field }}
                                </div>
                            </div>

                            <div class="text-center mb-3">
                                <span class="text-muted">- OR -</span>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>New Patient:</strong> Enter patient details below
                            </div>
                        </div>

                        <!-- New Patient Details -->
                        <div id="newPatientSection">
                            <h6 class="text-brand-blue border-bottom pb-2 mb-3">
                                <i class="bi bi-person-plus me-2"></i>
                                New Patient Details
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.first_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.last_name|as_crispy_field }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ form.date_of_birth|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ form.gender|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ form.contact_phone|as_crispy_field }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    {{ form.contact_email|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Selection Card -->
                <div class="main-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-clipboard-check me-2"></i>
                            Test Selection
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning" id="testSelectionAlert" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Please select at least one test to proceed.
                        </div>

                        <!-- Test Search and Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Search and Select Tests</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="testSearch" placeholder="Search tests by name or code...">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Test Selection Dropdown -->
                        <div class="mb-3">
                            <button class="btn btn-outline-red w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#testSelectionCollapse">
                                <i class="bi bi-plus-circle me-2"></i>
                                <span id="selectedTestsCount">Select Tests (0 selected)</span>
                                <i class="bi bi-chevron-down float-end"></i>
                            </button>
                            
                            <div class="collapse mt-2" id="testSelectionCollapse">
                                <div class="card card-body">
                                    <div class="tests-selection" style="max-height: 300px; overflow-y: auto;">
                                        {% for test in form.tests_to_order.field.queryset %}
                                        <div class="form-check test-item" style="padding-left: 2rem;" data-price="{{ test.price }}" data-department="{{ test.assigned_department.name }}">
                                            <input class="form-check-input test-checkbox" type="checkbox" 
                                                   name="tests_to_order" value="{{ test.id }}" 
                                                   id="test_{{ test.id }}">
                                            <label class="form-check-label w-100" for="test_{{ test.id }}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ test.code }}</strong> - {{ test.name }}
                                                        <br>
                                                        <small class="text-muted">
                                                            {{ test.assigned_department.name }} â€¢ 
                                                            {{ test.get_result_type_display }}
                                                        </small>
                                                    </div>
                                                    <div class="text-end">
                                                        <strong class="text-brand-blue">N{{ test.price }}</strong>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Tests Summary -->
                        <div class="card bg-light mt-3" id="selectedTestsSummary" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title">Selected Tests Summary</h6>
                                <div id="selectedTestsList"></div>
                                <div class="mt-2 pt-2 border-top">
                                    <strong>Total Price: N<span id="totalPrice">0.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sample Information Card -->
                <div class="main-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-droplet me-2"></i>
                            Specimen Collection
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ sample_form.specimen_type|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ sample_form.container_type|as_crispy_field }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ sample_form.specimen_description|as_crispy_field }}
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ sample_form.collection_method|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ sample_form.collection_site|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ sample_form.volume_collected_ml|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ sample_form.collected_by|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ sample_form.location|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Additional Information Card -->
                <div class="main-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-file-text me-2"></i>
                            Request Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.priority|as_crispy_field }}
                        </div>

                        <div class="mb-3">
                            {{ form.external_referral|as_crispy_field }}
                        </div>

                        <div class="mb-3">
                            {{ form.clinical_history|as_crispy_field }}
                        </div>

                        <div class="form-check mb-3">
                            {{ form.has_informed_consent }}
                            <label class="form-check-label" for="{{ form.has_informed_consent.id_for_label }}">
                                Patient has provided informed consent
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="main-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-info-circle me-2"></i>
                            Guidelines
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-brand-blue">Patient Selection</h6>
                        <ul class="list-unstyled small mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Choose existing patient for quick entry</li>
                            <li><i class="bi bi-check text-success me-2"></i>Add new patient if first visit</li>
                        </ul>

                        <h6 class="text-brand-blue">Specimen Types</h6>
                        <ul class="list-unstyled small mb-3">
                            <li><i class="bi bi-droplet text-primary me-2"></i>Blood</li>
                            <li><i class="bi bi-droplet text-primary me-2"></i>Urine</li>
                            <li><i class="bi bi-droplet text-primary me-2"></i>Tissue</li>
                            <li><i class="bi bi-droplet text-primary me-2"></i>Saliva</li>
                        </ul>

                        <h6 class="text-brand-blue">Collection Methods</h6>
                        <ul class="list-unstyled small">
                            <li><i class="bi bi-eyedropper text-warning me-2"></i>Venipuncture</li>
                            <li><i class="bi bi-eyedropper text-warning me-2"></i>Fingerstick</li>
                            <li><i class="bi bi-eyedropper text-warning me-2"></i>Swab</li>
                            <li><i class="bi bi-eyedropper text-warning me-2"></i>Catheter</li>
                        </ul>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="main-card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-lightning me-2"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'labs:test_list' %}" class="btn btn-outline-red text-start">
                                <i class="bi bi-clipboard-data me-2"></i>
                                Manage Test Catalog
                            </a>
                            <a href="{% url 'labs:test_request_list' %}" class="btn btn-outline-red text-start">
                                <i class="bi bi-list-check me-2"></i>
                                View All Requests
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="main-card mt-4">
            <div class="card-body text-center">
                <div class="d-flex gap-2 justify-content-center">
                    <a href="{% url 'labs:test_request_list' %}" class="btn btn-outline-red btn-lg">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-red btn-lg">
                        <i class="bi bi-send-check me-2"></i>Submit Test Request
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const existingPatientSelect = document.getElementById('id_existing_patient');
    const newPatientSection = document.getElementById('newPatientSection');
    const testSearch = document.getElementById('testSearch');
    const clearSearch = document.getElementById('clearSearch');
    const testCheckboxes = document.querySelectorAll('.test-checkbox');
    const selectedTestsSummary = document.getElementById('selectedTestsSummary');
    const selectedTestsList = document.getElementById('selectedTestsList');
    const totalPriceElement = document.getElementById('totalPrice');
    const testSelectionAlert = document.getElementById('testSelectionAlert');
    const selectedTestsCount = document.getElementById('selectedTestsCount');
    const testSelectionCollapse = document.getElementById('testSelectionCollapse');

    // Toggle new patient section based on existing patient selection
    function toggleNewPatientSection() {
        if (existingPatientSelect && existingPatientSelect.value) {
            newPatientSection.style.display = 'none';
        } else {
            newPatientSection.style.display = 'block';
        }
    }

    // Search functionality for tests
    function filterTests() {
        const searchTerm = testSearch.value.toLowerCase();
        const testItems = document.querySelectorAll('.test-item');
        
        testItems.forEach(item => {
            const testText = item.textContent.toLowerCase();
            if (testText.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Update selected tests summary
    function updateSelectedTestsSummary() {
        const selectedTests = Array.from(testCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => {
                const testItem = checkbox.closest('.test-item');
                const label = testItem.querySelector('label');
                const price = parseFloat(testItem.dataset.price || 0);
                const department = testItem.dataset.department;
                const testName = label.querySelector('strong').textContent + ' - ' + 
                               label.textContent.split(' - ')[1].split('\n')[0];
                
                return {
                    id: checkbox.value,
                    name: testName,
                    price: price,
                    department: department
                };
            });

        // Update selected count in dropdown button
        selectedTestsCount.textContent = `Select Tests (${selectedTests.length} selected)`;

        if (selectedTests.length > 0) {
            selectedTestsSummary.style.display = 'block';
            selectedTestsList.innerHTML = selectedTests.map(test => 
                `<div class="d-flex justify-content-between align-items-center small mb-2">
                    <div>
                        <div class="fw-semibold">${test.name.split(' - ')[0]}</div>
                        <div class="text-muted">${test.department}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-semibold">$${test.price.toFixed(2)}</div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-test" data-test-id="${test.id}">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>`
            ).join('');
            
            const total = selectedTests.reduce((sum, test) => sum + test.price, 0);
            totalPriceElement.textContent = total.toFixed(2);
            testSelectionAlert.style.display = 'none';
            
            // Auto-collapse the dropdown when tests are selected
            if (selectedTests.length >= 3) {
                const bsCollapse = new bootstrap.Collapse(testSelectionCollapse);
                bsCollapse.hide();
            }
        } else {
            selectedTestsSummary.style.display = 'none';
            testSelectionAlert.style.display = 'block';
        }

        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-test').forEach(button => {
            button.addEventListener('click', function() {
                const testId = this.dataset.testId;
                const checkbox = document.querySelector(`.test-checkbox[value="${testId}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    updateSelectedTestsSummary();
                }
            });
        });
    }

    // Form validation
    document.getElementById('testRequestForm').addEventListener('submit', function(e) {
        const selectedTests = Array.from(testCheckboxes).filter(checkbox => checkbox.checked);
        if (selectedTests.length === 0) {
            e.preventDefault();
            testSelectionAlert.style.display = 'block';
            testSelectionAlert.scrollIntoView({ behavior: 'smooth' });
            
            // Show the test selection dropdown if it's collapsed
            const bsCollapse = new bootstrap.Collapse(testSelectionCollapse);
            bsCollapse.show();
        }
    });

    // Event listeners
    if (existingPatientSelect) {
        existingPatientSelect.addEventListener('change', toggleNewPatientSection);
    }
    
    testSearch.addEventListener('input', filterTests);
    clearSearch.addEventListener('click', function() {
        testSearch.value = '';
        filterTests();
    });
    
    testCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedTestsSummary);
    });

    // Initialize
    toggleNewPatientSection();
    updateSelectedTestsSummary();
});
</script>

<style>
    /* Custom styling for form elements */
    .form-check-input:checked {
        background-color: var(--brand-red);
        border-color: var(--brand-red);
    }

    .tests-selection .form-check {
        padding: 0.75rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .tests-selection .form-check:hover {
        background-color: rgba(0, 31, 64, 0.02);
        border-color: var(--brand-red);
    }

    .tests-selection .form-check-label {
        font-weight: 500;
        cursor: pointer;
        width: 100%;
    }

    #newPatientSection {
        transition: all 0.3s ease;
    }

    .test-item hr {
        margin: 0.5rem 0;
    }

    .remove-test {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
    }

    #testSelectionCollapse .card {
        border: 1px solid var(--brand-red);
    }

    /* Scrollbar styling for test selection */
    .tests-selection::-webkit-scrollbar {
        width: 6px;
    }

    .tests-selection::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .tests-selection::-webkit-scrollbar-thumb {
        background: var(--brand-red);
        border-radius: 3px;
    }

    .tests-selection::-webkit-scrollbar-thumb:hover {
        background: #b3002d;
    }
</style>
{% endblock %}